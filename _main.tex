% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\usepackage{a4a}
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Fish stock assessment with R},
  pdfauthor={John Doe and friends},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Fish stock assessment with R}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{The a4a Initiative}
\author{John Doe and friends}
\date{2025-01-15}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{before-starting}{%
\chapter{Before starting}\label{before-starting}}

\hypertarget{license-documentation-and-development-status}{%
\section{License, documentation and development status}\label{license-documentation-and-development-status}}

The software is released under the \href{https://joinup.ec.europa.eu/community/eupl/home}{EUPL 1.1}.

For more information on the a4a methodologies refer to \href{http://icesjms.oxfordjournals.org/content/early/2014/04/03/icesjms.fsu050.abstract}{Jardim, et.al, 2014}, \href{http://icesjms.oxfordjournals.org/content/early/2014/03/31/icesjms.fsu043.abstract}{Millar, et.al, 2014} and \href{http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0154922}{Scott, et.al, 2016}.

Documentation can be found at \url{http://flr-project.org/FLa4a}. You are welcome to:

\begin{itemize}
\tightlist
\item
  Submit suggestions and bug-reports at: \url{https://github.com/flr/FLa4a/issues}
\item
  Send a pull request on: \url{https://github.com/flr/FLa4a/}
\item
  Compose a friendly e-mail to the maintainer, see \texttt{packageDescription(\textquotesingle{}FLa4a\textquotesingle{})}
\end{itemize}

\hypertarget{installing-and-loading-libraries}{%
\section{Installing and loading libraries}\label{installing-and-loading-libraries}}

To run the \texttt{FLa4a} methods the reader will need to install the package and its dependencies and load them. Some datasets are distributed with the package and as such need to be loaded too.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# from CRAN}
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"copula"}\NormalTok{,}\StringTok{"triangle"}\NormalTok{, }\StringTok{"coda"}\NormalTok{, }\StringTok{"grid"}\NormalTok{, }\StringTok{"gridExtra"}\NormalTok{, }\StringTok{"latticeExtra"}\NormalTok{))}
\CommentTok{\# from FLR}
\FunctionTok{install.packages}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"FLCore"}\NormalTok{, }\StringTok{"FLa4a"}\NormalTok{), }\AttributeTok{repos=}\StringTok{"http://flr{-}project.org/R"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# libraries}
\FunctionTok{library}\NormalTok{(devtools)}
\FunctionTok{library}\NormalTok{(FLa4a)}
\FunctionTok{library}\NormalTok{(XML)}
\FunctionTok{library}\NormalTok{(reshape2)}
\FunctionTok{library}\NormalTok{(ggplotFL)}
\CommentTok{\# datasets}
\FunctionTok{data}\NormalTok{(ple4)}
\FunctionTok{data}\NormalTok{(ple4.indices)}
\FunctionTok{data}\NormalTok{(ple4.index)}
\FunctionTok{data}\NormalTok{(rfLen)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{packageVersion}\NormalTok{(}\StringTok{"FLCore"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] '2.6.20.9321'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{packageVersion}\NormalTok{(}\StringTok{"FLa4a"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] '1.9.0.9002'
\end{verbatim}

\hypertarget{how-to-read-this-document}{%
\section{How to read this document}\label{how-to-read-this-document}}

The target audience for this document are readers with some experience in R and some background on stock assessment.

The document explains the approach being developed by \texttt{a4a} for fish stock assessment and scientific advice. It presents a mixture of text and code, where the first explains the concepts behind the methods, while the last shows how these can be run with the software provided. Moreover, having the code allows the reader to copy/paste and replicate the analysis presented here.

The sections and subsections are as independent as possible, so it can be used as a reference document for the \texttt{FLa4a}.

\hypertarget{how-to-get-help}{%
\section{How to get help}\label{how-to-get-help}}

\texttt{a4a} is build around S4 classes. S4 classes and methods in R offer an object-oriented programming framework but in order to access the documentation requires specific terminology. In this section we will demonstrate how to get information on the main building blocks of \texttt{a4a}.

For example, \texttt{FLStock} is one of our main components in order to run our stock assessment model. We can check the structure of an \texttt{FLStock} object as follows:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showClass}\NormalTok{(}\StringTok{"FLStock"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Class "FLStock" [package "FLCore"]
## 
## Slots:
##                                                                        
## Name:         catch      catch.n     catch.wt     discards   discards.n
## Class:      FLQuant      FLQuant      FLQuant      FLQuant      FLQuant
##                                                                        
## Name:   discards.wt     landings   landings.n  landings.wt        stock
## Class:      FLQuant      FLQuant      FLQuant      FLQuant      FLQuant
##                                                                        
## Name:       stock.n     stock.wt            m          mat      harvest
## Class:      FLQuant      FLQuant      FLQuant      FLQuant      FLQuant
##                                                                        
## Name:  harvest.spwn       m.spwn         name         desc        range
## Class:      FLQuant      FLQuant    character    character      numeric
## 
## Extends: 
## Class "FLS", directly
## Class "FLComp", by class "FLS", distance 2
## 
## Known Subclasses: 
## Class "FLStockR", directly, with explicit coerce
\end{verbatim}

The object oriented structure of \texttt{a4a} gives the opportunity to change the behavior of a function according to the object that is applied to. For example we can check the available methods of the function \texttt{plot}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showMethods}\NormalTok{(}\StringTok{"plot"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Function: plot (package base)
## x="a4aFitCatchDiagn", y="missing"
## x="a4aFit", y="FLIndices"
## x="a4aFit", y="FLStock"
## x="a4aFitMCMCs", y="missing"
## x="a4aFitResiduals", y="missing"
## x="a4aFits", y="missing"
## x="ANY", y="ANY"
## x="color", y="ANY"
## x="Copula", y="ANY"
## x="FLBiol", y="FLFishery"
## x="FLBiol", y="missing"
## x="FLBiols", y="missing"
## x="FLBRP", y="missing"
## x="FLCatch", y="missing"
## x="FLCohort", y="missing"
## x="FLFisheries", y="ANY"
## x="FLFishery", y="ANY"
## x="FLIndexBiomass", y="missing"
## x="FLIndex", y="missing"
## x="FLIndices", y="missing"
## x="FLPar", y="missing"
## x="FLQuant", y="FLQuant"
## x="FLQuant", y="fwdControl"
## x="FLQuant", y="missing"
## x="FLQuantPoint", y="FLQuant"
## x="FLQuantPoint", y="FLQuants"
## x="FLQuantPoint", y="missing"
## x="FLQuants", y="FLPar"
## x="FLQuants", y="FLPars"
## x="FLQuants", y="fwdControl"
## x="FLQuants", y="missing"
## x="FLSR", y="missing"
## x="FLSRs", y="ANY"
## x="FLStock", y="FLBRP"
## x="FLStock", y="FLPar"
## x="FLStock", y="FLStock"
## x="FLStock", y="FLStocks"
## x="FLStock", y="fwdControl"
## x="FLStock", y="missing"
## x="FLStocks", y="FLBRP"
## x="FLStocks", y="FLBRPs"
## x="FLStocks", y="FLPar"
## x="FLStocks", y="fwdControl"
## x="FLStocks", y="missing"
## x="mvdc", y="ANY"
## x="profile.mle", y="missing"
\end{verbatim}

by calling \texttt{showMethods} R prints all the possible uses of the \textbf{plot} function. We want to see what it does when it is called on an \texttt{FLStock} object with no other object. We observe that \texttt{plot} takes two arguments, \texttt{x} and \texttt{y}. So, in the signature of the \texttt{getMethod} function we are going to use, we need to define both \texttt{x} and \texttt{y}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{getMethod}\NormalTok{(}\StringTok{\textquotesingle{}plot\textquotesingle{}}\NormalTok{, }\AttributeTok{signature =} \FunctionTok{list}\NormalTok{(}\StringTok{"FLStock"}\NormalTok{,}\StringTok{"missing"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Method Definition:
## 
## function (x, y, ...) 
## {
##     .local <- function (x, metrics = list(Rec = rec, SSB = ssb, 
##         Catch = catch, F = fbar), na.rm = TRUE, ...) 
##     {
##         metrics <- metrics(x, metrics = metrics)
##         if ("F" %in% names(metrics)) 
##             units(metrics$F) <- paste0(range(x, c("minfbar", 
##                 "maxfbar")), collapse = "-")
##         if ("SSB" %in% names(metrics)) {
##             if (all(dimnames(metrics$SSB)$unit %in% c("F", "M"))) {
##                 metrics$SSB <- metrics$SSB[, , "F"] + metrics$SSB[, 
##                   , "M"]
##                 if ("Rec" %in% names(metrics)) 
##                   metrics$Rec <- unitSums(metrics$Rec)
##             }
##         }
##         if ("Rec" %in% names(metrics)) {
##             if (dim(metrics$Rec)[4] > 1) {
##                 metrics$Rec[metrics$Rec == 0] <- NA
##             }
##         }
##         p <- plot(metrics, na.rm = na.rm, ...) + ylim(c(0, NA))
##         if ("SSB" %in% names(metrics)) 
##             if (all(dimnames(metrics$SSB)$unit %in% c("F", "M"))) {
##                 return(p + theme(legend.position = "bottom", 
##                   legend.key = element_blank()) + labs(color = "Sex") + 
##                   scale_color_manual(name = "", labels = c("Both", 
##                     "F", "M"), values = flpalette_colours(3)))
##             }
##         return(p)
##     }
##     .local(x, ...)
## }
## <bytecode: 0x5cada6423110>
## <environment: namespace:ggplotFL>
## 
## Signatures:
##         x         y        
## target  "FLStock" "missing"
## defined "FLStock" "missing"
\end{verbatim}

\hypertarget{notation}{%
\section{Notation}\label{notation}}

Along this chapter the notation presented in Table \ref{tab:mathsnotation} will be used. Mathematical descriptions will be kept as simple as possible for readability.

\begin{longtable}[]{@{}lrl@{}}
\caption{\label{tab:mathsnotation} Mathematical notation}\tabularnewline
\toprule\noalign{}
Type & Symbol & Description \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
Type & Symbol & Description \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
variables & & \\
& \(C\) & catches \\
& \(F\) & fishing mortality \\
& \(M\) & natural mortality \\
& \(R\) & recruitment \\
& \(Q\) & vessel or fleet catchability \\
& \(w\) & weights \\
& \(l\) & likelihood \\
& \(I\) & abundance index \\
& \(S\) & spawning stock biomass \\
& \(CV\) & coefficient of variation \\
& \(D\) & residuals or deviances \\
& \(N\) & normal distribution \\
& \(\beta\) & parameter \\
& \(a\) & stock-recruitment parameter \\
& \(b\) & stock-recruitment parameter \\
& \(\sigma^2\) & variance of catch \\
& \(\tau^2\) & variance of index \\
& \(\phi^2\) & variance of predicted recruitment \\
& \(\upsilon^2\) & variance of residuals \\
subscripts & & \\
& \(a\) & age \\
& \(y\) & year \\
& \(C\) & catch \\
& \(I\) & abundance index \\
& \(N\) & normal distribution \\
& \(s\) & survey \\
& \(SR\) & stock recruitment relationship \\
superscripts and accents & & \\
& \(\hat{}\) & observation \\
& \(\tilde{}\) & prediction \\
& \(c\) & catches \\
& \(s\) & abundance index \\
\end{longtable}

\hypertarget{introduction}{%
\chapter{Introduction}\label{introduction}}

\hypertarget{the-assessment-for-all-initiative-a4a}{%
\section{The ``Assessment for All'' Initiative (a4a)}\label{the-assessment-for-all-initiative-a4a}}

The European Commission Joint Research Centre's (JRC) ``Assessment for All'' Initiative (a4a) was launched to simplify and standardize the complex methodologies often employed in fisheries science, a4a focuses on creating flexible, modular frameworks that can accommodate varying data availability, regional needs, and stakeholder objectives.

The JRC started its `Assessment for All' Initiative (a4a), with the aim to develop, test, and distribute methods to assess a large numbers of stocks in an operational time frame, and to build the necessary capacity/expertise on stock assessment and advice provision.

According to Jardim et.al (2014), the long-term strategy of a4a is to increase the number of stock assessments by reducing the workload required to run each analysis and by bringing more scientists/analysts into fisheries management advice. The first is achieved by developing a working framework with the methods required to run all the analyses a stock assessment needs. Such approach should make the model exploration and selection processes easier, as well as decreasing the burden of moving between software platforms. The second can be achieved by making the analysis more intuitive, thereby attracting more experts to join stock assessment teams.

One major step to achieve the a4a goals was the development of a stock assessment model that could be applied rapidly to a large number of stocks and for a wide range of applications: traditional stock assessment, conditioning of operating models, forecasting, or informing harvest control rules in MSE algorithms.

The modular nature of a4a allows for the integration of data from diverse sources, including biological, environmental, and socioeconomic datasets, ensuring comprehensive assessments. This inclusivity enhances the ability to predict stock dynamics and evaluate the impacts of fishing and environmental changes.

While a4a simplifies traditional assessment approaches, it faces challenges such as ensuring the quality and consistency of input data, especially in regions with limited monitoring infrastructure. To address this, the initiative incorporates uncertainty into its models, leveraging MCMC frameworks and other statistical tools to account for variability in data quality and ecosystem processes.

{[}EJ TO CHECK{]} The a4a framework has been applied in various European fisheries to improve stock assessment practices. For example, its use in small pelagic fisheries demonstrated the utility of simple linear models in capturing key population dynamics without the need for data-intensive methods \href{https://typeset.io/papers/food-for-thought-what-if-stock-assessment-is-as-simple-as-a-22co3slqjr}{(Jardim et al., 2014)}.

Some of the key elements of stock assessment are the quantity, quality and aggregation level of the data available. As in many other models the data will condition the type of models that can be used, which for \texttt{a4a} is loosely defined as a ``moderate data'' level, consisting of:

\begin{itemize}
\tightlist
\item
  nominal effort,
\item
  volume of catches in weight (which should include landings and discards),
\item
  length structure of the catches (based on selectivity studies or direct observations),
\item
  information-based maturity ogive (parameters are not educated guesses but based on in-
  formation),
\item
  information-based growth model (parameters are not educated guesses but based on infor-
  mation),
\item
  length-weight relationship,
\item
  index of abundance (the type of index is left open, it could be a scientifc survey or a
  commercial CPUE series),
\item
  length structure of the index of abundance (based on selectivity studies or direct observations)
\end{itemize}

\hypertarget{multi-stage-modelling-approach}{%
\section{Multi-stage modelling approach}\label{multi-stage-modelling-approach}}

In ecological and population dynamics modeling, one can choose between integrated models, which estimate correlated parameters together, and two-stage models, which separate estimation into distinct steps. These approaches differ in complexity, data requirements, interpretability, and their ability to address uncertainties. The selection depends largely on the study objectives, available data, and the system's ecological complexity.

Integrated models estimate all parameters within a unified framework, accounting for correlations and interactions between variables such as growth, natural mortality, recruitment, and environmental factors. This approach can provide a realistic depiction of biological systems by preserving dependencies and feedback loops, which are crucial for understanding processes like density dependence or predator-prey interactions \href{https://typeset.io/papers/natural-mortality-theory-estimation-and-application-in-29k3o1na}{(Hamel et al., 2023)}. Integrated models are particularly advantageous for ecosystem-based management, where interactions among multiple factors need to be captured. However, the complexity of these models makes them computationally intensive and sensitive to data quality.

On the other hand, two-stage models estimate parameters such as growth or natural mortality independently before incorporating them into broader models. This step-wise approach simplifies estimation, reducing computational demands and mitigating issues like parameter confounding. For example, fisheries often use empirical relationships to estimate natural mortality (M) based on growth parameters or life history traits before including M in stock assessment models \href{https://typeset.io/papers/assessing-the-accuracy-of-published-natural-mortality-2ejiyrxpk7}{(Maceina \& Sammons, 2016)}. However, this decoupling may overlook dynamic interactions, such as how growth influences mortality, potentially leading to biased or incomplete inferences about ecosystem dynamics \href{https://typeset.io/papers/natural-mortality-augments-population-fluctuations-of-forage-11krhr78za}{(Jacobsen \& Essington, 2018)}.

Dealing with uncertainty is a critical aspect of both approaches. Integrated models explicitly quantify and propagate uncertainties across correlated parameters. These models incorporate multiple sources of variability, including observation, process, and structural uncertainties, enhancing the robustness of predictions \href{https://typeset.io/papers/incorporating-uncertainty-into-a-length-based-estimator-of-4bes19tqua}{(LÃ³pez Quintero et al., 2017)}. Conversely, two-stage models often treat parameter estimates as fixed values, which can underestimate uncertainty propagation in subsequent analyses. However, by treating first-stage estimates as distributions rather than point estimates, two-stage models can partially address this limitation.

For fisheries science, the choice between these models often depends on management goals and data availability. Integrated models are better suited for forecasting fish abundance or evaluating complex ecological interactions, such as predator-prey dynamics or responses to environmental variability \href{https://typeset.io/papers/limited-temporal-variability-in-natural-mortality-for-t8tbfa2f}{(Robertson et al., 2022)}. Meanwhile, two-stage models are practical for stock assessments, where simplicity and interpretability are prioritized.

Two-stage models are advantageous for practical applications, such as fisheries stock assessments, where simplicity and robustness take precedence over ecological nuance. Empirical estimates of \(M\), derived from life-history traits, provide reliable inputs for subsequent models, avoiding the parameter confounding that often occurs in integrated frameworks.

Despite the intuitive advantages of integrated models, it is not a panacea for poor quality data or model structure uncertainty in stock assessments. There are several disadvantages, mostly related to model misspecification, the complexity of the resulting models, and the associated, often considerable, computational requirements (e.g.~the use of remotely sensed environmental information). Consequently, in some situations, the traditional two-stage approach remains a better approach (Mounder and Punt, 2013).

\hypertarget{stock-assessment-process}{%
\section{Stock assessment process}\label{stock-assessment-process}}

The process and a4a's approach to it (multi-stage)

\begin{longtable}[]{@{}lrl@{}}
\caption{\label{tab:sastages} Stock assessment process stages}\tabularnewline
\toprule\noalign{}
Process & stage & type \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
Process & stage & type \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Data preparation & 1 & data processing \\
Growth model & 1 & estimation \\
Natural mortality model & 2 & estimation \\
Stock assessment model & 3 & fit \\
Stock-recruitment model & 4 & fit \\
Reference points & 5 & estimation \\
Stock status & 6 & estimation \\
Projections & 7 & estimation \\
Scientific advice & 8 & estimation \\
\end{longtable}

\hypertarget{stock-assessment-as-a-linear-model}{%
\section{Stock assessment as a linear model}\label{stock-assessment-as-a-linear-model}}

The submodels formulation uses linear models, which opens the possibility of using the linear modelling tools available in \texttt{R}. For example, \href{http://cran.r-project.org/web/packages/mgcv/index.html}{\texttt{mgcv}} gam formulas or factorial design formulas using \texttt{lm()}.

The `language' of linear models has been developing within the statistical community for many years, and constitutes an elegant way of defining models without going through the complexity of mathematical representations. This approach makes it also easier to communicate among scientists:

\begin{itemize}
\tightlist
\item
  \href{http://rspa.royalsocietypublishing.org/content/283/1393/147.short}{J. A. Nelder, 1965}, notation for randomized block design
\item
  \href{http://www.jstor.org/stable/info/2346786}{Wilkinson and Rodgers, 1973}, symbolic description for factorial designs
\item
  \href{http://books.google.com/books?isbn=0412343908}{Hastie and Tibshirani, 1990}, introduced notation for smoothers
\item
  \href{http://books.google.com/books?isbn=041283040X}{Chambers and Hastie, 1991}, further developed for use in S
\end{itemize}

\hypertarget{data-used-in-the-book}{%
\section{Data used in the book}\label{data-used-in-the-book}}

\hypertarget{stock-xx}{%
\subsection{stock xx}\label{stock-xx}}

Description and summarized depiction of data

\hypertarget{stock-xx-1}{%
\subsection{stock xx}\label{stock-xx-1}}

Description and summarized depiction of data

\hypertarget{stock-xx-2}{%
\subsection{stock xx}\label{stock-xx-2}}

Description and summarized depiction of data

\hypertarget{introduction-to-splines}{%
\chapter{Introduction to Splines}\label{introduction-to-splines}}

Splines are a powerful tool for modeling complex, non-linear relationships between variables in a flexible and interpretable way. They break a function into smooth, continuous polynomial segments, each called a \emph{piece} or \emph{basis function}, joined at specific points called \emph{knots}. This piecewise approach allows us to capture the non-linearity in the data without overfitting.

The core concept of ``basis functions'' is that they transform the input variable (or vector) \(X\) into a set of new variables, which are then used as inputs in the model. This allows the model to remain linear in these transformed variables, even though it can capture complex, non-linear relationships in the original variable.

\hypertarget{understanding-spline-basics}{%
\section{Understanding Spline Basics}\label{understanding-spline-basics}}

The spline function is built by combining polynomial pieces, ensuring smoothness at the junctions, which are called knots. In regression, splines allow us to fit complex shapes by introducing non-linear trends while maintaining control over the smoothness.

A simplified version of how splines work would be as follows:

Let \(S\) our spline function, that is defined in an interval \([a,b]\). We seek to construct \(S\) by combining \(k-1\) polynomials \(P\), where \(k\) is the number of knots. Let also \(t_{i}, i = 0, ..., k-1\) the positions of the knots in the interval \([a,b]\).

\(S\) is going to be defined as:

\[
S(t) = P_{0}(t), \quad t_{0} \leq t < t_{1} \\
\vdots \\
S(t) = P_{k-1}(t), \quad t_{k-1} \leq t < t_{k}
\]

The above definition is a simplified version of how splines work and can help as an intuitive approach. In reality splines need to satisfy some extra conditions like continuity on the points of junction, and of the first and second derivative. Depending on the basis functions the conditions may differ. The next part will demonstrate graphically how to approximate an unknown function through splines.

\hypertarget{generate-some-artificial-data}{%
\section{Generate some artificial data}\label{generate-some-artificial-data}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{sin}\NormalTok{(x) }\SpecialCharTok{+} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(x, y)}
\FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-9-1.png}
\caption{\label{fig:unnamed-chunk-9}Data with Non-linear Trend}
\end{figure}

We will use the package \texttt{mgcv} which is the one that is being used in \texttt{a4a}.

\hypertarget{cubic-regression-splines}{%
\section{Cubic Regression Splines}\label{cubic-regression-splines}}

We fit a simple smoother on x with \(k = 5\):

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit a natural cubic spline with ns()}
\NormalTok{cr\_model }\OtherTok{\textless{}{-}} \FunctionTok{gam}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{bs =} \StringTok{"cr"}\NormalTok{, }\AttributeTok{k =} \DecValTok{5}\NormalTok{), }\AttributeTok{data =}\NormalTok{ data)}

\CommentTok{\# Predict and plot}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{cr\_fit }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(cr\_model)}

\FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ cr\_fit), }\AttributeTok{color =} \StringTok{"darkgreen"}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-10-1.png}
\caption{\label{fig:unnamed-chunk-10}Cubic regression spline fit}
\end{figure}

The natural cubic spline fit above is constrained at the boundaries, by putting two of the five knots there, resulting in a linear behavior at the ends of the data range. This approach is helpful for data that has an approximately linear trend at the boundaries but exhibits non-linearity in the center.

The knots in the cubic regression splines are placed by quantile through the variable space, so in the case where the data are evenly spread across the variable space the knots will be placed evenly.

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-11-1.png}
\caption{\label{fig:unnamed-chunk-11}Cubic regression spline fit with knot positioning}
\end{figure}

The \texttt{gam} routine creates \(k-1\) polynomials plus an intercept based on the knots:

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-12-1.png}
\caption{\label{fig:unnamed-chunk-12}basis functions for cubic regression splines}
\end{figure}

The polynomials transform the initial variable \(x\) and create a \emph{model} matrix \(X\) with \(k\) columns and \(n\) rows, where \(n\) is the number of data points. This new transformation is being then used to fit the model and estimate the \(\beta_{0}, ... ,\beta_{k-1}\) coefficients. The fitted model results from \(X\beta\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df\_xm\_basis\_b, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{group =}\NormalTok{ variable, }\AttributeTok{colour =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ fitted), }\AttributeTok{color =} \StringTok{"darkgreen"}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ obs), }\AttributeTok{color =} \StringTok{"darkgrey"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{)}\SpecialCharTok{+} \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position=}\StringTok{"bottom"}\NormalTok{)}\SpecialCharTok{+}\FunctionTok{ylab}\NormalTok{(}\StringTok{"y"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-13-1.png}

\hypertarget{thin-plate-spline}{%
\section{Thin plate spline}\label{thin-plate-spline}}

Thin plate splines are particularly useful for smoothing in multiple dimensions. However, they also work well with univariate data, as they offer flexibility and control over smoothness they are the default choice of the \texttt{mgcv} package.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit a thin plate spline with gam()}
\NormalTok{tps\_model }\OtherTok{\textless{}{-}} \FunctionTok{gam}\NormalTok{(y }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(x, }\AttributeTok{k =} \DecValTok{5}\NormalTok{, }\AttributeTok{bs =} \StringTok{"tp"}\NormalTok{), }\AttributeTok{data =}\NormalTok{ data)}

\CommentTok{\# Predict and plot}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{tps\_fit }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(tps\_model)}

\FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ tps\_fit), }\AttributeTok{color =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-14-1.png}
\caption{\label{fig:unnamed-chunk-14}Thin plate splines fit}
\end{figure}

This spline automatically adjusts its flexibility across the data, with a smoothing penalty that controls the degree of bending. Thin plate splines are ideal when you need a smooth fit without predefined knots. The knots in thin plate splines are not positioned across the variable space, instead, by default, when no knot number is specified, there are as many knots as data points which essentially define the number of basis splines.

In the case where \(k\) is specified the thin plate splines use the first \(k\) ``principal components'' in a similar way as the PCA algorithm works.

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-15-1.png}
\caption{\label{fig:unnamed-chunk-15}basis functions for thin plate splines}
\end{figure}

As in the example before, the fitted model results from \(X\beta\)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df\_xm\_basis\_b, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{group =}\NormalTok{ variable, }\AttributeTok{colour =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ fitted), }\AttributeTok{color =} \StringTok{"darkgreen"}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ obs), }\AttributeTok{color =} \StringTok{"darkgrey"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position=}\StringTok{"bottom"}\NormalTok{)}\SpecialCharTok{+}\FunctionTok{ylab}\NormalTok{(}\StringTok{"y"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.5}\NormalTok{,}\FloatTok{1.5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 156 rows containing missing values or values outside the scale
## range (`geom_line()`).
\end{verbatim}

\begin{verbatim}
## Warning: Removed 5 rows containing missing values or values outside the scale
## range (`geom_point()`).
\end{verbatim}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-16-1.png}

\hypertarget{comparison}{%
\section{Comparison}\label{comparison}}

Plotting together thin plate spline and cubic spline fits with the same number of knots.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(x, y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ tps\_fit), }\AttributeTok{color =} \StringTok{"blue"}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ cr\_fit), }\AttributeTok{color =} \StringTok{"darkgreen"}\NormalTok{, }\AttributeTok{linewidth =} \DecValTok{1}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color =} \StringTok{"Spline Type"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"blue"}\NormalTok{, }\StringTok{"darkgreen"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-17-1.png}
\caption{\label{fig:unnamed-chunk-17}Thin plate splines and cubic regression splines fit}
\end{figure}

\hypertarget{the-mgcv-package-inside-a4a}{%
\section{\texorpdfstring{The \texttt{mgcv} package inside \texttt{a4a}}{The mgcv package inside a4a}}\label{the-mgcv-package-inside-a4a}}

The \texttt{mgcv} package provides various user input options to define the smoother functions used to construct the submodels.

Under the \texttt{a4a} framework, the \texttt{mgcv} package is used to construct the model matrices of the submodels, which are then passed to the \texttt{ADMB} where the model fitting takes place.

The default option for the basis functions of the splines is \texttt{bs\ =\ tp} (thin plate splines) and is considered the optimal option. The user can define other smoothing basis functions using the \texttt{bs} argument. The user can refer to the \texttt{smooth.terms} of the \texttt{mgcv} package for a full description. There are many equivalent basis functions for the splines, and some of them have little or no effect in the context of \texttt{a4a}, since they differ only in the penalty term, which is not used in \texttt{a4a}.

Examples for different smoothing terms:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod00 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{bs =} \StringTok{\textquotesingle{}tp\textquotesingle{}}\NormalTok{, }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\CommentTok{\# thin plate splines}
\NormalTok{fmod01 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{bs =} \StringTok{\textquotesingle{}cr\textquotesingle{}}\NormalTok{, }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\CommentTok{\# regression cubic splines}
\NormalTok{fmod02 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{bs =} \StringTok{\textquotesingle{}bs\textquotesingle{}}\NormalTok{, }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\CommentTok{\# b{-}splines}
\NormalTok{fmod03 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{bs =} \StringTok{\textquotesingle{}ps\textquotesingle{}}\NormalTok{, }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\CommentTok{\# p{-}splines}
\NormalTok{fmod04 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{bs =} \StringTok{\textquotesingle{}ad\textquotesingle{}}\NormalTok{, }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\CommentTok{\# Adaptive smoothers}

\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod00)}
\NormalTok{fit01 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod01)}
\NormalTok{fit02 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod02)}
\NormalTok{fit03 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod03)}
\NormalTok{fit04 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod04)}
\end{Highlighting}
\end{Shaded}

In this example we are using the thin plate regression splines, cubic splines, b-splines, p-splines and adaptive smoothers

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{FLStocks}\NormalTok{(}\AttributeTok{ThinPlate =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit00,}
              \AttributeTok{CubicRegressionSplines =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit01,}
              \AttributeTok{B\_splines =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit02,}
              \AttributeTok{P\_splines =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit03,}
              \AttributeTok{Adaptive\_smoothers =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit04}
\NormalTok{              ))}\SpecialCharTok{+}\FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{\textquotesingle{}bottom\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-20-1.png}

Functionality of \texttt{mgcv} package provides also the option to work with interactions. Although \texttt{s(age,\ year)} can be defined, it uses a common bivariate spline for the two variables which are very different in scale. It is preferable if interactions are assumed to use \texttt{te(age,\ year)}. Again is up to the user to define the basis functions for the smoothers.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod03 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{10}\NormalTok{))}
\NormalTok{fmod04 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{10}\NormalTok{), }\AttributeTok{bs =} \StringTok{\textquotesingle{}cr\textquotesingle{}}\NormalTok{)}
\NormalTok{fmod05 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{bs =} \StringTok{\textquotesingle{}bs\textquotesingle{}}\NormalTok{)}

\NormalTok{fit03 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod03)}
\NormalTok{fit04 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod04)}
\NormalTok{fit05 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod05)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{FLStocks}\NormalTok{(}\AttributeTok{TP\_tensor =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit03,}
              \AttributeTok{CB\_tensor =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit04,}
              \AttributeTok{BS\_tensor =}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit05))}\SpecialCharTok{+}\FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{\textquotesingle{}bottom\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-22-1.png}

\hypertarget{on-the-number-of-knots-k}{%
\section{\texorpdfstring{On the number of knots \(k\)}{On the number of knots k}}\label{on-the-number-of-knots-k}}

\(k\) is the dimension of the basis used to represent the smooth term \(s\). The default depends on the number of variables that the smooth is a function of. In practice k-1 (or k) sets the upper limit on the degrees of freedom associated with an s smooth (1 degree of freedom is usually lost to the intercept of the smooth). For the smooths the upper limit of the degrees of freedom is given by the product of the k values provided for each marginal smooth less one, for the constraint. The choice of the k is not critical and in general it must be large enough to allow to have enough degrees of freedom capturing the underlying process and small enough to prevent overfitting. A strong pattern in the residuals can be a sign of low \(k\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod00 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{5}\NormalTok{) }
\NormalTok{fmod01 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\CommentTok{\# cubic splines}
\NormalTok{fmod02 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{20}\NormalTok{) }\CommentTok{\# b{-}splines}

\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod00)}
\NormalTok{fit01 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod01)}
\NormalTok{fit02 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel =}\NormalTok{ fmod02)}

\FunctionTok{plot}\NormalTok{(}\FunctionTok{FLStocks}\NormalTok{(}\StringTok{\textquotesingle{}k=5\textquotesingle{}} \OtherTok{=}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit00,}
              \StringTok{\textquotesingle{}k=10\textquotesingle{}} \OtherTok{=}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit01,}
              \StringTok{\textquotesingle{}k=20\textquotesingle{}} \OtherTok{=}\NormalTok{ stk }\SpecialCharTok{+}\NormalTok{ fit02))}\SpecialCharTok{+}\FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{\textquotesingle{}bottom\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-23-1.png}

We can check the result of choosing different \(k\) values on BIC and GCV:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmodsk }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{10}\SpecialCharTok{:}\DecValTok{20}\NormalTok{) \{}
\NormalTok{  fmodsk[[}\FunctionTok{paste0}\NormalTok{(i)]] }\OtherTok{\textless{}{-}} \FunctionTok{as.formula}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\textasciitilde{}s(age)+s(year, k="}\NormalTok{,i,}\StringTok{")"}\NormalTok{))}
\NormalTok{\}}

\NormalTok{myFits }\OtherTok{\textless{}{-}} \FunctionTok{scas}\NormalTok{(}\FunctionTok{FLStocks}\NormalTok{(stk), }\FunctionTok{list}\NormalTok{(idx), }\AttributeTok{fmodel =}\NormalTok{ fmodsk)}
\FunctionTok{plot}\NormalTok{(myFits)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-24-1.png}

\hypertarget{modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data}{%
\chapter{Modelling Individual Growth and Using Stochastic Slicing to Convert Length-based Data Into Age-based Data}\label{modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data}}

This section explains the approach developed by \texttt{a4a} to take into account individual growth in stock assessment and advice. It presents a mixture of text and code, where the first explains the concepts behind the methods, while the last shows how these can be run with the \texttt{FLa4a} R package.

The \texttt{a4a} stock assessment framework is based on age dynamics. Therefore, to use length information, it must be processed before running the stock assessment model, which should give the analyst the flexibility to use a range of sources of information, \emph{e.g.} literature or online databases, to collect information about the species growth model and uncertainty about the model parameters.

The framework allows the analyst to parametrize individual growth, set the assumptions about it and condition the stock assessment model on those decisions. It incentivizes the \textbf{uptake} of estimation uncertainty, as well as exploring several parameterizations and/or growth models to deal with structural uncertainty, finally propagating uncertainty into stock assessment.

Within the \texttt{a4a} framework this is handled using the \texttt{a4aGr} class and its methods. This class stores information about the growth model and it's parameters, including parameters' uncertainty and the distributions governing it. The class's main method is \texttt{l2a} that converts length to ages based on a length based stock object and using the model defined in the \texttt{a4aGr} instance.

\hypertarget{a4agr---the-growth-class}{%
\section{a4aGr - The growth class}\label{a4agr---the-growth-class}}

The conversion of length data to age is performed through the use of a growth model. The implementation is done through the \texttt{a4aGr} class .

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showClass}\NormalTok{(}\StringTok{"a4aGr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Class "a4aGr" [package "FLa4a"]
## 
## Slots:
##                                                                             
## Name:      grMod  grInvMod    params      vcov     distr      name      desc
## Class:   formula   formula     FLPar     array character character character
##                 
## Name:      range
## Class:   numeric
## 
## Extends: "FLComp"
\end{verbatim}

To construct an \texttt{a4aGr} object, the growth model and parameters must be provided. Check the help file for more information.

Here we show an example using the von Bertalanffy growth model. To create the \texttt{a4aGr} object it's necessary to pass the model equation (\(length \sim time\)), the inverse model equation (\(time \sim length\)) and the parameters. Any growth model can be used as long as it's possible to write the model (and the inverse) as an R formula.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vbObj }\OtherTok{\textless{}{-}} \FunctionTok{a4aGr}\NormalTok{(}
    \AttributeTok{grMod=}\SpecialCharTok{\textasciitilde{}}\NormalTok{linf}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{k}\SpecialCharTok{*}\NormalTok{(t}\SpecialCharTok{{-}}\NormalTok{t0))),      }
    \AttributeTok{grInvMod=}\SpecialCharTok{\textasciitilde{}}\NormalTok{t0}\DecValTok{{-}1}\SpecialCharTok{/}\NormalTok{k}\SpecialCharTok{*}\FunctionTok{log}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{len}\SpecialCharTok{/}\NormalTok{linf),      }
    \AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{linf=}\FloatTok{58.5}\NormalTok{, }\AttributeTok{k=}\FloatTok{0.086}\NormalTok{, }\AttributeTok{t0=}\FloatTok{0.001}\NormalTok{, }\AttributeTok{units=}\FunctionTok{c}\NormalTok{(}\StringTok{"cm"}\NormalTok{,}\StringTok{"year{-}1"}\NormalTok{,}\StringTok{"year"}\NormalTok{))     }
\NormalTok{)}

\CommentTok{\# Check the model and its inverse}
\NormalTok{lc}\OtherTok{=}\DecValTok{20}
\FunctionTok{predict}\NormalTok{(vbObj, }\AttributeTok{len=}\NormalTok{lc)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iter
##           1
##   1 4.86575
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{predict}\NormalTok{(vbObj, }\AttributeTok{t=}\FunctionTok{predict}\NormalTok{(vbObj, }\AttributeTok{len=}\NormalTok{lc))}\SpecialCharTok{==}\NormalTok{lc}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iter
##        1
##   1 TRUE
\end{verbatim}

The predict method allows the transformation between age and lengths using the growth model.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{predict}\NormalTok{(vbObj, }\AttributeTok{len=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{10}\FloatTok{+0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iter
##            1
##   1 1.149080
##   2 1.370570
##   3 1.596362
##   4 1.826625
##   5 2.061540
##   6 2.301299
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{predict}\NormalTok{(vbObj, }\AttributeTok{t=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{10}\FloatTok{+0.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iter
##            1
##   1 22.04376
##   2 25.04796
##   3 27.80460
##   4 30.33408
##   5 32.65511
##   6 34.78488
\end{verbatim}

\hypertarget{adding-uncertainty-to-growth-parameters-with-a-multivariate-normal-distribution}{%
\section{Adding uncertainty to growth parameters with a multivariate normal distribution\}}\label{adding-uncertainty-to-growth-parameters-with-a-multivariate-normal-distribution}}

Uncertainty in the growth model is introduced through the inclusion of parameter uncertainty.
This is done by making use of the parameter variance-covariance matrix (the \texttt{vcov} slot of the \texttt{a4aGr} class) and assuming a distribution. The numbers in the variance-covariance matrix could come from the parameter uncertainty from fitting the growth model parameters.

Here we set the variance-covariance matrix by scaling a correlation matrix, using a cv of 0.2. Based on

\[\rho_{x,y}=\frac{\Sigma_{x,y}}{\sigma_x \sigma_y}\]

and

\[CV_x=\frac{\sigma_x}{\mu_x}\]

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make an empty cor matrix}
\NormalTok{cm }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\CommentTok{\# k and linf are negatively correlated while t0 is independent}
\NormalTok{cm[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ cm[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FloatTok{0.5}
\CommentTok{\# scale cor to var using CV=0.2}
\NormalTok{cv }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{linf=}\DecValTok{60}\NormalTok{, }\AttributeTok{k=}\FloatTok{0.09}\NormalTok{, }\AttributeTok{t0=}\SpecialCharTok{{-}}\FloatTok{0.01}\NormalTok{)}
\NormalTok{vc }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{ncol=}\DecValTok{3}\NormalTok{, }\AttributeTok{nrow=}\DecValTok{3}\NormalTok{)}
\NormalTok{l }\OtherTok{\textless{}{-}}\NormalTok{ vc}
\NormalTok{l[}\DecValTok{1}\NormalTok{,] }\OtherTok{\textless{}{-}}\NormalTok{ l[,}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ p[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{*}\NormalTok{cv}
\NormalTok{k }\OtherTok{\textless{}{-}}\NormalTok{ vc}
\NormalTok{k[,}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ k[}\DecValTok{2}\NormalTok{,] }\OtherTok{\textless{}{-}}\NormalTok{ p[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\NormalTok{cv}
\NormalTok{t }\OtherTok{\textless{}{-}}\NormalTok{ vc}
\NormalTok{t[}\DecValTok{3}\NormalTok{,] }\OtherTok{\textless{}{-}}\NormalTok{ t[,}\DecValTok{3}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ p[}\DecValTok{3}\NormalTok{]}\SpecialCharTok{*}\NormalTok{cv}
\NormalTok{mm }\OtherTok{\textless{}{-}}\NormalTok{ t}\SpecialCharTok{*}\NormalTok{k}\SpecialCharTok{*}\NormalTok{l}
\FunctionTok{diag}\NormalTok{(mm) }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(mm)}\SpecialCharTok{\^{}}\DecValTok{2}
\NormalTok{mm }\OtherTok{\textless{}{-}}\NormalTok{ mm}\SpecialCharTok{*}\NormalTok{cm}
\CommentTok{\# check that we have the intended correlation}
\FunctionTok{all.equal}\NormalTok{(cm, }\FunctionTok{cov2cor}\NormalTok{(mm))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] TRUE
\end{verbatim}

Create the a4aGr object as before but now we also include the vcov argument for the variance-covariance matrix.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vbObj }\OtherTok{\textless{}{-}} \FunctionTok{a4aGr}\NormalTok{(}\AttributeTok{grMod=}\SpecialCharTok{\textasciitilde{}}\NormalTok{linf}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{k}\SpecialCharTok{*}\NormalTok{(t}\SpecialCharTok{{-}}\NormalTok{t0))), }\AttributeTok{grInvMod=}\SpecialCharTok{\textasciitilde{}}\NormalTok{t0}\DecValTok{{-}1}\SpecialCharTok{/}\NormalTok{k}\SpecialCharTok{*}\FunctionTok{log}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{len}\SpecialCharTok{/}\NormalTok{linf), }
               \AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{linf=}\NormalTok{p[}\StringTok{"linf"}\NormalTok{], }\AttributeTok{k=}\NormalTok{p[}\StringTok{"k"}\NormalTok{], }\AttributeTok{t0=}\NormalTok{p[}\StringTok{"t0"}\NormalTok{], }
                            \AttributeTok{units=}\FunctionTok{c}\NormalTok{(}\StringTok{"cm"}\NormalTok{,}\StringTok{"year{-}1"}\NormalTok{,}\StringTok{"year"}\NormalTok{)), }\AttributeTok{vcov=}\NormalTok{mm)}
\end{Highlighting}
\end{Shaded}

First we show a simple example where we assume that the parameters are represented using a multivariate normal distribution.
\% This covariance matrix can have iterations (i.e.~each iteration can have a different covariance matrix). CHECK
\% If the parameters or the covariance matrix have iterations then the medians accross iterations are computed before simulating. Check help for `mvrnorm\} for more information.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Note that the object we have just created has a single iteration of each parameter}
\NormalTok{vbObj}\SpecialCharTok{@}\NormalTok{params}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
## params
##  linf     k    t0 
## 60.00  0.09 -0.01 
## units:  cm year-1 year
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(vbObj}\SpecialCharTok{@}\NormalTok{params)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# We simulate 10000 iterations from the a4aGr object by calling mvrnorm() using the }
\CommentTok{\# variance{-}covariance matrix we created earlier.}
\NormalTok{vbNorm }\OtherTok{\textless{}{-}} \FunctionTok{mvrnorm}\NormalTok{(}\DecValTok{10000}\NormalTok{,vbObj)}
\CommentTok{\# Now we have 10000 iterations of each parameter, randomly sampled from the }
\CommentTok{\# multivariate normal distribution}
\NormalTok{vbNorm}\SpecialCharTok{@}\NormalTok{params}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
## iters:  10000 
## 
## params
##                linf                   k                  t0 
## 60.022081(11.77963)  0.089898( 0.01761) -0.009988( 0.00199) 
## units:  cm year-1 year
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(vbNorm}\SpecialCharTok{@}\NormalTok{params)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]     3 10000
\end{verbatim}

We can now convert from length to ages data based on the 10000 parameter iterations. This gives us 10000 sets of age data. For example, here we convert a single length vector using each of the 10000 parameter iterations:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ages }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(vbNorm, }\AttributeTok{len=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{10}\FloatTok{+0.5}\NormalTok{)}
\FunctionTok{dim}\NormalTok{(ages)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]     6 10000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# We show the first ten iterations only as an illustration}
\NormalTok{ages[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iter
##            1        2        3         4        5         6        7        8
##   1 1.507676 1.344726 1.137132 0.9682739 1.130103 0.6753139 1.609634 1.386545
##   2 1.803933 1.610175 1.360018 1.1540719 1.346582 0.8063874 1.919423 1.662076
##   3 2.107204 1.882247 1.587850 1.3428921 1.566080 0.9394395 2.234555 1.945138
##   4 2.417829 2.161284 1.820854 1.5348343 1.788683 1.0745308 2.555219 2.236153
##   5 2.736173 2.447649 2.059270 1.7300036 2.014480 1.2117247 2.881611 2.535581
##   6 3.062631 2.741739 2.303356 1.9285103 2.243565 1.3510878 3.213940 2.843924
##    iter
##            9        10
##   1 2.356666 0.9934448
##   2 2.843170 1.1856422
##   3 3.350454 1.3809457
##   4 3.880372 1.5794573
##   5 4.435038 1.7812841
##   6 5.016878 1.9865388
\end{verbatim}

The marginal distributions can be seen in Figure @ref(fig:plot\_norm\_params).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_norm_params-1.png}
\caption{(\#fig:plot\_norm\_params)The marginal distributions of each of the parameters from using a multivariate normal distribution.}
\end{figure}

The shape of the correlation can be seen in Figure @ref(fig:plot\_norm\_scatter).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_norm_scatter-1.png}
\caption{(\#fig:plot\_norm\_scatter)Scatter plot of the 10000 samples parameter from the multivariate normal distribution.}
\end{figure}

Growth curves for the 1000 iterations can be seen in Figure @ref(fig:plot\_mv\_growth).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_mv_growth-1.png}
\caption{(\#fig:plot\_mv\_growth)Growth curves using parameters simulated from a multivariate normal distribution.}
\end{figure}

\hypertarget{adding-uncertainty-to-growth-parameters-with-a-multivariate-triangle-distribution}{%
\section{Adding uncertainty to growth parameters with a multivariate triangle distribution\}}\label{adding-uncertainty-to-growth-parameters-with-a-multivariate-triangle-distribution}}

\label{sec:growth_triangle_cop}

One alternative to using a normal distribution is to use a \href{http://en.wikipedia.org/wiki/Triangle_distribution}{triangle distribution}. We use the package \href{http://cran.r-project.org/web/packages/triangle/index.html}{\texttt{triangle}} where this distribution is parametrized using the minimum, maximum and median values. This can be very attractive if the analyst needs to scrape information from the web or literature and perform some kind of meta-analysis.

Here we show an example of setting a triangle distribution with values taken from Fishbase.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# The web address for the growth parameters for redfish (Sebastes norvegicus)}
\NormalTok{addr }\OtherTok{\textless{}{-}} \StringTok{"https://fishbase.se/PopDyn/PopGrowthList.php?ID=501"}
\CommentTok{\# Scrape the data}
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\FunctionTok{readHTMLTable}\NormalTok{(addr))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error : XML content does not seem to be XML: ''
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load local copy if no web}
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{is}\NormalTok{(tab, }\StringTok{"try{-}error"}\NormalTok{))}
  \FunctionTok{load}\NormalTok{(}\StringTok{"data/tab.RData"}\NormalTok{)}
\CommentTok{\# Interrogate the data table and get vectors of the values}
\NormalTok{linf }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(tab}\SpecialCharTok{$}\NormalTok{dataTable[,}\DecValTok{2}\NormalTok{]))}
\NormalTok{k }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(tab}\SpecialCharTok{$}\NormalTok{dataTable[,}\DecValTok{4}\NormalTok{]))}
\NormalTok{t0 }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(tab}\SpecialCharTok{$}\NormalTok{dataTable[,}\DecValTok{5}\NormalTok{]))}
\CommentTok{\# Set the min (a), max (b) and median (c) values for the parameter as a list of lists}
\CommentTok{\# Note that t0 has no \textquotesingle{}c\textquotesingle{} (median) value. This makes the distribution symmetrical}
\NormalTok{triPars }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{a=}\FunctionTok{min}\NormalTok{(linf), }\AttributeTok{b=}\FunctionTok{max}\NormalTok{(linf), }\AttributeTok{c=}\FunctionTok{median}\NormalTok{(linf)),}
             \FunctionTok{list}\NormalTok{(}\AttributeTok{a=}\FunctionTok{min}\NormalTok{(k), }\AttributeTok{b=}\FunctionTok{max}\NormalTok{(k), }\AttributeTok{c=}\FunctionTok{median}\NormalTok{(k)),}
             \FunctionTok{list}\NormalTok{(}\AttributeTok{a=}\FunctionTok{median}\NormalTok{(t0, }\AttributeTok{na.rm=}\NormalTok{T)}\SpecialCharTok{{-}}\FunctionTok{IQR}\NormalTok{(t0, }\AttributeTok{na.rm=}\NormalTok{T)}\SpecialCharTok{/}\DecValTok{2}\NormalTok{, }\AttributeTok{b=}\FunctionTok{median}\NormalTok{(t0, }\AttributeTok{na.rm=}\NormalTok{T)}\SpecialCharTok{+}
                    \FunctionTok{IQR}\NormalTok{(t0, }\AttributeTok{na.rm=}\NormalTok{T)}\SpecialCharTok{/}\DecValTok{2}\NormalTok{))}
\CommentTok{\# Simulate 10000 times using mvrtriangle}
\NormalTok{vbTri }\OtherTok{\textless{}{-}} \FunctionTok{mvrtriangle}\NormalTok{(}\DecValTok{10000}\NormalTok{, vbObj, }\AttributeTok{paramMargins=}\NormalTok{triPars)}
\end{Highlighting}
\end{Shaded}

The marginals will reflect the uncertainty on the parameter values that were scraped from \href{http://fishbase.org}{Fishbase} but, as we don't really believe the parameters are multivariate normal, here we adopted a distribution based on a \emph{t} copula with triangle marginals. The marginal distributions can be seen in Figure @ref(fig:plot\_tri\_params) and the shape of the correlation can be seen in Figure @ref(fig:plot\_tri\_scatter).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_tri_params-1.png}
\caption{(\#fig:plot\_tri\_params)The marginal distributions of each of the parameters from using a multivariate triangle distribution.}
\end{figure}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_tri_scatter-1.png}
\caption{(\#fig:plot\_tri\_scatter)Scatter plot of the 10000 samples parameter from the multivariate triangle distribution.}
\end{figure}

We can still use \texttt{predict()} to see the growth model uncertainty (Figure @ref(fig:plot\_tri\_growth)).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_tri_growth-1.png}
\caption{(\#fig:plot\_tri\_growth)Growth curves using parameters simulated from a multivariate triangle distribution.}
\end{figure}

Remember that the above examples use a variance-covariance matrix that we essentially made up. An alternative would be to scrape the entire growth parameters dataset from Fishbase and compute the shape of the variance-covariance matrix yourself.

\hypertarget{adding-uncertainty-to-growth-parameters-with-statistical-copulas}{%
\section{Adding uncertainty to growth parameters with statistical copulas\}}\label{adding-uncertainty-to-growth-parameters-with-statistical-copulas}}

A more general approach to adding parameter uncertainty is to make use of \href{http://www.encyclopediaofmath.org/index.php/Copula}{statistical copulas} and marginal distributions of choice. This is possible with the \texttt{mvrcop()} function borrowed from the package \href{http://cran.r-project.org/web/packages/copula/}{\texttt{copula}}. The example below keeps the same parameters and changes only the copula type and family but a lot more can be done. Check the package \texttt{copula} for more information.

\% Needs more explanation

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vbCop }\OtherTok{\textless{}{-}} \FunctionTok{mvrcop}\NormalTok{(}\DecValTok{10000}\NormalTok{, vbObj, }\AttributeTok{copula=}\StringTok{"archmCopula"}\NormalTok{, }\AttributeTok{family=}\StringTok{"clayton"}\NormalTok{, }\AttributeTok{param=}\DecValTok{2}\NormalTok{, }
                \AttributeTok{margins=}\StringTok{"triangle"}\NormalTok{, }\AttributeTok{paramMargins=}\NormalTok{triPars)}
\end{Highlighting}
\end{Shaded}

The shape of the correlation changes (Figure @ref(fig:plot\_cop\_tri\_scatter)) as well as the resulting growth curves (Figure @ref(fig:plot\_cop\_tri\_growth)).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_cop_tri_scatter-1.png}
\caption{(\#fig:plot\_cop\_tri\_scatter)Scatter plot of the 10000 samples parameter from the using an archmCopula copula with triangle margins.}
\end{figure}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_cop_tri_growth-1.png}
\caption{(\#fig:plot\_cop\_tri\_growth)Growth curves from the using an archmCopula copula with triangle margins.}
\end{figure}

\hypertarget{converting-from-length-to-age-based-data---the-l2a-method}{%
\section{\texorpdfstring{Converting from length to age based data - the \texttt{l2a()} method\}}{Converting from length to age based data - the l2a() method\}}}\label{converting-from-length-to-age-based-data---the-l2a-method}}

After introducing uncertainty in the growth model through the parameters it's time to transform the length-based dataset into an age-based dataset. The method that deals with this process is \texttt{l2a()}. The implementation of this method for the \texttt{FLQuant} class is the main workhorse. There are two other implementations, for the \texttt{FLStock} and \texttt{FLIndex} classes, which are mainly wrappers that call the \texttt{FLQuant} method several times.

When converting from length-based data to age-based data you need to be aware of how the aggregation of length classes is performed. For example, individuals in length classes 1-2, 2-3, and 3-4 cm may all be considered as being of age 1 (obviously depending on the growth model). How should the values in those length classes be combined?

If the values are abundances then the values should be summed. Summing other types of values, such as mean weight, does not make sense. Instead these values are averaged over the length classes (possibly weighted by the abundance). This is controlled using the \texttt{stat} argument which can be either \texttt{mean} or \texttt{sum} (the default). Fishing mortality is not computed to avoid making wrong assumptions about the meaning of F at length.

We demonstrate the method by converting a catch-at-length \texttt{FLQuant} to a catch-at-age \texttt{FLQuant}. First we make an \texttt{a4aGr} object with a multivariate triangle distribution (using the parameters we set above). We use 10 iterations as an example. And call \texttt{l2a()} by passing in the length-based \texttt{FLQuant} and the \texttt{a4aGr} object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vbTriSmall }\OtherTok{\textless{}{-}} \FunctionTok{mvrtriangle}\NormalTok{(}\DecValTok{10}\NormalTok{, vbObj, }\AttributeTok{paramMargins=}\NormalTok{triPars)}
\NormalTok{cth.n }\OtherTok{\textless{}{-}} \FunctionTok{l2a}\NormalTok{(}\FunctionTok{catch.n}\NormalTok{(rfLen.stk), vbTriSmall)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in log(1 - len/linf): NaNs produced
## Warning in log(1 - len/linf): NaNs produced
## Warning in log(1 - len/linf): NaNs produced
## Warning in log(1 - len/linf): NaNs produced
## Warning in log(1 - len/linf): NaNs produced
## Warning in log(1 - len/linf): NaNs produced
## Warning in log(1 - len/linf): NaNs produced
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(cth.n)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 60 26  1  4  1 10
\end{verbatim}

In the previous example, the \texttt{FLQuant} object that was sliced (\texttt{catch.n(rfLen.stk)}) had only one iteration. This iteration was sliced by each of the iterations in the growth model. It is possible for the \texttt{FLQuant} object to have the same number of iterations as the growth model, in which case each iteration of the \texttt{FLQuant} and the growth model are used together. It is also possible for the growth model to have only one iteration while the \texttt{FLQuant} object has many iterations. The same growth model is then used for each of the \texttt{FLQuant} iterations. As with all \texttt{FLR} objects, the general rule is \emph{one or n} iterations.

As well as converting one \texttt{FLQuant} at a time, we can convert entire \texttt{FLStock} and \texttt{FLIndex} objects. In these cases the individual \texttt{FLQuant} slots of those classes are converted from length-based to age-based. As mentioned above, the aggregation method depends on the type of values the slots contain. The abundance slots (\texttt{*.n}, such as \texttt{stock.n}) are summed. The \texttt{*.wt}, \texttt{m}, \texttt{mat}, \texttt{harvest.spwn} and \texttt{m.spwn} slots of an \texttt{FLStock} object are averaged. The \texttt{catch.wt} and \texttt{sel.pattern} slots of an \texttt{FLIndex} object are averaged, while the \texttt{index}, \texttt{index.var} and \texttt{catch.n} slots are summed.

The method for \texttt{FLStock} classes takes an additional argument for the plusgroup.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aStk }\OtherTok{\textless{}{-}} \FunctionTok{l2a}\NormalTok{(rfLen.stk, vbTriSmall, }\AttributeTok{plusgroup=}\DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in .local(object, model, ...): Individual weights, M and maturity will be (weighted) averaged accross lengths,
##  harvest is not computed and everything else will be summed.
##  If this is not what you want, you'll have to deal with these slots by hand.
\end{verbatim}

\begin{verbatim}
## Warning in .local(object, model, ...): Some ages are less than 0, indicating a mismatch between input data lengths
##  and growth parameters (possibly t0)
\end{verbatim}

\begin{verbatim}
## Warning in .local(object, model, ...): Trimming age range to a minimum of 0
\end{verbatim}

\begin{verbatim}
## [1] "maxfbar has been changed to accomodate new plusgroup"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aIdx }\OtherTok{\textless{}{-}} \FunctionTok{l2a}\NormalTok{(rfTrawl.idx, vbTriSmall)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in l2a(rfTrawl.idx, vbTriSmall): Some ages are less than 0, indicating a mismatch between input data lengths
##  and growth parameters (possibly t0)
\end{verbatim}

\begin{verbatim}
## Warning in l2a(rfTrawl.idx, vbTriSmall): Trimming age range to a minimum of 0
\end{verbatim}

When converting with \texttt{l2a()} all lengths above Linf are converted to the maximum age, as there is no information in the growth model about how to deal with individuals larger than Linf.

\hypertarget{modelling-natural-mortality}{%
\chapter{Modelling Natural Mortality}\label{modelling-natural-mortality}}

The document explains the approach being developed by a4a to integrate uncertainty in natural mortality into stock assessment and advice. It presents a mixture of text and code, where the first explains the concepts behind the methods, while the last shows how these can be run with the software provided.

\hypertarget{background}{%
\section{Background}\label{background}}

In the \texttt{a4a} natural mortality is dealt with as an external parameter to the stock assessment model. The rationale to modelling natural mortality is similar to that of growth: one should be able to grab information from a range of sources and feed it into the assessment.

The mechanism used by \texttt{a4a} is to build an interface that makes it transparent, flexible and hopefully easy to explore different options. In relation to natural mortality it means that the analyst should be able to use distinct models like Gislasson's, Charnov's, Pauly's, etc in a coherent framework making it possible to compare the outcomes of the assessment.

Within the \texttt{a4a} framework, the general method for inserting natural mortality in the stock assessment is to:

\begin{itemize}
\tightlist
\item
  Create an object of class \texttt{a4aM} which holds the natural mortality model and parameters.
\item
  Add uncertainty to the parameters in the \texttt{a4aM} object.
\item
  Apply the \texttt{m()} method to the \texttt{a4aM} object to create an age or length based \texttt{FLQuant} object of the required dimensions.
\end{itemize}

The resulting \texttt{FLQuant} object can then be directly inserted into an \texttt{FLStock} object to be used for the assessment.

In this section we go through each of the steps in detail using a variety of different models.

\hypertarget{a4am---the-m-class}{%
\section{\texorpdfstring{\texttt{a4aM} - The M class}{a4aM - The M class}}\label{a4am---the-m-class}}

Natural mortality is implemented in a class named \texttt{a4aM}. This class is made up of three objects of the class \texttt{FLModelSim}. Each object is a model that represents one effect: an age or length effect, a scaling (level) effect and a time trend, named \texttt{shape}, \texttt{level} and \texttt{trend}, respectively. The impact of the models is multiplicative, i.e.~the overal natural mortality is given by \texttt{shape} x \texttt{level} x \texttt{trend}. Check the help files for more information.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showClass}\NormalTok{(}\StringTok{"a4aM"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Class "a4aM" [package "FLa4a"]
## 
## Slots:
##                                                                         
## Name:       shape      level      trend       name       desc      range
## Class: FLModelSim FLModelSim FLModelSim  character  character    numeric
## 
## Extends: "FLComp"
\end{verbatim}

The \texttt{a4aM} constructor requires that the models and parameters are provided. The default method will build each of these models as a constant value of 1.

As a simple example, the usual ``0.2'' guessestimate could be set up by setting the \texttt{level} model to have a single parameter with a fixed value, while the other two models, \texttt{shape} and \texttt{trend}, have a default value of 1 (meaning that they have no effect).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod02 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\NormalTok{a, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{a=}\FloatTok{0.2}\NormalTok{))}
\NormalTok{m1 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{level=}\NormalTok{mod02)}
\NormalTok{m1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4aM object:
##   shape: ~1
##   level: ~a
##   trend: ~1
\end{verbatim}

More interesting natural mortality shapes can be set up using biological knowledge. The following example uses an exponential decay over ages (implying that the resulting \texttt{FLQuant}\} generated by the \texttt{m()} method will be age based). We also use Jensen's second estimator (\href{http://onlinelibrary.wiley.com/doi/10.1111/faf.12027/abstract}{Kenchington, 2014}) as a scaling \texttt{level} model, which is based on the von Bertalanffy \(K\) parameter, \(M=1.5K\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shape2 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{age}\FloatTok{{-}0.5}\NormalTok{))}
\NormalTok{level2 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\FloatTok{1.5}\SpecialCharTok{*}\NormalTok{k, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{k=}\FloatTok{0.4}\NormalTok{))}
\NormalTok{m2 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{shape2, }\AttributeTok{level=}\NormalTok{level2)}
\NormalTok{m2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4aM object:
##   shape: ~exp(-age - 0.5)
##   level: ~1.5 * k
##   trend: ~1
\end{verbatim}

Note that the \texttt{shape} model has \texttt{age} as a parameter of the model but is not set using the \texttt{params} argument.

The \texttt{shape} model does not have to be age-based. For example, here we set up a \texttt{shape} model using Gislason's second estimator (Kenshington, 2013): \(M_l=K(\frac{L_{\inf}}{l})^{1.5}\). We use the default \texttt{level} and \texttt{trend} models.
\% Current m() method is not ideal for length based methods as you cannot specify length range and half-widths to make compatible with FLStockLen

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shape\_len }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\NormalTok{K}\SpecialCharTok{*}\NormalTok{(linf}\SpecialCharTok{/}\NormalTok{len)}\SpecialCharTok{\^{}}\FloatTok{1.5}\NormalTok{, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{linf=}\DecValTok{60}\NormalTok{, }\AttributeTok{K=}\FloatTok{0.4}\NormalTok{))}
\NormalTok{m\_len }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{shape\_len)}
\end{Highlighting}
\end{Shaded}

Another option is to model how an external factor may impact the natural mortality. This can be added through the \texttt{trend} model. Suppose natural mortality can be modelled with a dependency on the NAO index, due to some mechanism that results in having lower mortality when NAO is negative and higher when it's positive. In this example, the impact is represented by the NAO value on the quarter before spawning, which occurs in the second quarter.

We use this to make a complicated natural mortality model with an age based shape model, a level model based on \(K\) and a trend model driven by NAO, where mortality increases by 50\% if NAO is positive on the first quarter.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Get NAO}
\NormalTok{nao }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"https://www.cpc.ncep.noaa.gov/products/precip/CWlink/pna/norm.nao.monthly.b5001.current.ascii.table"}\NormalTok{, }\AttributeTok{skip=}\DecValTok{1}\NormalTok{, }\AttributeTok{fill=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings=}\StringTok{"{-}99.90"}\NormalTok{)}
\NormalTok{dnms }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{quant=}\StringTok{"nao"}\NormalTok{, }\AttributeTok{year=}\DecValTok{1950}\SpecialCharTok{:}\DecValTok{2024}\NormalTok{, }\AttributeTok{unit=}\StringTok{"unique"}\NormalTok{, }\AttributeTok{season=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{, }\AttributeTok{area=}\StringTok{"unique"}\NormalTok{)}
\CommentTok{\# Build an FLQuant from the NAO data}
\NormalTok{nao.flq }\OtherTok{\textless{}{-}} \FunctionTok{FLQuant}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(nao[,}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]), }\AttributeTok{dimnames=}\NormalTok{dnms, }\AttributeTok{units=}\StringTok{"nao"}\NormalTok{)}
\CommentTok{\# Build covar by calculating mean over the first 3 months}
\NormalTok{nao }\OtherTok{\textless{}{-}} \FunctionTok{seasonMeans}\NormalTok{(}\FunctionTok{trim}\NormalTok{(nao.flq, }\AttributeTok{year=}\FunctionTok{dimnames}\NormalTok{(}\FunctionTok{stock.n}\NormalTok{(ple4))}\SpecialCharTok{$}\NormalTok{year))}
\CommentTok{\# Turn into Boolean}
\NormalTok{nao }\OtherTok{\textless{}{-}}\NormalTok{ (nao}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)}
\CommentTok{\# Constructor}
\NormalTok{trend3 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\SpecialCharTok{+}\NormalTok{b}\SpecialCharTok{*}\NormalTok{nao, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{b=}\FloatTok{0.5}\NormalTok{))}
\NormalTok{shape3 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{age}\FloatTok{{-}0.5}\NormalTok{))}
\NormalTok{level3 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\FloatTok{1.5}\SpecialCharTok{*}\NormalTok{k, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{k=}\FloatTok{0.4}\NormalTok{))}
\NormalTok{m3 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{shape3, }\AttributeTok{level=}\NormalTok{level3, }\AttributeTok{trend=}\NormalTok{trend3)}
\NormalTok{m3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4aM object:
##   shape: ~exp(-age - 0.5)
##   level: ~1.5 * k
##   trend: ~1 + b * nao
\end{verbatim}

\hypertarget{adding-uncertainty-to-natural-mortality-parameters-with-a-multivariate-normal-distribution}{%
\section{Adding uncertainty to natural mortality parameters with a multivariate normal distribution}\label{adding-uncertainty-to-natural-mortality-parameters-with-a-multivariate-normal-distribution}}

Uncertainty on natural mortality is added through uncertainty on the parameters.

In this section we'll' show how to add multivariate normal uncertainty. We make use of the class \texttt{FLModelSim} method \texttt{mvrnorm()}, which is a wrapper for the method \texttt{mvrnorm()} distributed by the package \texttt{MASS}.

We'll create an \texttt{a4aM} object with an exponential shape, a \texttt{level} model based on \(k\) and temperature (Jensen's third estimator), and a \texttt{trend} model driven by the NAO (as above). Afterwards a variance-covariance matrix for the \texttt{level} and \texttt{trend} models will be included. Finally, create an object with 100 iterations using the \texttt{mvrnorm()} method.

Create the object:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{shape4 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{age}\FloatTok{{-}0.5}\NormalTok{))}
\NormalTok{level4 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\NormalTok{k}\SpecialCharTok{\^{}}\FloatTok{0.66}\SpecialCharTok{*}\NormalTok{t}\SpecialCharTok{\^{}}\FloatTok{0.57}\NormalTok{, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{k=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{t=}\DecValTok{10}\NormalTok{), }\AttributeTok{vcov=}\FunctionTok{array}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.002}\NormalTok{, }\FloatTok{0.01}\NormalTok{,}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{dim=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{)))}
\NormalTok{trend4 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\SpecialCharTok{+}\NormalTok{b}\SpecialCharTok{*}\NormalTok{nao, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{b=}\FloatTok{0.5}\NormalTok{), }\AttributeTok{vcov=}\FunctionTok{matrix}\NormalTok{(}\FloatTok{0.02}\NormalTok{))}
\NormalTok{m4 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{shape4, }\AttributeTok{level=}\NormalTok{level4, }\AttributeTok{trend=}\NormalTok{trend4)}
\CommentTok{\# Call mvrnorm()}
\NormalTok{m4 }\OtherTok{\textless{}{-}} \FunctionTok{mvrnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, m4)}
\NormalTok{m4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4aM object:
##   shape: ~exp(-age - 0.5)
##   level: ~k^0.66 * t^0.57
##   trend: ~1 + b * nao
\end{verbatim}

Inspect the level model (for example):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m4}\SpecialCharTok{@}\NormalTok{level}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLModelSim"
## Slot "model":
## ~k^0.66 * t^0.57
## 
## Slot "params":
## An object of class "FLPar"
## iters:  100 
## 
## params
##                k                t 
##  0.41144(0.0558) 10.18198(1.0595) 
## units:  NA 
## 
## Slot "vcov":
##       [,1] [,2]
## [1,] 0.002 0.01
## [2,] 0.010 1.00
## 
## Slot "distr":
## [1] "norm"
\end{verbatim}

Note the variance in the parameters:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{params}\NormalTok{(}\FunctionTok{trend}\NormalTok{(m4))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
## iters:  100 
## 
## params
##              b 
## 0.50515(0.146) 
## units:  NA
\end{verbatim}

Note the shape model has no parameters and no uncertainty:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{params}\NormalTok{(}\FunctionTok{shape}\NormalTok{(m4))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
## params
##    
## NA 
## units:  NA
\end{verbatim}

In this particular case, the \texttt{shape} model will not be randomized because it doesn't have a variance-covariance matrix. Also note that because there is only one parameter in the `trend\} model, the randomization will use a univariate normal distribution.

The same model could be achieved by using \texttt{mnrnorm()} on each model component:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m4 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{shape4, }\AttributeTok{level=}\FunctionTok{mvrnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, level4), }\AttributeTok{trend=}\FunctionTok{mvrnorm}\NormalTok{(}\DecValTok{100}\NormalTok{, trend4))}
\end{Highlighting}
\end{Shaded}

\%Note: How to include ageing error ???

\hypertarget{adding-uncertainty-to-natural-mortality-parameters-with-statistical-copulas}{%
\section{Adding uncertainty to natural mortality parameters with statistical copulas}\label{adding-uncertainty-to-natural-mortality-parameters-with-statistical-copulas}}

We can also use copulas to add parameter uncertainty to the natural mortality model, similar to the way we use them for the growth model in Section \ref{sec:growth_triangle_cop}. As stated above these processes make use of the methods implemented for the \texttt{FLModelSim} class.

\% EXPAND\ldots{}

In the following example we'll use again Gislason's second estimator, \(M_l=K(\frac{L_{\inf}}{l})^{1.5}\) and a triangle copula to model parameter uncertainty. The method \texttt{mvrtriangle()} is used to create 1000 iterations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{linf }\OtherTok{\textless{}{-}} \DecValTok{60}
\NormalTok{k }\OtherTok{\textless{}{-}} \FloatTok{0.4}
\CommentTok{\# vcov matrix (make up some values)}
\NormalTok{mm }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{ncol=}\DecValTok{2}\NormalTok{, }\AttributeTok{nrow=}\DecValTok{2}\NormalTok{)}
\CommentTok{\# 10\% cv}
\FunctionTok{diag}\NormalTok{(mm) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{((linf}\SpecialCharTok{*}\FloatTok{0.1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{, (k}\SpecialCharTok{*}\FloatTok{0.1}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\CommentTok{\# 0.2 correlation}
\NormalTok{mm[}\FunctionTok{upper.tri}\NormalTok{(mm)] }\OtherTok{\textless{}{-}}\NormalTok{ mm[}\FunctionTok{lower.tri}\NormalTok{(mm)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{0.05}\NormalTok{)}
\CommentTok{\# a good way to check is using cov2cor}
\FunctionTok{cov2cor}\NormalTok{(mm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           [,1]      [,2]
## [1,] 1.0000000 0.2083333
## [2,] 0.2083333 1.0000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# create object}
\NormalTok{mgis2 }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\NormalTok{k}\SpecialCharTok{*}\NormalTok{(linf}\SpecialCharTok{/}\NormalTok{len)}\SpecialCharTok{\^{}}\FloatTok{1.5}\NormalTok{, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{linf=}\NormalTok{linf, }\AttributeTok{k=}\NormalTok{k), }\AttributeTok{vcov=}\NormalTok{mm)}
\CommentTok{\# set the lower, upper and (optionally) centre of the parameters (without the centre, the triangle is symmetrical)}
\NormalTok{pars }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{a=}\DecValTok{55}\NormalTok{,}\AttributeTok{b=}\DecValTok{65}\NormalTok{), }\FunctionTok{list}\NormalTok{(}\AttributeTok{a=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{b=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{c=}\FloatTok{0.35}\NormalTok{))}
\NormalTok{mgis2 }\OtherTok{\textless{}{-}} \FunctionTok{mvrtriangle}\NormalTok{(}\DecValTok{1000}\NormalTok{, mgis2, }\AttributeTok{paramMargins=}\NormalTok{pars)}
\NormalTok{mgis2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLModelSim"
## Slot "model":
## ~k * (linf/len)^1.5
## 
## Slot "params":
## An object of class "FLPar"
## iters:  1000 
## 
## params
##             linf                k 
## 59.94156(2.1597)  0.40448(0.0708) 
## units:  NA 
## 
## Slot "vcov":
##       [,1]   [,2]
## [1,] 36.00 0.0500
## [2,]  0.05 0.0016
## 
## Slot "distr":
## [1] "un <deprecated slot> triangle"
\end{verbatim}

The resulting parameter estimates and marginal distributions can be seen in Figure @ref(fig:plot\_tri\_gis\_m) and @ref(fig:plot\_tri\_gis\_m\_hist).

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_tri_gis_m-1.png}
\caption{(\#fig:plot\_tri\_gis\_m)Parameter estimates for Gislason's second natural mortality model from using a triangle distribution.}
\end{figure}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/plot_tri_gis_m_hist-1.png}
\caption{(\#fig:plot\_tri\_gis\_m\_hist)Marginal distributions of the parameters for Gislason's second natural mortality model using a triangle distribution.}
\end{figure}

We now have a new model that can be used for the \texttt{shape} model. You can use the constructor or the set method to add the new model. Note that we have a quite complex method now for M. A length based \texttt{shape\}\ model\ from\ Gislason\textquotesingle{}s\ work,\ Jensen\textquotesingle{}s\ third\ model\ based\ on\ temperature}level\texttt{and\ a\ time}trend` depending on NAO. All of the component models have uncertainty in their parameters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m5 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{mgis2, }\AttributeTok{level=}\NormalTok{level4, }\AttributeTok{trend=}\NormalTok{trend4)}
\CommentTok{\# or}
\NormalTok{m5 }\OtherTok{\textless{}{-}}\NormalTok{ m4}
\FunctionTok{shape}\NormalTok{(m5) }\OtherTok{\textless{}{-}}\NormalTok{ mgis2}
\end{Highlighting}
\end{Shaded}

\hypertarget{computing-natural-mortality-time-series---the-m-method}{%
\section{Computing natural mortality time series - the ``m'' method}\label{computing-natural-mortality-time-series---the-m-method}}

Now that we have set up the natural mortality \texttt{a4aM} model and added parameter uncertainty to each component, we are ready to generate the \texttt{FLQuant} of natural mortality. For that we need the \texttt{m()} method.

The \texttt{m()} method is the workhorse method for computing natural mortality. The method returns an \texttt{FLQuant} that can be inserted in an \texttt{FLStock} for usage by the assessment method.

\%The method uses the \texttt{range} slot to work out the dimensions of the \texttt{FLQuant} object.
\% Future developments will also allow for easy insertion into FLStockLen objects.

The size of the \texttt{FLQuant} object is determined by the \texttt{min}, \texttt{max}, \texttt{minyear} and \texttt{maxyear} elements of the \texttt{range} slot of the \texttt{a4aM} object. By default the values of these elements are set to 0. Giving an \texttt{FLQuant} with length 1 in the \texttt{quant} and \texttt{year} dimension. The \texttt{range} slot can be set by hand, or by using the \texttt{rngquant()} and \texttt{rngyear()} methods.

The name of the first dimension of the output \texttt{FLQuant} (e.g.~`age' or `len') is determined by the parameters of the \texttt{shape} model. If it is not clear what the name should be then the name is set to `quant'.

Here we demonstrate \texttt{m()} using the simple \texttt{a4aM} object we created above that has constant natural mortality.

Start with the simplest model:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4aM object:
##   shape: ~1
##   level: ~a
##   trend: ~1
\end{verbatim}

Check the range:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       min       max plusgroup   minyear   maxyear   minmbar   maxmbar 
##         0         0         0         0         0         0         0
\end{verbatim}

Simple - no ages or years:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{m}\NormalTok{(m1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##      year
## quant 0  
##     0 0.2
## 
## units:  NA
\end{verbatim}

Set the quant and year ranges:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m1, }\FunctionTok{c}\NormalTok{(}\StringTok{"min"}\NormalTok{,}\StringTok{"max"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{7}\NormalTok{) }\CommentTok{\# set the quant range}
\FunctionTok{range}\NormalTok{(m1, }\FunctionTok{c}\NormalTok{(}\StringTok{"minyear"}\NormalTok{,}\StringTok{"maxyear"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{2010}\NormalTok{) }\CommentTok{\# set the year range}
\FunctionTok{range}\NormalTok{(m1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       min       max plusgroup   minyear   maxyear   minmbar   maxmbar 
##         0         7         0      2000      2010         0         0
\end{verbatim}

Create the object with the M estimates by age and year, note the name of the first dimension is `quant'.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{m}\NormalTok{(m1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##      year
## quant 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010
##     0 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     1 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     2 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     3 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     4 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     5 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     6 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
##     7 0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2  0.2 
## 
## units:  NA
\end{verbatim}

The next example has an age-based shape. As the \texttt{shape} model has `age' as a variable which is not included in the \texttt{FLPar} slot it is used as the name of the first dimension of the resulting \texttt{FLQuant}. Note that in this case the \texttt{mbar} values in the range become relevant, once that \texttt{mbar} is used to compute the mean level. This mean level will match the value given by the \texttt{level} model. The \texttt{mbar} range can be changed with the \texttt{rngmbar()} method. We illustrate this by making an \texttt{FLQuant} with age varying natural mortality.

Check the model and set the ranges:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4aM object:
##   shape: ~exp(-age - 0.5)
##   level: ~1.5 * k
##   trend: ~1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m2, }\FunctionTok{c}\NormalTok{(}\StringTok{"min"}\NormalTok{,}\StringTok{"max"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{7}\NormalTok{) }\CommentTok{\# set the quant range}
\FunctionTok{range}\NormalTok{(m2, }\FunctionTok{c}\NormalTok{(}\StringTok{"minyear"}\NormalTok{,}\StringTok{"maxyear"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{2003}\NormalTok{) }\CommentTok{\# set the year range}
\FunctionTok{range}\NormalTok{(m2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       min       max plusgroup   minyear   maxyear   minmbar   maxmbar 
##         0         7         0      2000      2003         0         0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{m}\NormalTok{(m2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 2000     2001     2002     2003    
##   0 0.600000 0.600000 0.600000 0.600000
##   1 0.220728 0.220728 0.220728 0.220728
##   2 0.081201 0.081201 0.081201 0.081201
##   3 0.029872 0.029872 0.029872 0.029872
##   4 0.010989 0.010989 0.010989 0.010989
##   5 0.004043 0.004043 0.004043 0.004043
##   6 0.001487 0.001487 0.001487 0.001487
##   7 0.000547 0.000547 0.000547 0.000547
## 
## units:  NA
\end{verbatim}

Note that the level value is:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{predict}\NormalTok{(}\FunctionTok{level}\NormalTok{(m2))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    iter
##       1
##   1 0.6
\end{verbatim}

Which is the same as:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{m}\NormalTok{(m2)[}\StringTok{"0"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 2000 2001 2002 2003
##   0 0.6  0.6  0.6  0.6 
## 
## units:  NA
\end{verbatim}

This is because the mbar range is currently set to ``0'' and ``0'' (see above) and the mean natural mortality value over this range is given by the level model.

We can change the \texttt{mbar} range:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m2, }\FunctionTok{c}\NormalTok{(}\StringTok{"minmbar"}\NormalTok{,}\StringTok{"maxmbar"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{5}\NormalTok{)}
\FunctionTok{range}\NormalTok{(m2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       min       max plusgroup   minyear   maxyear   minmbar   maxmbar 
##         0         7         0      2000      2003         0         5
\end{verbatim}

Which rescales the the natural mortality at age:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{m}\NormalTok{(m2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 2000    2001    2002    2003   
##   0 2.28129 2.28129 2.28129 2.28129
##   1 0.83924 0.83924 0.83924 0.83924
##   2 0.30874 0.30874 0.30874 0.30874
##   3 0.11358 0.11358 0.11358 0.11358
##   4 0.04178 0.04178 0.04178 0.04178
##   5 0.01537 0.01537 0.01537 0.01537
##   6 0.00565 0.00565 0.00565 0.00565
##   7 0.00208 0.00208 0.00208 0.00208
## 
## units:  NA
\end{verbatim}

Check that the mortality over the mean range is the same as the level model:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{quantMeans}\NormalTok{(}\FunctionTok{m}\NormalTok{(m2)[}\FunctionTok{as.character}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##      year
## age   2000 2001 2002 2003
##   all 0.6  0.6  0.6  0.6 
## 
## units:  NA
\end{verbatim}

The next example uses a time trend for the \texttt{trend} model. We use the \texttt{m3} model we made earlier. The \texttt{trend} model for this model has a covariate, `nao'. This needs to be passed to the \texttt{m()} method. The year range of the `nao' covariate should match that of the \texttt{range} slot.

Simple, pass in a single nao value (only one year):

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{m}\NormalTok{(m3, }\AttributeTok{nao=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 0  
##   0 0.9
## 
## units:  NA
\end{verbatim}

Set ages:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m3, }\FunctionTok{c}\NormalTok{(}\StringTok{"min"}\NormalTok{,}\StringTok{"max"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{7}\NormalTok{)}
\FunctionTok{m}\NormalTok{(m3, }\AttributeTok{nao=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 0       
##   0 0.600000
##   1 0.220728
##   2 0.081201
##   3 0.029872
##   4 0.010989
##   5 0.004043
##   6 0.001487
##   7 0.000547
## 
## units:  NA
\end{verbatim}

With ages and years - passing in the NAO data as numeric (1,0,1,0)

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m3, }\FunctionTok{c}\NormalTok{(}\StringTok{"minyear"}\NormalTok{,}\StringTok{"maxyear"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{2003}\NormalTok{)}
\FunctionTok{m}\NormalTok{(m3, }\AttributeTok{nao=}\FunctionTok{as.numeric}\NormalTok{(nao[,}\FunctionTok{as.character}\NormalTok{(}\DecValTok{2000}\SpecialCharTok{:}\DecValTok{2003}\NormalTok{)]))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 2000     2001     2002     2003    
##   0 0.900000 0.600000 0.900000 0.900000
##   1 0.331091 0.220728 0.331091 0.331091
##   2 0.121802 0.081201 0.121802 0.121802
##   3 0.044808 0.029872 0.044808 0.044808
##   4 0.016484 0.010989 0.016484 0.016484
##   5 0.006064 0.004043 0.006064 0.006064
##   6 0.002231 0.001487 0.002231 0.002231
##   7 0.000821 0.000547 0.000821 0.000821
## 
## units:  NA
\end{verbatim}

The final example show how \texttt{m()} can be used to make an \texttt{FLQuant} with uncertainty (see Figure @ref(fig:uncertain\_m)). We use the \texttt{m4} object from earlier with uncertainty on the \texttt{level} and \texttt{trend} parameters.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{range}\NormalTok{(m4, }\FunctionTok{c}\NormalTok{(}\StringTok{"min"}\NormalTok{,}\StringTok{"max"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{7}\NormalTok{)}
\FunctionTok{range}\NormalTok{(m4, }\FunctionTok{c}\NormalTok{(}\StringTok{"minyear"}\NormalTok{,}\StringTok{"maxyear"}\NormalTok{)) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{2003}\NormalTok{)}
\NormalTok{flq }\OtherTok{\textless{}{-}} \FunctionTok{m}\NormalTok{(m4, }\AttributeTok{nao=}\FunctionTok{as.numeric}\NormalTok{(nao[,}\FunctionTok{as.character}\NormalTok{(}\DecValTok{2000}\SpecialCharTok{:}\DecValTok{2003}\NormalTok{)]))}
\NormalTok{flq}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## iters:  100 
## 
## , , unit = unique, season = all, area = unique
## 
##    year
## age 2000              2001              2002              2003             
##   0 3.00366(0.325764) 2.02686(0.177895) 3.00366(0.325764) 3.00366(0.325764)
##   1 1.10498(0.119842) 0.74564(0.065444) 1.10498(0.119842) 1.10498(0.119842)
##   2 0.40650(0.044087) 0.27431(0.024075) 0.40650(0.044087) 0.40650(0.044087)
##   3 0.14954(0.016219) 0.10091(0.008857) 0.14954(0.016219) 0.14954(0.016219)
##   4 0.05501(0.005967) 0.03712(0.003258) 0.05501(0.005967) 0.05501(0.005967)
##   5 0.02024(0.002195) 0.01366(0.001199) 0.02024(0.002195) 0.02024(0.002195)
##   6 0.00745(0.000807) 0.00502(0.000441) 0.00745(0.000807) 0.00745(0.000807)
##   7 0.00274(0.000297) 0.00185(0.000162) 0.00274(0.000297) 0.00274(0.000297)
## 
## units:  NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(flq)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]   8   4   1   1   1 100
\end{verbatim}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/uncertain_m-1.png}
\caption{(\#fig:uncertain\_m)Natural mortality with age and year trend.}
\end{figure}

\hypertarget{stock-assessment-framework}{%
\chapter{Stock assessment framework}\label{stock-assessment-framework}}

\hypertarget{maths-description}{%
\section{\texorpdfstring{Maths description \label{sec:math}}{Maths description }}\label{maths-description}}

\hypertarget{observations}{%
\subsection{Observations}\label{observations}}

The stock assessment model behind the framework is based on two types of observations: catches, \(\hat{C}\), and abundance indices, \(\hat{I}\). The model predicts catches at age \(C_{ay}\) and indices of abundance \(I_{ays}\) for each age \(a\), year \(y\) and survey \(s\) in the input dataset. It is assumed that the observed catches are normally distributed about the model predictions on the log scale with some observation variance \(\sigma^2_{ay}\). that is:

\[\log \hat{C}_{ay} \sim \text{Normal} \Big( \log C_{ay}, \sigma^2_{ay}\Big)\]

likewise, the observed survey indices are assumed to be normally distributed about the model predictions on the log scale with some observation variance \(\tau^2_{ays}\):

\[\log \hat{I}_{ays} \sim \text{Normal} \Big( \log I_{ays}, \tau^2_{ays} \Big)\]

This leads to the definition of the log-likelihood of the observed catches

\[\ell_C = \sum_{ay} w^{(c)}_{ay}\ \ell_N \Big( \log C_{ay}, \sigma^2_{ay} ;\ \log \hat{C}_{ay} \Big)\]

and the log-likelihood of the observed survey indices

\[\ell_I = \sum_s \sum_{ay} w^{(s)}_{ays}\ \ell_N \Big( \log I_{ays}, \tau_{ays}^2 ;\ \log \hat{I}_{ays} \Big)\]

where \(\ell_N\) is the normal log-likelihood function and \(w^{(c)}_{ay}\) and \(w^{(s)}_{ays}\) are optional weights for the catch and index observations, respectively. The total log-likelihood is then

\[\ell = \ell_C + \ell_I\]

\hypertarget{the-population-dynamics-model}{%
\subsection{The population dynamics model}\label{the-population-dynamics-model}}

To predict catches and survey indices, the model uses the standard population dynamics model

\[N_{a+1,y+1} = N_{ay} \exp \left( - F_{ay} - M_{ay} \right)\]

where \(N_{ay}\) is the number of individuals at age \(a\) in year \(y\), \(F_{ay}\) is the fishing mortality at age \(a\) in year \(y\), and \(M_{ay}\) is the natural mortality at age \(a\) in year \(y\). Any fish that survived beyond the oldest age \(A\) in the model are accumulated in the oldest age group and are assumed to be fished at a common rate \(F_{A,y}\).


The numbers \(N_{a,y}\) are initiated in the first year, \(y=1\) and at the youngest age, \(a=1\), and the matrix of numbers at age are filled in according to the population dynamics model stated above.

\includegraphics{figure/sca_matrix.png}

Defining \(R_y = N_{1,y}\), the numbers at age can be written (ignoring the plus group) as:

Catches in numbers by age and year are defined in terms of the three quantities: natural mortality, fishing mortality and recruitment; using a modified form of the well known Baranov catch equation:

\[C_{ay} = \frac{F_{ay}}{F_{ay}+M_{ay}}\left(1 - e^{-(F_{ay}+M_{ay})}\right) R_{y}e^{-\sum (F_{ay} + M_{ay})} \]

Survey indices by age and year are defined in terms of the same three quantities with the addition of survey catchability:

\[I_{ays} = Q_{ays} R_{y}e^{-\sum (F_{ay} + M_{ay})}\]

Observed catches and observed survey indices are assumed to be log-normally distributed, or equivalently, normally distributed on the log-scale, with specific observation variance:

\[ \log \hat{C}_{ay} \sim \text{Normal} \Big( \log C_{ay}, \sigma^2_{ay}\Big) \]
\[ \log \hat{I}_{ays} \sim \text{Normal} \Big( \log I_{ays}, \tau^2_{ays} \Big) \]

The log-likelihood can now be defined as the sum of the log-likelihood of the observed catches:

\[  \ell_C = \sum_{ay} w^{(c)}_{ay}\ \ell_N \Big( \log C_{ay}, \sigma^2_{ay} ;\ \log \hat{C}_{ay} \Big) \]

and the log-likelihood of the observed survey indices as:

\[  \ell_I = \sum_s \sum_{ay} w^{(s)}_{ays}\ \ell_N \Big( \log I_{ays}, \tau_{ays}^2 ;\ \log \hat{I}_{ays} \Big)\]

giving the total log-likelihood

\[\ell = \ell_C + \ell_I\]

which is defined in terms of the strictly positive quantites, \(M_{ay}\), \(F_{ay}\), \(Q_{ays}\) and \(R_{y}\), and the observation variances \(\sigma_{ay}\) and \(\tau_{ays}\). As such, the log-likelihood is over-parameterised as there are many more parameters than observations. In order to reduce the number of parameters, \(M_{ay}\) is assumed known (as is common).

\%====================================================================
\%THE FOLLOWING NEEDS REVISION, need to bring in N1 submod
\%====================================================================

The remaining parameters are written in terms of a linear combination of covariates \(x_{ayk}\), e.g.

\[\log F_{ay} = \sum_k \beta_k x_{ayk}\]

where \(k\) is the number of parameters to be estimated and is sufficiently small. Using this tecnique the quantities \(\log F\), \(\log Q\), \(\log \sigma\) and \(\log \tau\)
\%\(\log \text{initial\,age\,structure}\) \% this is not present in the above
(in bold in the equations above) can be described by a reduced number of parameters. The following section has more discussion on the use of linear models in a4a.

\%====================================================================

The a4a statistical catch-at-age model can addionally allow for a functional relationship that links predicted recruitment \(\tilde{R}\) based on spawning stock biomass and modelled recruitment \(R\), to be imposed as a fixed variance random effect. {[}NEEDS REVISION, sentence not clear{]}

Options for the relationship are the hard coded models Ricker, Beverton Holt, smooth hockeystick or geometric mean. This is implemented by including a third component in the log-likelihood:

\[\ell_{SR} = \sum_y \ell_N \Big( \log \tilde{R}_y(a, b), \phi_y^2 ;\ \log R_y \Big)\]

giving the total log-likelihood

\[\ell = \ell_C + \ell_I + \ell_{SR}\]

Using the (time varying) Ricker model as an example, predicted recruitment is

\[\tilde{R}_y(a_y,b_y) = a_y S_{y-1} e^{-b_y S_{y-1}}\]

where \(S\) is spawning stock biomass derived from the model parameters \(F\) and \(R\), and the fixed quantites \(M\) and mean weights by year and age. It is assumed that \(R\) is log-normally distributed, or equivalently, normally distributed on the log-scale about the (log) recruitment predicted by the SR model \(\tilde{R}\), with known variance \(\phi^2\), i.e.

\[\log R_y \sim \text{Normal} \Big( \log \tilde{R}_y, \phi_y^2 \Big)\]

which leads to the definition of \(\ell_{SR}\) given above. In all cases \(a\) and \(b\) are strictly positive, and with the quantities \(F\), \(R\), etc. linear models are used to parameterise \(\log a\) and/or \(\log b\), where relevant.

\%====================================================================
\%THE FOLLOWING NEEDS REVISION, this is not just the default I guess,
\% it's always present since R predictions will be a mix of S/R and \(\gamma\)
\%====================================================================

By default, recruitment \(R\) as apposed to the reruitment predicted from a stock recruitment model \(\tilde{R}\), is specified as a linear model with a parameter for each year, i.e.

\[\log R_y = \gamma_y\]

This is to allow modelled recruitment \(R_y\) to be shrunk towards the stock recruitment model. However, if it is considered appropriate that recruitment can be determined exactly by a relationship with covariates, it is possible, to instead define \(\log R\) in terms of a linear model in the same way as \(\log F\), \(\log Q\), \(\log \sigma\) and \(\log \tau\). \%But this is pretty much the same as taking a geometric mean, with a model on log a, and making the variance very small.

\%====================================================================
\% WE NEED TO ADD SOMETHING ABOUT HOW THE PLUSGROUP IS MODELLED
\%====================================================================

\hypertarget{classes-description}{%
\section{\texorpdfstring{Classes description \label{sec:classes}}{Classes description }}\label{classes-description}}

Figure \ref{fig:sca} shows the process to fit a statistical stock assessment catch at age method.

\begin{figure}
\centering
\includegraphics{scamethod.png}
\caption{Figure: \label{fig:sca} The fit process}
\end{figure}

\begin{figure}
\centering
\includegraphics{fitclass.png}
\caption{The a4aFit class}
\end{figure}

\begin{figure}
\centering
\includegraphics{fitsamcclass.png}
\caption{The a4aFitSA and a4aFitMCMC classes. Both classes have the same structure}
\end{figure}

\hypertarget{submodel-structure}{%
\chapter{\texorpdfstring{Submodel structure \label{sec:submod}}{Submodel structure }}\label{submodel-structure}}

The \texttt{a4a} stock assessment framework allows the user to set up a large number of different models. The mechanics which provide this flexibility are designed around the concept of submodels. Each unknown variable that must be estimated is treated as a linear model, for which the user has to define the model structure using \texttt{R} formulas, including \href{http://cran.r-project.org/web/packages/mgcv/index.html}{\texttt{mgcv}} gam formulas. All submodels use the same specification process, the \texttt{R} formula interface, wich gives lot's of flexibility to explore models and combination of submodels.

There are 5 submodels in operation:

\begin{itemize}
\tightlist
\item
  a model for F-at-age (\(F_{ay}\))
\item
  a (list) of model(s) for abundance indices catchability-at-age (\(Q_{ays}\)),
\item
  a model for recruitment (\(R_y\))
\item
  a list of models for the observation variance of catch-at-age and abundance indices (\(\{\sigma^2_{ay}, \tau^2_{ays}\}\))
\item
  a model for the initial age structure \(N_{a,y=1}\),
\end{itemize}

When setting the structure of each submodel the user is in fact building the predictive model and its parameters. The optimization process, done through \texttt{ADMB}, estimates the parameters and their variance-covariance matrix, allowing further analysis to be carried out, like simulation, prediction, diagnostics, etc. All the statistical machinery will be at the user's reach.

\hypertarget{submodel-building-blocks-and-fundamental-r-formulas}{%
\section{\texorpdfstring{Submodel building blocks and fundamental \texttt{R} formulas}{Submodel building blocks and fundamental R formulas}}\label{submodel-building-blocks-and-fundamental-r-formulas}}

The elements available to build submodels formulas are `age' and `year', which can be used to build models with different structures.

In R's linear modelling language, a constant model is coded as \$ 1\$, while a slope over time would simply be \(\sim year\), a smoother over time \(\sim s(year, k=10)\), a model with a coefficient for each year would be \(\sim factor(year)\). Transformations of the variables are as usual, e.g.~\(\sim sqrt(year)\), etc; while combinations of all the above can be done although non-convergence will limit the possibilities.

Using the \(F\) submodel as example the following specifies the models described in the previous paragraph:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# models}
\NormalTok{m1 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\DecValTok{1}
\NormalTok{m2 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\NormalTok{ year}
\NormalTok{m3 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{10}\NormalTok{)}
\NormalTok{m4 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(year)}
\NormalTok{m5 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{sqrt}\NormalTok{(year)}

\CommentTok{\# fits}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m1, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m2, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit3 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m3, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit4 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m4, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit5 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m5, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}

\CommentTok{\# plot}
\NormalTok{lst }\OtherTok{\textless{}{-}} \FunctionTok{FLStocks}\NormalTok{(}\AttributeTok{constant=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit1, }\AttributeTok{linear=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit2, }\AttributeTok{smooth=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit3, }\AttributeTok{factor=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit4, }\AttributeTok{sqrt=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit5)}
\NormalTok{lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, fbar)}
\NormalTok{lgnd }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{points=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{lines=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{space=}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{)}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{year, }\AttributeTok{groups=}\NormalTok{qname, lst, }\AttributeTok{auto.key=}\NormalTok{lgnd, }\AttributeTok{type=}\StringTok{\textquotesingle{}l\textquotesingle{}}\NormalTok{, }\AttributeTok{ylab=}\StringTok{\textquotesingle{}fishing mortality\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/fund_forms-1.png}
\caption{(\#fig:fund\_forms)Example of fundamental R formulas}
\end{figure}

The models above and their combinations can be used to model both `age' and `year'. The corresponding fits for age are:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# models}
\NormalTok{m1 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\DecValTok{1}
\NormalTok{m2 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\NormalTok{ age}
\NormalTok{m3 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{3}\NormalTok{)}
\NormalTok{m4 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(age)}
\NormalTok{m5 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{sqrt}\NormalTok{(age)}

\CommentTok{\# fits}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m1, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m2, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit3 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m3, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit4 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m4, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\NormalTok{fit5 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{m5, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}

\CommentTok{\# plot}
\NormalTok{lst }\OtherTok{\textless{}{-}} \FunctionTok{FLStocks}\NormalTok{(}\AttributeTok{constant=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit1, }\AttributeTok{linear=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit2, }\AttributeTok{smooth=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit3, }\AttributeTok{factor=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit4, }\AttributeTok{sqrt=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit5)}
\NormalTok{lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{harvest}\NormalTok{(x)[,}\StringTok{\textquotesingle{}2000\textquotesingle{}}\NormalTok{])}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{groups=}\NormalTok{qname, lst, }\AttributeTok{auto.key=}\NormalTok{lgnd, }\AttributeTok{type=}\StringTok{\textquotesingle{}l\textquotesingle{}}\NormalTok{, }\AttributeTok{ylab=}\StringTok{\textquotesingle{}fishing mortality in 2000\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/fund_forms_age-1.png}
\caption{(\#fig:fund\_forms\_age)Example of fundamental R formulas}
\end{figure}

\hypertarget{the-major-effects-available-for-modelling}{%
\section{The major effects available for modelling}\label{the-major-effects-available-for-modelling}}

Although the building blocks for formulas are `age' and `year', in fact there are three effects that can be modelled for each submodel: `age', `year' and `cohort'. As examples note the following models for fishing mortality.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# the age effect}
\NormalTok{ageeffect }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(age)}

\CommentTok{\# the year effect}
\NormalTok{yeareffect }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(year)}

\CommentTok{\# the cohort}
\NormalTok{cohorteffect }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(year}\SpecialCharTok{{-}}\NormalTok{age)}

\CommentTok{\# the fits}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{yeareffect)}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{ageeffect)}
\NormalTok{fit3 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{cohorteffect)}
\end{Highlighting}
\end{Shaded}

and the graphical representation of the three models in Figures \ref{fig:majeffy} to \ref{fig:majeffc}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit1), }\AttributeTok{main=}\StringTok{\textquotesingle{}year effect\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/majeffy-1.png}
\caption{\label{fig:majeffy}Major effects: the year effect (\textasciitilde{} factor(year))}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit2), }\AttributeTok{main=}\StringTok{\textquotesingle{}age effect\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/majeffa-1.png}
\caption{\label{fig:majeffa}Major effects: the age effect (\textasciitilde{} factor(age))}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit3), }\AttributeTok{main=}\StringTok{\textquotesingle{}cohort effect\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/majeffc-1.png}
\caption{\label{fig:majeffc}Major effects: the cohort effect (\textasciitilde{} factor(year-age))}
\end{figure}

\hypertarget{the-submodel-class-and-methods}{%
\section{The submodel class and methods}\label{the-submodel-class-and-methods}}

\%====================================================================
\% COLIN TO CHECK THE SECTION
\%====================================================================

Although the specification of each submodel is done through a R formula, internally the \texttt{a4a} sca fit creates an object (of class `submodel') which stores more information and allows a wide number of methods to be applied. The most important cases are prediction and simulation methods.

The submodel class is a S4 class with the following slots:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{showClass}\NormalTok{(}\StringTok{"submodel"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Class "submodel" [package "FLa4a"]
## 
## Slots:
##                                                                        
## Name:       formula coefficients         vcov    centering        distr
## Class:      formula        FLPar        array        FLPar    character
##                                                                        
## Name:          link      linkinv         name         desc        range
## Class:     function     function    character    character      numeric
## 
## Extends: "FLComp"
\end{verbatim}

Objects of class `submodel' are created in the fitting process using the formulas set by the user (or defaults if missing) and information from the fit.

For example begining with a simple \texttt{a4a} fit:

\begin{Shaded}
\begin{Highlighting}[]
 \CommentTok{\# fit a model with indices "IBTS\_Q1" and "IBTS\_Q3"}
\NormalTok{ fit0 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\FunctionTok{c}\NormalTok{(}\StringTok{"IBTS\_Q1"}\NormalTok{, }\StringTok{"IBTS\_Q3"}\NormalTok{)],}
             \AttributeTok{fmodel =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{5}\NormalTok{),}
             \AttributeTok{qmodel =} \FunctionTok{list}\NormalTok{( }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{), }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{)),}
             \AttributeTok{srmodel =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
             \AttributeTok{n1model =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{5}\NormalTok{),}
             \AttributeTok{vmodel =} \FunctionTok{list}\NormalTok{( }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{),}
             \AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ fit0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4a model fit for: PLE 
## 
## Call:
## .local(stock = stock, indices = indices, fmodel = ..1, qmodel = ..2, 
##     srmodel = ..3, n1model = ..4, vmodel = ..5, verbose = FALSE)
## 
## Time used:
##  Pre-processing     Running a4a Post-processing           Total 
##      0.25357366      0.51151538      0.03775001      0.80283904 
## 
## Submodels:
##   fmodel: ~s(age, k = 5)
##  srmodel: ~1
##  n1model: ~s(age, k = 5)
##   qmodel:
##     IBTS_Q1: ~s(age, k = 4)
##     IBTS_Q3: ~s(age, k = 4)
##   vmodel:
##     catch:   ~1
##     IBTS_Q1: ~1
##     IBTS_Q3: ~1
\end{verbatim}

Within the sca fit object there's a collection of submodels for each component of the \texttt{a4a} stock assessment model (fishing mortality, survey catchability, stock recruitment relationship, initial population and the observation variance for catch numbers and survey indices). For readability the following example will use the fishing mortality submodel although the methods and models described can be applied to each of the 5 submodels.

The submodel can be extracted using:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ fmod }\OtherTok{\textless{}{-}} \FunctionTok{fmodel}\NormalTok{(fit0)}
\end{Highlighting}
\end{Shaded}

inside this object is a formula, the coeficients estimated by the model and their covariance matrix.

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{coef}\NormalTok{(fmod)}
 \FunctionTok{vcov}\NormalTok{(fmod)}
\end{Highlighting}
\end{Shaded}

it is also possible to get the data behind the fit and the design matrix required to get the fitted values

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{as.data.frame}\NormalTok{(fmod)}
 \FunctionTok{getX}\NormalTok{(fmod)}
\end{Highlighting}
\end{Shaded}

this makes it possble to check the fit manually like this (note that the data is centered in the model, which is addressed by adding the centering after the prediction is made, see code below):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ dat }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(fmod)}
\NormalTok{ X }\OtherTok{\textless{}{-}} \FunctionTok{getX}\NormalTok{(fmod)}
\NormalTok{ b }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(fmod)}
\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{c}\NormalTok{(X }\SpecialCharTok{\%*\%}\NormalTok{ b))}\CommentTok{\# + dat$data.centering)}

 \FunctionTok{plot}\NormalTok{(fit }\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ dat[dat}\SpecialCharTok{$}\NormalTok{year }\SpecialCharTok{==} \DecValTok{2016}\NormalTok{,],}
      \AttributeTok{ylab =} \StringTok{"Estimated fishing mortality at age"}\NormalTok{,}
      \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{fit)), }\AttributeTok{las =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

or simulate from the fit by resampling based on the variance matrix of the coefficients, which is done by simulating many coefficients (here called \texttt{bsim}).

\begin{Shaded}
\begin{Highlighting}[]
 \CommentTok{\# get the variance matrix of the coefficients and simulate}
\NormalTok{ Sigma }\OtherTok{\textless{}{-}} \FunctionTok{vcov}\NormalTok{(fmod)[,,}\DecValTok{1}\NormalTok{]}
\NormalTok{ bsim }\OtherTok{\textless{}{-}} \FunctionTok{mvrnorm}\NormalTok{(}\DecValTok{999}\NormalTok{, b, Sigma)}

\NormalTok{ fit\_sim }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(X }\SpecialCharTok{\%*\%}\NormalTok{ bsim)}
\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{ci\_lower }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(fit\_sim, }\DecValTok{1}\NormalTok{, quantile, }\AttributeTok{p =} \FloatTok{0.025}\NormalTok{)}
\NormalTok{ dat}\SpecialCharTok{$}\NormalTok{ci\_upper }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(fit\_sim, }\DecValTok{1}\NormalTok{, quantile, }\AttributeTok{p =} \FloatTok{0.975}\NormalTok{)}

 \FunctionTok{plot}\NormalTok{(fit }\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ dat[dat}\SpecialCharTok{$}\NormalTok{year }\SpecialCharTok{==} \DecValTok{2016}\NormalTok{,],}
      \AttributeTok{ylab =} \StringTok{"Estimated fishing mortality at age"}\NormalTok{,}
      \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{ci\_upper)), }\AttributeTok{las =} \DecValTok{1}\NormalTok{)}
 \FunctionTok{lines}\NormalTok{(ci\_lower }\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, }\AttributeTok{data =}\NormalTok{ dat[dat}\SpecialCharTok{$}\NormalTok{year }\SpecialCharTok{==} \DecValTok{2016}\NormalTok{,], }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
 \FunctionTok{lines}\NormalTok{(ci\_upper }\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, }\AttributeTok{data =}\NormalTok{ dat[dat}\SpecialCharTok{$}\NormalTok{year }\SpecialCharTok{==} \DecValTok{2016}\NormalTok{,], }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The above code is to show how it is possible to use an \texttt{FLa4a} submodel to predict and simulate, and not intended to be used by the user. The recomended way to predict from a submodel and make simulations is to use the \texttt{genFLQuant} function (and for finer control, there is also a \texttt{simulate} function). The above example can be done using \texttt{FLa4a} functions as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ fmod\_fit }\OtherTok{\textless{}{-}} \FunctionTok{genFLQuant}\NormalTok{(fmod)}
\NormalTok{ dat }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(fmod\_fit)}

 \FunctionTok{plot}\NormalTok{(data }\SpecialCharTok{\textasciitilde{}}\NormalTok{ age, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ dat[dat}\SpecialCharTok{$}\NormalTok{year }\SpecialCharTok{==} \DecValTok{2016}\NormalTok{,],}
      \AttributeTok{ylab =} \StringTok{"Estimated fishing mortality at age"}\NormalTok{,}
      \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(dat}\SpecialCharTok{$}\NormalTok{data)), }\AttributeTok{las =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

or using the \texttt{ggplotFL} package:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ fmod\_fit }\OtherTok{\textless{}{-}} \FunctionTok{genFLQuant}\NormalTok{(fmod)}

 \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ fmod\_fit[,}\StringTok{"2016"}\NormalTok{], }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =}\NormalTok{ data)) }\SpecialCharTok{+} 
   \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
   \FunctionTok{ylab}\NormalTok{(}\StringTok{"Estimated fishing mortality at age"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(fmod\_fit))}
\end{Highlighting}
\end{Shaded}

and the simulations and confidence intervals are easily computed:

\begin{Shaded}
\begin{Highlighting}[]
 \CommentTok{\# simulate 999 }
\NormalTok{ fmod\_fit\_sim }\OtherTok{\textless{}{-}} \FunctionTok{genFLQuant}\NormalTok{(fmod, }\AttributeTok{nsim =} \DecValTok{999}\NormalTok{)}

 \CommentTok{\# reduce to quantiles}
\NormalTok{ fmod\_fit\_sim }\OtherTok{\textless{}{-}} \FunctionTok{quantile}\NormalTok{(fmod\_fit\_sim[,}\StringTok{"2016"}\NormalTok{], }\FunctionTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.50}\NormalTok{, }\FloatTok{0.975}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

plotting can be done by converting to a data.frame, reshaping and using standard \texttt{ggplot2} functionality

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ dat }\OtherTok{\textless{}{-}} 
   \FunctionTok{reshape}\NormalTok{(}
     \FunctionTok{as.data.frame}\NormalTok{(fmod\_fit\_sim, }\AttributeTok{drop=}\ConstantTok{TRUE}\NormalTok{), }
     \AttributeTok{timevar =} \StringTok{"iter"}\NormalTok{, }\AttributeTok{idvar =} \StringTok{"age"}\NormalTok{, }\AttributeTok{direction =} \StringTok{"wide"}  
\NormalTok{   )}

 \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data=}\NormalTok{dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{data.50\%}\StringTok{\textasciigrave{}}\NormalTok{)) }\SpecialCharTok{+}
   \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{ymin =} \StringTok{\textasciigrave{}}\AttributeTok{data.2.5\%}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{ymax =} \StringTok{\textasciigrave{}}\AttributeTok{data.97.5\%}\StringTok{\textasciigrave{}}\NormalTok{), }
               \AttributeTok{fill=}\StringTok{"red"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{15}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
   \FunctionTok{ylab}\NormalTok{(}\StringTok{"Estimated fishing mortality at age"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(fmod\_fit\_sim))}
\end{Highlighting}
\end{Shaded}

\hypertarget{fitting}{%
\chapter{Fitting}\label{fitting}}

The \texttt{a4a} stock assessment framework is implemented in \texttt{R} through the method \texttt{sca()}. The method call requires as a minimum a FLStock object and a FLIndices object, in which case the default submodels will be set by the method.

Having described building blocks, basic formulations and effects available to build a submodel's model, it's important to look into specific formulations and relate them to commonly known representations. Note that although a large number of formulations are available for each submodel, the user must carefuly decide on the full stock assessment model being build and avoid over-paramerizing. Over-parametrization may lead to non-convergence, but may also end up not being very useful for prediction/forecasting, which is one of the main objectives of stock assessment.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(ple4)}
\FunctionTok{data}\NormalTok{(ple4.indices)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices)}
\NormalTok{stk }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+}\NormalTok{ fit}
\FunctionTok{plot}\NormalTok{(stk)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-38-1.png}

By calling the fitted object the default submodel formulas are printed in the console:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4a model fit for: PLE 
## 
## Call:
## .local(stock = stock, indices = indices)
## 
## Time used:
##  Pre-processing     Running a4a Post-processing           Total 
##       0.9074342      15.0384643       0.1752501      16.1211486 
## 
## Submodels:
##   fmodel: ~te(age, year, k = c(6, 30), bs = "tp") + s(age, k = 6)
##  srmodel: ~factor(year)
##  n1model: ~s(age, k = 3)
##   qmodel:
##     BTS-Isis-early:                  ~s(age, k = 6)
##     BTS-Combined (ISIS and TRIDENS): ~s(age, k = 6)
##     SNS:                             ~s(age, k = 5)
##     BTS-Combined (all):              ~s(age, k = 6)
##     IBTS_Q3:                         ~s(age, k = 6)
##     IBTS_Q1:                         ~s(age, k = 5)
##   vmodel:
##     catch:                           ~s(age, k = 3)
##     BTS-Isis-early:                  ~1
##     BTS-Combined (ISIS and TRIDENS): ~1
##     SNS:                             ~1
##     BTS-Combined (all):              ~1
##     IBTS_Q3:                         ~1
##     IBTS_Q1:                         ~1
\end{verbatim}

To set specific submodels the user has to write the relevant R formula and include it in the call. The arguments for each submodel are self-explanatory: fishing mortality is `fmodel', indices' catchability is `qmodel', stock-recruitment is `srmodel', observation variance is `vmodel' and for initial year's abundance is `n1model'. The following model comes closer to the official stock assessment of North Sea plaice, as such we'll name it \(0\) and keep it for future comparisons:

For future referencing we'll start with a base fit to be used for future comparisons, named fit 0.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod0 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{6}\NormalTok{)}\SpecialCharTok{+}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{10}\NormalTok{)}\SpecialCharTok{+}\FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k=}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{8}\NormalTok{))}
\NormalTok{qmod0 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{3}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{3}\NormalTok{)}\SpecialCharTok{+}\NormalTok{year, }\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{3}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{6}\NormalTok{))}
\NormalTok{srmod0 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{20}\NormalTok{)}
\NormalTok{vmod0 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{,  }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{n1mod0 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{3}\NormalTok{)}
\NormalTok{fit0 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmod0, }\AttributeTok{qmodel=}\NormalTok{qmod0, }\AttributeTok{srmodel=}\NormalTok{srmod0, }\AttributeTok{n1model=}\NormalTok{n1mod0, }\AttributeTok{vmodel=}\NormalTok{vmod0)}
\NormalTok{stk0 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+}\NormalTok{ fit0}
\FunctionTok{plot}\NormalTok{(stk0)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/fit0-1.png}

As before by calling the fitted object submodels' formulas are printed in the console:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## a4a model fit for: PLE 
## 
## Call:
## .local(stock = stock, indices = indices)
## 
## Time used:
##  Pre-processing     Running a4a Post-processing           Total 
##       0.9074342      15.0384643       0.1752501      16.1211486 
## 
## Submodels:
##   fmodel: ~te(age, year, k = c(6, 30), bs = "tp") + s(age, k = 6)
##  srmodel: ~factor(year)
##  n1model: ~s(age, k = 3)
##   qmodel:
##     BTS-Isis-early:                  ~s(age, k = 6)
##     BTS-Combined (ISIS and TRIDENS): ~s(age, k = 6)
##     SNS:                             ~s(age, k = 5)
##     BTS-Combined (all):              ~s(age, k = 6)
##     IBTS_Q3:                         ~s(age, k = 6)
##     IBTS_Q1:                         ~s(age, k = 5)
##   vmodel:
##     catch:                           ~s(age, k = 3)
##     BTS-Isis-early:                  ~1
##     BTS-Combined (ISIS and TRIDENS): ~1
##     SNS:                             ~1
##     BTS-Combined (all):              ~1
##     IBTS_Q3:                         ~1
##     IBTS_Q1:                         ~1
\end{verbatim}

The method \texttt{sca} has other arguments which may be set by the user:

\begin{itemize}
\tightlist
\item
  {[}covar:{]} a `FLQuant\} with covariates;
\item
  {[}wkdir:{]} a folder (character) where the \ADMB files will be saved for posterior inspection by the user;
\item
  {[}verbose:{]} be more verbose (logical);
\item
  {[}fit:{]} type of fit (character),

  \begin{itemize}
  \tightlist
  \item
    `MP' runs the minimizer without trying to invert the hessian and as such doesn't return the covariance matrix of the parameters, normally used inside \MSE loops where parameter variance may not be relevant;
  \item
    `assessment' runs minimizer and inverts hessian, returns the covariance matrix of the estimated parameters and the convergence criteria set in \ADMB;
  \item
    `MCMC' runs \ADMB's MCMC fit
  \end{itemize}
\item
  {[}center:{]} shall observations be centered before fitting (logical);
\item
  {[}mcmc:{]} \ADMB's MCMC arguments (character vector), must be paired with `fit=``MCMC''\}.
\end{itemize}

There are a set of methods for \texttt{a4a} fit objects which help manipulating \texttt{sca()} results, namely:

\begin{itemize}
\tightlist
\item
  {[}+:{]} update the stock object with the fitted fishing mortalities, population abundance and catch in numbers at age;
\end{itemize}

\hypertarget{fishing-mortality-submodel-f_ay}{%
\section{\texorpdfstring{Fishing mortality submodel (\(F_{ay}\))}{Fishing mortality submodel (F\_\{ay\})}}\label{fishing-mortality-submodel-f_ay}}

We will now take a look at some examples for \(F\) models and the forms that we can get.

A non-separable model, where we consider age and year to interact can be modeled using a smooth interaction term in the F model using a tensor product of cubic splines with the \texttt{te} method (Figure \ref{fig:te1}), again borrowed from \href{http://cran.r-project.org/web/packages/mgcv/index.html}{mgcv}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{20}\NormalTok{))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], fmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit), }\AttributeTok{zlab=}\StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/te1-1.png}
\caption{\label{fig:te1}Fishing mortality smoothed non-separable model}
\end{figure}

In the last examples the fishing mortalities (Fs') are linked across age and time. What if we want to free up a specific age class because in the residuals we see a consistent pattern. This can happen, for example, if the spatial distribution of juveniles is disconnected to the distribution of adults. The fishery focuses on the adult fish, and therefore the the F on young fish is a function of the distribution of the juveniles and could deserve a specific model. This can be achieved by adding a component for the year effect on age 1 (Figure \ref{fig:age1}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{20}\NormalTok{)) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{5}\NormalTok{, }\AttributeTok{by =} \FunctionTok{as.numeric}\NormalTok{(age}\SpecialCharTok{==}\DecValTok{1}\NormalTok{))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], fmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit), }\AttributeTok{zlab=}\StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/age1-1.png}
\caption{\label{fig:age1}Fishing mortality age-year interaction model with extra age 1 smoother.}
\end{figure}

\hypertarget{separable-model}{%
\subsection{Separable model}\label{separable-model}}

One of the most useful models for fishing mortality is one in which `age' and `year' effects are independent, that is, where the shape of the selection pattern does not change over time, but the overall level of fishing mortality do. Commonly called a `separable model'.

A full separable model in \texttt{a4a} is written using the \texttt{factor} function which converts age and year effects into categorical values, forcing a different coefficient to be estimated for each level of both effects. This model has \texttt{age\ x\ year} number of parameters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod1 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(year)}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmod1, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

One can reduce the number of parameters and add dependency along both effects, although still keeping independence of each other, by using smoothers rather than \texttt{factor}. We'll use a (unpenalised) thin plate spline provided by package \href{http://cran.r-project.org/web/packages/mgcv/}{mgcv} method \texttt{s()}. We're using the North Sea Plaice data, and since it has 10 ages we will use a simple rule of thumb that the spline should have fewer than \(\frac{10}{2} = 5\) degrees of freedom, and so we opt for 4 degrees of freedom. We will also do the same for year and model the change in \(F\) through time as a smoother with 20 degrees of freedom.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod2 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{20}\NormalTok{)}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmod2, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

An interesting extension of the separable model is the `double separable' where a third factor or smoother is added for the cohort effect.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod3 }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{20}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(year}\SpecialCharTok{{-}}\NormalTok{age), }\AttributeTok{k=}\DecValTok{10}\NormalTok{)}
\NormalTok{fit3 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmod3, }\AttributeTok{fit=}\StringTok{"MP"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: *** ~s(age, k = 4) + s(year, k = 20) + s(as.numeric(year - age),     k = 10) has 1 too many parameter(s)!!
##     i will remove the redundant ones:
##  s(as.numeric(year - age)).9
\end{verbatim}

Figures \ref{fig:sep00} and \ref{fig:sep01} depicts the three models selectivities for each year. Each separable model has a single selectivity that changes it's overall scale in each year, while the double separable introduces some variability over time by modeling the cohort factor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{factor=}\FunctionTok{harvest}\NormalTok{(fit1), }\AttributeTok{smooth=}\FunctionTok{harvest}\NormalTok{(fit2), }\AttributeTok{double=}\FunctionTok{harvest}\NormalTok{(fit3))}
\NormalTok{pset }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{strip.background=}\FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\StringTok{"gray90"}\NormalTok{))}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age}\SpecialCharTok{|}\NormalTok{qname, }\AttributeTok{groups=}\NormalTok{year, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{, }\AttributeTok{col=}\DecValTok{1}\NormalTok{, }\AttributeTok{layout=}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{), }\AttributeTok{ylab=}\StringTok{"fishing mortality"}\NormalTok{, }\AttributeTok{par.settings=}\NormalTok{pset)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/sep00-1.png}
\caption{\label{fig:sep00}Selection pattern of separable models. Each line represents the selection pattern in a specific year. Independent age and year effects (factor), internally dependent age and year (smooth), double separable (double).}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age}\SpecialCharTok{+}\NormalTok{year}\SpecialCharTok{|}\NormalTok{qname, }\AttributeTok{data=}\FunctionTok{as.data.frame}\NormalTok{(flqs), }\AttributeTok{layout=}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/sep01-1.png}
\caption{\label{fig:sep01}Fishing mortality of separable models. Independent age and year effects (factor), internally dependent age and year (smooth), double separable (double).}
\end{figure}

\hypertarget{constant-selectivity-for-contiguous-ages-or-years}{%
\subsection{Constant selectivity for contiguous ages or years}\label{constant-selectivity-for-contiguous-ages-or-years}}

To set these models we'll use the method \texttt{replace()} to define which ages or years will be modelled together with a single coefficient. The following example shows \texttt{replace()} in operation. The dependent variables used in the model will be changed and attributed the same age or year, as such during the fit observations of those age or year with will be seen as replicates. One can think of it as sharing the same mean value, which will be estimated by the model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{age }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}
\CommentTok{\# last age same as previous}
\FunctionTok{replace}\NormalTok{(age, age}\SpecialCharTok{\textgreater{}}\DecValTok{9}\NormalTok{, }\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1 2 3 4 5 6 7 8 9 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# all ages after age 6}
\FunctionTok{replace}\NormalTok{(age, age}\SpecialCharTok{\textgreater{}}\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1 2 3 4 5 6 6 6 6 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{year }\OtherTok{\textless{}{-}} \DecValTok{1950}\SpecialCharTok{:}\DecValTok{2010}
\FunctionTok{replace}\NormalTok{(year, year}\SpecialCharTok{\textgreater{}}\DecValTok{2005}\NormalTok{, }\DecValTok{2005}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1950 1951 1952 1953 1954 1955 1956 1957 1958 1959 1960 1961 1962 1963 1964
## [16] 1965 1966 1967 1968 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979
## [31] 1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992 1993 1994
## [46] 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2005 2005 2005 2005
## [61] 2005
\end{verbatim}

In the \(F\) submodel one can use this method to fix the estimation of \(F\) in the plus group to be the same as in the last non-aggregated age.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(}\FunctionTok{replace}\NormalTok{(age, age}\SpecialCharTok{\textgreater{}}\DecValTok{9}\NormalTok{, }\DecValTok{9}\NormalTok{), }\AttributeTok{k=}\DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{20}\NormalTok{)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, fmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit), }\AttributeTok{zlab=}\StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/ctsselage-1.png}
\caption{\label{fig:ctsselage}F-at-age fixed above age 9}
\end{figure}

Or estimate the average \(F\) in the most recent years, instead of averaging after the assessment to compute the \emph{statu quo} selection pattern.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(}\FunctionTok{replace}\NormalTok{(year, year}\SpecialCharTok{\textgreater{}}\DecValTok{2013}\NormalTok{, }\DecValTok{2013}\NormalTok{), }\AttributeTok{k=}\DecValTok{20}\NormalTok{)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, fmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age}\SpecialCharTok{+}\NormalTok{year, }\AttributeTok{data=}\FunctionTok{harvest}\NormalTok{(fit)[,}\FunctionTok{ac}\NormalTok{(}\DecValTok{2010}\SpecialCharTok{:}\DecValTok{2017}\NormalTok{)], }\AttributeTok{screen=}\FunctionTok{c}\NormalTok{(}\AttributeTok{z=}\SpecialCharTok{{-}}\DecValTok{130}\NormalTok{, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{x=}\SpecialCharTok{{-}}\DecValTok{60}\NormalTok{), }\AttributeTok{zlab=}\StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/ctsselyear-1.png}
\caption{\label{fig:ctsselyear}F-at-age fixed for the most recent 5 years}
\end{figure}

\hypertarget{time-blocks-selectivity}{%
\subsection{Time blocks selectivity}\label{time-blocks-selectivity}}

To define blocks of data \texttt{sca()} uses the method \texttt{breakpts()}, which creates a factor from a vector with levels defined by the second argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{year }\OtherTok{\textless{}{-}} \DecValTok{1950}\SpecialCharTok{:}\DecValTok{2010}
\CommentTok{\# two levels separated in 2000}
\FunctionTok{breakpts}\NormalTok{(year, }\DecValTok{2000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
##  [7] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [13] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [19] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [25] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [31] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [37] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [43] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [49] (1949,2000] (1949,2000] (1949,2000] (2000,2010] (2000,2010] (2000,2010]
## [55] (2000,2010] (2000,2010] (2000,2010] (2000,2010] (2000,2010] (2000,2010]
## [61] (2000,2010]
## Levels: (1949,2000] (2000,2010]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# five periods with equal interval}
\FunctionTok{breakpts}\NormalTok{(year, }\FunctionTok{seq}\NormalTok{(}\DecValTok{1949}\NormalTok{, }\DecValTok{2010}\NormalTok{, }\AttributeTok{length=}\DecValTok{6}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
##  [5] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
##  [9] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
## [13] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [17] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [21] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [25] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [29] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [33] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [37] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [41] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [45] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [49] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [53] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [57] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [61] (1997.8,2010]  
## 5 Levels: (1949,1961.2] (1961.2,1973.4] (1973.4,1985.6] ... (1997.8,2010]
\end{verbatim}

Note \texttt{seq()} computes `left-open' intervals, which means that to include 1950 the sequence must start one year earlier.

These methods can be used to create discrete time series, for which a different selection pattern is allowed in each block. This is called an interaction in statistical modelling parlance, and typically a \texttt{*} denotes an interaction term; for smoothers an interaction is achieved using the \texttt{by} argument. When this argument is a \texttt{factor} a replicate of the smooth is produced for each factor level.

In the next case we'll use the \texttt{breakpts()} to split the time series at 1990, although keeping the same shape in both periods, a thin plate spline with 3 knots (Figure \ref{fig:brk}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{3}\NormalTok{, }\AttributeTok{by =} \FunctionTok{breakpts}\NormalTok{(year, }\DecValTok{1990}\NormalTok{))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, fmod)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/brk-1.png}
\caption{\label{fig:brk}F-at-age in two periods using in both cases a thin plate spline with 3 knots}
\end{figure}

\hypertarget{time-changing-selectivity}{%
\subsection{Time changing selectivity}\label{time-changing-selectivity}}

In many cases, it may be desirable to allow the selection pattern to evolve over time, from year to year. Again there are several ways to do this, one way is to estimate a mean selection pattern, while also allowing F to vary over time for each age. This is like a seperate smoother over year, with `age blocks' so, looking back at previous examples, we have:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmodel }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{15}\NormalTok{, }\AttributeTok{by =} \FunctionTok{factor}\NormalTok{(age)) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

This is a type of interaction between age and year, but the only connection (or correlation) across ages is via the smoother on age, however there are still 15 degrees of freedom for each age, so the model 5 x 15 + 4 = 69 degrees of freedom. To include correlation across ages and years together then the tensor product (\texttt{te()} function) is used, this has the effect of restricting the flexibility of the model for F. In the following, there is a smoother in 2 dimensions (age and year) where there is 5 degrees of freedom in the age direction, and 15 in the year dimension, resulting in a total of 5 x 15 = 65 degrees of freedom

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmodel }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Often the above formulations provide too much flexibility, and a more complicated, but simpler model is preferable:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmodel }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{15}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{te}\NormalTok{(age, year, }\AttributeTok{k =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

in the above model, the main effects for age and year still have similar flexibility to the full tensor model, however, the interaction (or the change in F at age over time) has been restricted, so that the full model now has 4 + 15 + 3 x 5 = 34 degrees of freedom.

\hypertarget{closed-form-selection-pattern}{%
\subsection{Closed form selection pattern}\label{closed-form-selection-pattern}}

One can use a closed form for the selection pattern. The only requirement is to be able to write it as a \R formula, the example below uses a logistic form.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{I}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1}\SpecialCharTok{+}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{age)))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, fmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit), }\AttributeTok{zlab=}\StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/logistic-1.png}
\caption{\label{fig:logistic}F-at-age logistic}
\end{figure}

\hypertarget{more-models-to-be-moved-to-its-own-section}{%
\subsection{More models {[}TO BE MOVED TO ITS OWN SECTION?{]}}\label{more-models-to-be-moved-to-its-own-section}}

More complicated models can be built with these tools. For example, Figure \ref{fig:ageind} shows a model where the age effect is modelled as a smoother (the same thin plate spline) throughout years but independent from each other.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{10}\NormalTok{, }\AttributeTok{by =} \FunctionTok{breakpts}\NormalTok{(age, }\FunctionTok{c}\NormalTok{(}\DecValTok{2}\SpecialCharTok{:}\DecValTok{8}\NormalTok{)))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, fmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{harvest}\NormalTok{(fit), }\AttributeTok{zlab=}\StringTok{"F"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/ageind-1.png}
\caption{\label{fig:ageind}F-at-age as thin plate spline with 3 knots for each age}
\end{figure}

A quite complex model that implements a cohort effect can be set through the following formula. Figure \ref{fig:coh} shows the resulting fishing mortality. Note that in this case we end up with a variable F pattern over time, but rather than using 4 * 10 = 40 parameters, it uses, 4 + 10 + 10 = 24.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fmodel }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(}\FunctionTok{pmax}\NormalTok{(year }\SpecialCharTok{{-}}\NormalTok{ age, }\DecValTok{1957}\NormalTok{), }\AttributeTok{k =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{10}\NormalTok{)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmodel)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/coh-1.png}
\caption{\label{fig:coh}F-at-age with a cohort effect.}
\end{figure}

\hypertarget{abundance-indices-catchability-submodel-q_ays}{%
\section{\texorpdfstring{Abundance indices catchability submodel (\(Q_{ays}\))}{Abundance indices catchability submodel (Q\_\{ays\})}}\label{abundance-indices-catchability-submodel-q_ays}}

The catchability submodel is set up the same way as the \(F\) submodel and the tools available are the same. The only difference is that the submodel is set up as a list of formulas, where each formula relates with one abundance index. There's no limitation in the number of indices or type that can be used for a fit. It's the analyst that has to decide based on her/his expertise and knowledge of the stock and fleet dynamics.

\hypertarget{catchability-submodel-for-age-based-indices}{%
\subsection{Catchability submodel for age based indices}\label{catchability-submodel-for-age-based-indices}}

A first model is simply a dummy effect on age, which means that a coefficient will be estimated for each age. Note that this kind of model considers that levels of the factor are independent (Figure \ref{fig:dummyage}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qmod }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{qmodel=}\NormalTok{qmod)}
\NormalTok{qhat }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit)}\SpecialCharTok{$}\NormalTok{qmodel[[}\DecValTok{1}\NormalTok{]]}
\FunctionTok{wireframe}\NormalTok{(qhat, }\AttributeTok{zlab=}\StringTok{"q"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/dummyage-1.png}
\caption{\label{fig:dummyage}Catchability age independent model}
\end{figure}

If one considers catchability at a specific age to be dependent on catchability on the other ages, similar to a selectivity modelling approach, one option is to use a smoother at age, and let the data `speak' regarding the shape (Figure \ref{fig:smoothage}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qmod }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{qmodel=}\NormalTok{qmod)}
\NormalTok{qhat }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit)}\SpecialCharTok{$}\NormalTok{qmodel[[}\DecValTok{1}\NormalTok{]]}
\FunctionTok{wireframe}\NormalTok{(qhat, }\AttributeTok{zlab=}\StringTok{"q"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/smoothage-1.png}
\caption{\label{fig:smoothage}Catchability smoother age model}
\end{figure}

Finally, one may want to investigate a trend in catchability with time, very common in indices built from CPUE data. In the example given here we'll use a linear trend in time, set up by a simple linear model (Figure \ref{fig:qtrend}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qmod }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{( }\SpecialCharTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{) }\SpecialCharTok{+}\NormalTok{ year)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{qmodel=}\NormalTok{qmod)}
\NormalTok{qhat }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit)}\SpecialCharTok{$}\NormalTok{qmodel[[}\DecValTok{1}\NormalTok{]]}
\FunctionTok{wireframe}\NormalTok{(qhat, }\AttributeTok{zlab=}\StringTok{"q"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/qtrend-1.png}
\caption{\label{fig:qtrend}Catchability with a linear trend in year}
\end{figure}

\hypertarget{catchability-submodel-for-age-aggregated-biomass-indices}{%
\subsection{Catchability submodel for age aggregated biomass indices}\label{catchability-submodel-for-age-aggregated-biomass-indices}}

The previous section was focused on age disaggregated indices, but age aggregated indices (CPUE, biomass, DEPM, etc) may also be used to tune the total biomass of the population. In these cases a different class for the index must be used, the \texttt{FLIndexBiomass}, which uses a vector \texttt{index} with the age dimension called `all'. Note that in this case the qmodel should be set without age factors, although it can have a `year' component and covariates if needed. An interesting feature with biomass indices is the age range they refer to can be specified.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# simulating a biomass index (note the name of the first dimension element) using }
\CommentTok{\# the ple4 biomass and an arbritary catchability of 0.001 plus a lognormal error.}
\NormalTok{dnms }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{age=}\StringTok{"all"}\NormalTok{, }\AttributeTok{year=}\FunctionTok{range}\NormalTok{(ple4)[}\StringTok{"minyear"}\NormalTok{]}\SpecialCharTok{:}\FunctionTok{range}\NormalTok{(ple4)[}\StringTok{"maxyear"}\NormalTok{])}
\NormalTok{bioidx }\OtherTok{\textless{}{-}} \FunctionTok{FLIndexBiomass}\NormalTok{(}\FunctionTok{FLQuant}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{dimnames=}\NormalTok{dnms))}
\FunctionTok{index}\NormalTok{(bioidx) }\OtherTok{\textless{}{-}} \FunctionTok{stock}\NormalTok{(ple4)}\SpecialCharTok{*}\FloatTok{0.001}
\FunctionTok{index}\NormalTok{(bioidx) }\OtherTok{\textless{}{-}} \FunctionTok{index}\NormalTok{(bioidx)}\SpecialCharTok{*}\FunctionTok{exp}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\FunctionTok{index}\NormalTok{(bioidx), }\AttributeTok{sd=}\FloatTok{0.1}\NormalTok{))}
\FunctionTok{range}\NormalTok{(bioidx)[}\FunctionTok{c}\NormalTok{(}\StringTok{"startf"}\NormalTok{,}\StringTok{"endf"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)}
\CommentTok{\# note the name of the first dimension element}
\FunctionTok{index}\NormalTok{(bioidx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##      year
## age   1957 1958 1959 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 1970
##   all 464  454  502  566  556  525  496  528  571  652  524  497  528  413 
##      year
## age   1971 1972 1973 1974 1975 1976 1977 1978 1979 1980 1981 1982 1983 1984
##   all 471  430  402  371  473  495  410  476  445  444  375  496  536  558 
##      year
## age   1985 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1996 1997 1998
##   all 512  925  889  767  745  466  510  392  397  253  309  270  347  334 
##      year
## age   1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012
##   all 379  345  405  381  380  450  353  505  408  521  555  820  819  912 
##      year
## age   2013 2014 2015 2016 2017
##   all 816  998  909  861  953 
## 
## units:  t
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# fitting the model}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, }\FunctionTok{FLIndices}\NormalTok{(bioidx), }\AttributeTok{qmodel=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

To estimate a constant selectivity over time one used the model \(\sim 1\). As a matter of fact the estimate value, \ensuremath{9.8\times 10^{-4}}, is not very far from the simulated one, 0.001.

An example where the biomass index refers only to age 2 to 4 (for example a CPUE that targets these particular ages).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# creating the index}
\NormalTok{dnms }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{age=}\StringTok{"all"}\NormalTok{, }\AttributeTok{year=}\FunctionTok{range}\NormalTok{(ple4)[}\StringTok{"minyear"}\NormalTok{]}\SpecialCharTok{:}\FunctionTok{range}\NormalTok{(ple4)[}\StringTok{"maxyear"}\NormalTok{])}
\NormalTok{bioidx }\OtherTok{\textless{}{-}} \FunctionTok{FLIndexBiomass}\NormalTok{(}\FunctionTok{FLQuant}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{dimnames=}\NormalTok{dnms))}
\CommentTok{\# but now use only ages 2:4}
\FunctionTok{index}\NormalTok{(bioidx) }\OtherTok{\textless{}{-}} \FunctionTok{tsb}\NormalTok{(ple4[}\FunctionTok{ac}\NormalTok{(}\DecValTok{2}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)])}\SpecialCharTok{*}\FloatTok{0.001}
\FunctionTok{index}\NormalTok{(bioidx) }\OtherTok{\textless{}{-}} \FunctionTok{index}\NormalTok{(bioidx)}\SpecialCharTok{*}\FunctionTok{exp}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(}\FunctionTok{index}\NormalTok{(bioidx), }\AttributeTok{sd=}\FloatTok{0.1}\NormalTok{))}
\FunctionTok{range}\NormalTok{(bioidx)[}\FunctionTok{c}\NormalTok{(}\StringTok{"startf"}\NormalTok{,}\StringTok{"endf"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)}
\CommentTok{\# to pass this information to the model one needs to specify an age range}
\FunctionTok{range}\NormalTok{(bioidx)[}\FunctionTok{c}\NormalTok{(}\StringTok{"min"}\NormalTok{,}\StringTok{"max"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)}
\CommentTok{\# fitting the model}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, }\FunctionTok{FLIndices}\NormalTok{(bioidx), }\AttributeTok{qmodel=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Once more the estimate value, 0.00103, is not very far from the simulated one, 0.001.

\hypertarget{catchability-submodel-for-single-age-indices}{%
\subsection{Catchability submodel for single age indices}\label{catchability-submodel-for-single-age-indices}}

Similar to age aggregated indices one may have an index that relates only to one age, like a recruitment index. In this case the `FLIndex\} object must have in the first dimension the age it referes to. The fit is then done relating the index with the proper age in numbers. Note that in this case the qmodel should be set without age factors, although it can have a `year' component and covariates if needed.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{idx }\OtherTok{\textless{}{-}}\NormalTok{ ple4.indices[[}\DecValTok{1}\NormalTok{]][}\DecValTok{1}\NormalTok{]}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, }\FunctionTok{FLIndices}\NormalTok{(}\AttributeTok{recidx=}\NormalTok{idx), }\AttributeTok{qmodel=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{))}
\CommentTok{\# the estimated catchability is}
\FunctionTok{predict}\NormalTok{(fit)}\SpecialCharTok{$}\NormalTok{qmodel[[}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLQuant"
## , , unit = unique, season = all, area = unique
## 
##    year
## age 1985     1986     1987     1988     1989     1990     1991     1992    
##   1 0.000302 0.000302 0.000302 0.000302 0.000302 0.000302 0.000302 0.000302
##    year
## age 1993     1994     1995    
##   1 0.000302 0.000302 0.000302
## 
## units:
\end{verbatim}

\hypertarget{stock-recruitment-submodel-r_y}{%
\section{\texorpdfstring{Stock-recruitment submodel (\(R_y\))}{Stock-recruitment submodel (R\_y)}}\label{stock-recruitment-submodel-r_y}}

The S/R submodel is a special case, in the sense that it can be set up with the same linear tools as the \(F\) and \(Q\) models, but it can also use some hard coded models. The example shows how to set up a simple dummy model with \texttt{factor()}, a smooth model with \texttt{s()}, a Ricker model (\texttt{ricker()}), a Beverton and Holt model (\texttt{bevholt()}), a hockey stick model (\texttt{hockey()}), and a geometric mean model (\texttt{geomean()}). See Figure \ref{fig:srmod} for results. As mentioned before, the `structural' models have a fixed variance, which must be set by defining the coefficient of variation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(year)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{10}\NormalTok{)}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{ricker}\NormalTok{(}\AttributeTok{CV=}\FloatTok{0.05}\NormalTok{)}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{bevholt}\NormalTok{(}\AttributeTok{CV=}\FloatTok{0.05}\NormalTok{)}
\NormalTok{fit3 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{hockey}\NormalTok{(}\AttributeTok{CV=}\FloatTok{0.05}\NormalTok{)}
\NormalTok{fit4 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{geomean}\NormalTok{(}\AttributeTok{CV=}\FloatTok{0.05}\NormalTok{)}
\NormalTok{fit5 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{factor=}\FunctionTok{stock.n}\NormalTok{(fit)[}\DecValTok{1}\NormalTok{], }\AttributeTok{smother=}\FunctionTok{stock.n}\NormalTok{(fit1)[}\DecValTok{1}\NormalTok{], }\AttributeTok{ricker=}\FunctionTok{stock.n}\NormalTok{(fit2)[}\DecValTok{1}\NormalTok{], }\AttributeTok{bevholt=}\FunctionTok{stock.n}\NormalTok{(fit3)[}\DecValTok{1}\NormalTok{], }\AttributeTok{hockey=}\FunctionTok{stock.n}\NormalTok{(fit4)[}\DecValTok{1}\NormalTok{], }\AttributeTok{geomean=}\FunctionTok{stock.n}\NormalTok{(fit5)[}\DecValTok{1}\NormalTok{])}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{year, }\AttributeTok{groups=}\NormalTok{qname, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{, }\AttributeTok{auto.key=}\FunctionTok{list}\NormalTok{(}\AttributeTok{points=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{lines=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{columns=}\DecValTok{3}\NormalTok{), }\AttributeTok{ylab=}\StringTok{"No. recruits"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/srmod-1.png}
\caption{\label{fig:srmod}Stock-recruitment models fits}
\end{figure}

\hypertarget{observation-variance-submodel-sigma2_ay-tau2_ays}{%
\section{\texorpdfstring{Observation variance submodel (\(\{\sigma^2_{ay}, \tau^2_{ays}\}\))}{Observation variance submodel (\textbackslash\{\textbackslash sigma\^{}2\_\{ay\}, \textbackslash tau\^{}2\_\{ays\}\textbackslash\})}}\label{observation-variance-submodel-sigma2_ay-tau2_ays}}

The variance model allows the user to set up the shape of the observation variances \(\sigma^2_{ay}\) and \(\tau^2_{ays}\). This is an important subject related with fisheries data used for input to stock assessment models.

The defaults assume a U-shape model for catch-at-age and constant variance for abundance indices. The first relies on the fact that it's common to have more precision on the most represented ages and less precision on the less frequent ages which tend to be the younger and older individuals. These sizes are less caught by the fleets and as such do not appear as often at the auction markets samples. With regards to the abundance indices, one assumes a scientific survey to have a well designed sampling scheme and protocols which keep observation error at similar levels across ages.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vmod }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{3}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{vmodel=}\NormalTok{vmod)}
\NormalTok{vmod }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{3}\NormalTok{), }\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{3}\NormalTok{))}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{vmodel=}\NormalTok{vmod)}
\end{Highlighting}
\end{Shaded}

Variance estimated for the constant model is 0.476 while for the U-shape model, fitted with a smoother, changes with ages (Figure \ref{fig:vmod}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wireframe}\NormalTok{(}\FunctionTok{predict}\NormalTok{(fit2)}\SpecialCharTok{$}\NormalTok{vmodel[[}\DecValTok{2}\NormalTok{]], }\AttributeTok{zlab=}\StringTok{"variance"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/vmod-1.png}
\caption{\label{fig:vmod}Abundance index observation variance estimate}
\end{figure}

Observation variance options have an impact in the final estimates of population abundance, which can be seen in Figure \ref{fig:vmodimpact}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{smother=}\FunctionTok{stock.n}\NormalTok{(fit1), }\AttributeTok{factor=}\FunctionTok{stock.n}\NormalTok{(fit2))}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{year}\SpecialCharTok{|}\NormalTok{age, }\AttributeTok{groups=}\NormalTok{qname, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{,}
       \AttributeTok{scales=}\FunctionTok{list}\NormalTok{(}\AttributeTok{y=}\FunctionTok{list}\NormalTok{(}\AttributeTok{relation=}\StringTok{"free"}\NormalTok{, }\AttributeTok{draw=}\ConstantTok{FALSE}\NormalTok{)),}
       \AttributeTok{auto.key=}\FunctionTok{list}\NormalTok{(}\AttributeTok{points=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{lines=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{columns=}\DecValTok{2}\NormalTok{),}
       \AttributeTok{par.settings=}\FunctionTok{list}\NormalTok{(}\AttributeTok{superpose.line=}\FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\FunctionTok{c}\NormalTok{(}\StringTok{"gray35"}\NormalTok{, }\StringTok{"black"}\NormalTok{)),}
       \AttributeTok{strip.background=}\FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\StringTok{"gray90"}\NormalTok{)), }\AttributeTok{ylab=}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/vmodimpact-1.png}
\caption{\label{fig:vmodimpact}Population estimates using two different variance models}
\end{figure}

\hypertarget{initial-year-abundance-submodel-n_ay1}{%
\section{\texorpdfstring{Initial year abundance submodel (\(N_{a,y=1}\))}{Initial year abundance submodel (N\_\{a,y=1\})}}\label{initial-year-abundance-submodel-n_ay1}}

The submodel for the stock number at age in the first year of the time series is set up with the usual modelling tools (Figure \ref{fig:ny1}). Beare in mind that the year effect does not make sense here since it refers to a single year, the first in the time series of data available. This model has its influence limited to the initial lower triangle of the population matrix, which in assessments with long time series doesn't make much difference. Nevertheless, when modelling stocks with short time series in relation to the number of ages present, it becomes more important and should be given proper attention.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n1mod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{3}\NormalTok{)}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmod0, }\AttributeTok{qmodel=}\NormalTok{qmod0, }\AttributeTok{srmodel=}\NormalTok{srmod0, }\AttributeTok{vmodel=}\NormalTok{vmod0, }\AttributeTok{n1model=}\NormalTok{n1mod)}
\NormalTok{n1mod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age)}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{fmodel=}\NormalTok{fmod0, }\AttributeTok{qmodel=}\NormalTok{qmod0, }\AttributeTok{srmodel=}\NormalTok{srmod0, }\AttributeTok{vmodel=}\NormalTok{vmod0, }\AttributeTok{n1model=}\NormalTok{n1mod)}
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{smother=}\FunctionTok{stock.n}\NormalTok{(fit1)[,}\DecValTok{1}\NormalTok{], }\AttributeTok{factor=}\FunctionTok{stock.n}\NormalTok{(fit2)[,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pset }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{superpose.line=}\FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\FunctionTok{c}\NormalTok{(}\StringTok{"gray50"}\NormalTok{, }\StringTok{"black"}\NormalTok{), }\AttributeTok{lty=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)))}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{groups=}\NormalTok{qname, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{, }\AttributeTok{auto.key=}\NormalTok{lgnd, }\AttributeTok{par.settings=}\NormalTok{pset, }\AttributeTok{ylab=}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/ny1-1.png}
\caption{\label{fig:ny1}Nay=1 models}
\end{figure}

The impact in the overall perspective of the stock status is depicted in Figure \ref{fig:n1modimpact}. As time goes by the effect of this model vanishes and the fits become similar.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{smother=}\FunctionTok{stock.n}\NormalTok{(fit1), }\AttributeTok{factor=}\FunctionTok{stock.n}\NormalTok{(fit2))}
\NormalTok{pset}\SpecialCharTok{$}\NormalTok{strip.background }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\StringTok{"gray90"}\NormalTok{)}
\NormalTok{scl }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{y=}\FunctionTok{list}\NormalTok{(}\AttributeTok{relation=}\StringTok{"free"}\NormalTok{, }\AttributeTok{draw=}\ConstantTok{FALSE}\NormalTok{))}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{year}\SpecialCharTok{|}\FunctionTok{factor}\NormalTok{(age), }\AttributeTok{groups=}\NormalTok{qname, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{, }\AttributeTok{scales=}\NormalTok{scl, }\AttributeTok{auto.key=}\NormalTok{lgnd, }\AttributeTok{par.settings=}\NormalTok{pset, }\AttributeTok{ylab=}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/n1modimpact-1.png}
\caption{\label{fig:n1modimpact}Population estimates using two different variance models}
\end{figure}

\hypertarget{data-weigthing}{%
\section{Data weigthing}\label{data-weigthing}}

\%====================================================================
\% COLIN TO CHECK THE SECTION
\%====================================================================

By default the likelihood components are not weighted and the contribution of each to the maximum likelihood depends on their own likelihood score. However, the user may change these weights by penalizing data points, the \(w_{ays}\) in section \ref{sec:maths}. The likelihood score of each data point will be multiplied by the normalized weights (\(\sum w_{ays} = 1\)). This is done by adding a variance matrix to the \texttt{catch.n} and \texttt{index.n} slots of the stock and index objects. The values should be given as coefficients of variation on the log scale, so that variance is \(\log{({CV}^2 + 1)}\). Figures \ref{fig:likwgt} and \ref{fig:likwgtimpact} show the results of the two fits in the population abundance and stock summary.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stk }\OtherTok{\textless{}{-}}\NormalTok{ ple4}
\NormalTok{idx }\OtherTok{\textless{}{-}}\NormalTok{ ple4.indices[}\DecValTok{1}\NormalTok{]}
\CommentTok{\# cv of observed catches}
\NormalTok{varslt }\OtherTok{\textless{}{-}} \FunctionTok{catch.n}\NormalTok{(stk)}
\NormalTok{varslt[] }\OtherTok{\textless{}{-}} \FloatTok{0.4}
\FunctionTok{catch.n}\NormalTok{(stk) }\OtherTok{\textless{}{-}} \FunctionTok{FLQuantDistr}\NormalTok{(}\FunctionTok{catch.n}\NormalTok{(stk), varslt)}
\CommentTok{\# cv of observed indices}
\NormalTok{varslt }\OtherTok{\textless{}{-}} \FunctionTok{index}\NormalTok{(idx[[}\DecValTok{1}\NormalTok{]])}
\NormalTok{varslt[] }\OtherTok{\textless{}{-}} \FloatTok{0.1}
\FunctionTok{index.var}\NormalTok{(idx[[}\DecValTok{1}\NormalTok{]]) }\OtherTok{\textless{}{-}}\NormalTok{ varslt}
\CommentTok{\# run}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, idx, }\AttributeTok{fmodel=}\NormalTok{fmod0, }\AttributeTok{qmodel=}\NormalTok{qmod0, }\AttributeTok{srmodel=}\NormalTok{srmod0, }\AttributeTok{vmodel=}\NormalTok{vmod0, }\AttributeTok{n1model=}\NormalTok{n1mod0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Note: Provided variances will be used to weight observations.
##  Weighting assumes variances are on the log scale or equivalently log(CV^2 + 1).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{nowgt=}\FunctionTok{stock.n}\NormalTok{(fit0), }\AttributeTok{extwgt=}\FunctionTok{stock.n}\NormalTok{(fit1))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{year}\SpecialCharTok{|}\FunctionTok{factor}\NormalTok{(age), }\AttributeTok{groups=}\NormalTok{qname, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{, }\AttributeTok{scales=}\NormalTok{scl, }\AttributeTok{auto.key=}\NormalTok{lgnd, }\AttributeTok{par.settings=}\NormalTok{pset, }\AttributeTok{ylab=}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/likwgt-1.png}
\caption{\label{fig:likwgt}Stock summary of distinct likelihood weightings}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flsts }\OtherTok{\textless{}{-}} \FunctionTok{FLStocks}\NormalTok{(}\AttributeTok{nowgt=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit0, }\AttributeTok{wgt=}\NormalTok{ple4 }\SpecialCharTok{+}\NormalTok{ fit1)}
\FunctionTok{plot}\NormalTok{(flsts)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/likwgtimpact-1.png}
\caption{\label{fig:likwgtimpact}Population estimates using two different variance models}
\end{figure}

Note that by using a smaller CV for the index, one is increasing the contribution of the survey and penalizing catch at age, in relative terms. The ratio between likelihood scores of both fits show this effect with catch at age increasing by 2.3 while the index increases almost 8 fold.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit0 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{fmodel=}\NormalTok{fmod0, }\AttributeTok{qmodel=}\NormalTok{qmod0, }\AttributeTok{srmodel=}\NormalTok{srmod0, }\AttributeTok{vmodel=}\NormalTok{vmod0, }\AttributeTok{n1model=}\NormalTok{n1mod0)}
\NormalTok{(}\FunctionTok{fitSumm}\NormalTok{(fit1)}\SpecialCharTok{/}\FunctionTok{fitSumm}\NormalTok{(fit0))[}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{9}\NormalTok{),]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       nlogl nlogl_comp1 nlogl_comp2 
##    5.158773    2.577961    9.762901
\end{verbatim}

\hypertarget{working-with-covariates}{%
\section{Working with covariates}\label{working-with-covariates}}

In linear model one can use covariates to explain part of the variance observed on the data that the `core' model does not explain. The same can be done in the \texttt{a4a} framework. The example below uses the North Atlantic Oscillation (NAO) index to model recruitment.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nao }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"https://www.cpc.ncep.noaa.gov/products/precip/CWlink/pna/norm.nao.monthly.b5001.current.ascii.table"}\NormalTok{, }\AttributeTok{skip=}\DecValTok{1}\NormalTok{, }\AttributeTok{fill=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings=}\StringTok{"{-}99.90"}\NormalTok{)}
\NormalTok{dnms }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{quant=}\StringTok{"nao"}\NormalTok{, }\AttributeTok{year=}\DecValTok{1950}\SpecialCharTok{:}\DecValTok{2024}\NormalTok{, }\AttributeTok{unit=}\StringTok{"unique"}\NormalTok{, }\AttributeTok{season=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{, }\AttributeTok{area=}\StringTok{"unique"}\NormalTok{)}
\NormalTok{nao }\OtherTok{\textless{}{-}} \FunctionTok{FLQuant}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(nao[,}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]), }\AttributeTok{dimnames=}\NormalTok{dnms, }\AttributeTok{units=}\StringTok{"nao"}\NormalTok{)}
\NormalTok{nao }\OtherTok{\textless{}{-}} \FunctionTok{seasonMeans}\NormalTok{(}\FunctionTok{trim}\NormalTok{(nao, }\AttributeTok{year=}\FunctionTok{dimnames}\NormalTok{(}\FunctionTok{stock.n}\NormalTok{(ple4))}\SpecialCharTok{$}\NormalTok{year))}
\end{Highlighting}
\end{Shaded}

First by simply assuming that the NAO index drives recruitment (Figure \ref{fig:naor}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\NormalTok{ nao}
\NormalTok{fit2 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{qmodel=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{)), }\AttributeTok{srmodel=}\NormalTok{srmod, }\AttributeTok{covar=}\FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{nao=}\NormalTok{nao))}
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{simple=}\FunctionTok{stock.n}\NormalTok{(fit)[}\DecValTok{1}\NormalTok{], }\AttributeTok{covar=}\FunctionTok{stock.n}\NormalTok{(fit2)[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/naor-1.png}
\caption{\label{fig:naor}Recruitment model with covariates. Using the NAO index as a recruitment index.}
\end{figure}

In a second model we're using the NAO index not to model recruitment directly but to model one of the parameters of the S/R function (Figure \ref{fig:naor2}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{ricker}\NormalTok{(}\AttributeTok{a=}\SpecialCharTok{\textasciitilde{}}\NormalTok{nao, }\AttributeTok{CV=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{fit3 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices[}\DecValTok{1}\NormalTok{], }\AttributeTok{qmodel=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k=}\DecValTok{4}\NormalTok{)), }\AttributeTok{srmodel=}\NormalTok{srmod, }\AttributeTok{covar=}\FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{nao=}\NormalTok{nao))}
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{simple=}\FunctionTok{stock.n}\NormalTok{(fit)[}\DecValTok{1}\NormalTok{], }\AttributeTok{covar=}\FunctionTok{stock.n}\NormalTok{(fit3)[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/naor2-1.png}
\caption{\label{fig:naor2}Recruitment model with covariates. Using the NAO index as a covariate for the stock-recruitment model parameters.}
\end{figure}

Note that covariates can be added to any submodel using the linear model capabilities of R.

\hypertarget{assessing-files}{%
\section{\texorpdfstring{Assessing \ADMB files}{Assessing files}}\label{assessing-files}}

The framework gives access to the files produced to run the \texttt{ADMB} fitting routine through the argument \texttt{wkdir}. When set up all the \texttt{ADMB} files will be left in the directory. Note that the \texttt{ADMB} tpl file is distributed with the \texttt{FLa4a}. One can get it from your \texttt{R} library, under the folder \texttt{myRlib/FLa4a/admb/}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{wkdir=}\StringTok{"fit1run"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{missing-observations-in-the-catch-matrix-or-index}{%
\section{Missing observations in the catch matrix or index}\label{missing-observations-in-the-catch-matrix-or-index}}

\%====================================================================
\% COLIN TO CHECK THE SECTION
\%====================================================================

How are the data interpolated etc \ldots{}

\hypertarget{diagnostics}{%
\chapter{\texorpdfstring{Diagnostics \label{sec:diagn}}{Diagnostics }}\label{diagnostics}}

There's a large number of diagnostics that can be computed for a stock assessment model, the \aFa framework implements several analysis of residuals, visualizations and statistics that can be used to evaluate the fit quality and chose across multiple fits.

\hypertarget{residuals}{%
\section{Residuals}\label{residuals}}

Residuals are a ubiquos metrics to check quality of a fit. For \texttt{sca()} fits there are out-of-the-box methods to compute in the log scale, raw residuals (aka deviances), standardized residuals and pearson residuals. A set of plots to inspect residuals and evaluate fit quality and assumptions are implemented.

Consider \(x_{ay}\) to be either a catch-at-age matrix (\(C_{ay}\)) or one abundance index (\(I_{ay}\)\footnote{For simplicity of notation we'll avoid the subscript $s$ in $I$, since we're referring to individual indices}) and \(d\) to represent residuals.

Raw residuals are compute by \(d_{ay} = \log{x_{ay}} - \log{\tilde{x}_{ay}}\) and have distribution \(N(0,\upsilon^2_{a})\). Standardized residuals will be compute with \(d^s_{ay} = \frac{d_{ay}}{\hat{\upsilon}^2_{a}}\) where \(\hat{\upsilon}^2_{a} = (n-1)^{-1} \sum_y(d_{ay})^2\). Pearson residuals scale raw residuals by the estimates of \(\sigma^2\) or \(\tau^2\), as such \(d^p_{ay} = \frac{d_{ay}}{\tilde{\upsilon}^2_{a}}\) where \(\tilde{\upsilon}^2_{a} = \tilde{\sigma}^2_{a}\) for catches, or \(\tilde{\upsilon}^2_{a} = \tilde{\tau}^2_{a}\) for each index of abundance.

The \texttt{residuals()} method will compute these residuals and generate a object which can be plotted using a set of packed methods. The argument \texttt{type} will allow the user to chose which residuals will be computed. By default the method computes standardized residuals.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices)}
\NormalTok{d\_s }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit, ple4, ple4.indices)}
\end{Highlighting}
\end{Shaded}

Figure \ref{fig:res} shows a scatterplot of standardized residuals with a smoother to guide (or mis-guide \ldots) your visual analysis. Note that the standardization should produce residuals with variance=1, which means that most residual values should be between \(\sim -2\) and \(\sim 2\).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(d\_s)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/res-1.png}
\caption{\label{fig:res}Standardized residuals for abundance indices and catch numbers (catch.n). Each panel is coded by age class, dots represent standardized residuals and lines a simple smoother.}
\end{figure}

When plotting residuals by default the auxiliar line is a smoother. However it's possible to use other type of lines by setting the argument ``auxline'' in plot. The argument can take the values used by xyplot, which are (from panel.xyplot help page) one or more of the following: ``p'', ``l'', ``h'', ``b'', ``o'', ``s'', ``S'', ``g'', ``r'', ``a'', ``smooth'', and ``spline''. If type has more than one element, an attempt is made to combine the effect of each of the components. The behaviour if any of the first five are included is similar to the effect of the corresponding type in plot: ``p'' and ``l'' stand for points and lines respectively; ``b'' and ``o'' (for `overlay') plot both; ``h'' draws vertical (or horizontal if horizontal = TRUE) line segments from the points to the origin. Types ``s'' and ``S'' are like ``l'' in the sense that they join consecutive points, but instead of being joined by a straight line, points are connected by a vertical and a horizontal segment forming a `step', with the vertical segment coming first for ``s'', and the horizontal segment coming first for ``S''. ``g'' adds a reference grid. Type ``r'' adds a linear regression line, ``smooth'' adds a loess fit, ``spline'' adds a cubic smoothing spline fit, and ``a'' draws line segments joining the average y value for each distinct x value. Figure \ref{fig:resaux} shows a regression line over the residuals instead of the loess smooother.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(d\_s, }\AttributeTok{auxline=}\StringTok{"r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/resaux-1.png}
\caption{\label{fig:resaux}Standardized residuals for abundance indices and catch numbers (catch.n). Each panel is coded by age class, dots represent standardized residuals and lines a simple smoother.}
\end{figure}

The common bubble plot (\texttt{bubble()}) are shown in Figure \ref{fig:bub}. It shows the same information as Figure \ref{fig:res} but in a multivariate perspective.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bubbles}\NormalTok{(d\_s)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/bub-1.png}
\caption{\label{fig:bub}Bubbles plot of standardized residuals for abundance indices and for catch numbers (catch.n).}
\end{figure}

Figure \ref{fig:qq} shows a quantile-quantile plot to assess how well standardized residuals match a normal distribution.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qqmath}\NormalTok{(d\_s)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/qq-1.png}
\caption{\label{fig:qq}Quantile-quantile plot of standardized residuals for abundance indices and catch numbers (catch.n). Each panel is coded by age class, dots represent standardized residuals and lines the normal distribution quantiles.}
\end{figure}

Pearson residuals can be computed and plotted the same way as standardized residuals by setting \texttt{fit=\textquotesingle{}pearson\textquotesingle{}} (Figure \ref{fig:resp}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d\_p }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit, ple4, ple4.indices, }\AttributeTok{type=}\StringTok{\textquotesingle{}pearson\textquotesingle{}}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(d\_p)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/resp-1.png}
\caption{\label{fig:resp}Pearson residuals for abundance indices and catch numbers (catch.n). Each panel is coded by age class, dots represent standardized residuals and lines a simple smoother.}
\end{figure}

Finally, the raw residuals are computed by setting \texttt{fit=\textquotesingle{}deviances\textquotesingle{}} and plotted the same way as before (Figure \ref{fig:resr}). These residuals are usefull to identify which data points are not well modelled, showing a large dispersion of the residuals and requiring more attention from the analyst.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d\_r }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit, ple4, ple4.indices, }\AttributeTok{type=}\StringTok{\textquotesingle{}deviances\textquotesingle{}}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(d\_r)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/resr-1.png}
\caption{\label{fig:resr}Raw residuals for abundance indices and catch numbers (catch.n). Each panel is coded by age class, dots represent standardized residuals and lines a simple smoother.}
\end{figure}

\hypertarget{predictive-skill}{%
\section{Predictive skill}\label{predictive-skill}}

An important feature of stock assessment model fits is the capacity to predict, since one of the most important analysis done with these fits is forecasting future fishing opportunities under pre-defined conditions. The \texttt{a4a} framework implements a visualization of the fit's predictive skill for both catch-at-age and abundance indices. These are generated by the method \texttt{plot()} with the fit object and a \texttt{FLStock} (Figure \ref{fig:selplt}) or \texttt{FLIndices} (Figure \ref{fig:idxplt}) object as arguments.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(fit, ple4)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/selplt-1.png}
\caption{\label{fig:selplt}Predict and observed catch-at-age}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(fit, ple4.indices)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/idxplt-1.png} \includegraphics{_bookdown_files/_main_files/figure-html/idxplt-2.png} \includegraphics{_bookdown_files/_main_files/figure-html/idxplt-3.png} \includegraphics{_bookdown_files/_main_files/figure-html/idxplt-4.png} \includegraphics{_bookdown_files/_main_files/figure-html/idxplt-5.png} \includegraphics{_bookdown_files/_main_files/figure-html/idxplt-6.png}

\hypertarget{aggreagted-catch-in-weight}{%
\section{Aggreagted catch in weight}\label{aggreagted-catch-in-weight}}

Although a statistical catch-at-age model assumes errors in catch-at-age and, as such, errors in the total catch in weight, there's still interest to evaluate how close the model estimates are of the observed catch in weight\footnote{Some analysts believe this is the most important diagnostic since total catch should be trusted. Needless to say we don't agree and consider reported catch in weight one of the less reliable pieces of information available for stock assessment.}. The implementation of this diagnopstics is done through the method \texttt{computeCatchDiagnostics()}, which can be visualized with \texttt{plot()} (Figure @ref(c\_d)).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c\_d }\OtherTok{\textless{}{-}} \FunctionTok{computeCatchDiagnostics}\NormalTok{(fit, ple4)}
\FunctionTok{plot}\NormalTok{(c\_d)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/catchdiag-1.png}
\caption{\label{fig:catchdiag}Diagnostics for age aggregated catch in weight}
\end{figure}

\hypertarget{fit-summary-information-and-cross-validation-metrics}{%
\section{Fit summary, information and cross-validation metrics}\label{fit-summary-information-and-cross-validation-metrics}}

To get information about the likelihood fit the method \texttt{fitSumm()} can be used to report number of parameters (\texttt{npar}), negative log-likelkihood (\texttt{nlogl}), \texttt{ADMB} maximum gradient par (\texttt{maxgrad}), number of observations (\texttt{nobs}), generalized cross validation score (\texttt{gcv}), convergence flag (\texttt{convergence}) and acceptance rate (\texttt{accrate}) relevant for MCMC fits only. The second part refers to the likelihood value for each component.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fitSumm}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              iters
##                           1
##   nopar        2.870000e+02
##   nlogl       -3.823602e+02
##   maxgrad      2.060663e-04
##   nobs         1.728000e+03
##   gcv          1.185680e-01
##   convergence  0.000000e+00
##   accrate                NA
##   nlogl_comp1 -1.058450e+03
##   nlogl_comp2  6.695020e+01
##   nlogl_comp3  5.643150e+01
##   nlogl_comp4  4.025550e+02
##   nlogl_comp5  5.836470e+01
##   nlogl_comp6  6.057810e+01
##   nlogl_comp7  3.121530e+01
\end{verbatim}

Information criteria based metrics are reported with the methods:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{AIC}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -190.7205
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{BIC}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1374.784
\end{verbatim}

\hypertarget{the-package-a4adiags}{%
\section{The package a4adiags}\label{the-package-a4adiags}}

The package \texttt{a4adiags} contains some additional diagnostics based on the \texttt{reference}. Runs test checks weather the residuals are randomly distributed. A ``run'' is a sequence of the same sign residuals. Few runs indicate a trend or a correlation in the residuals while too many runs may suggest overfitting.

The primary output of a runstest is a p-value where: a high p value \((p\leq 0.05)\) suggests that the residuals are randomly distributed, a low p value indicates a non-random pattern in the residuals.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(a4adiags)}
\FunctionTok{theme\_set}\NormalTok{(}\FunctionTok{theme\_bw}\NormalTok{())}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(mut09, mut09.idx, }\AttributeTok{fmod =} \SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{8}\NormalTok{))}
\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit, mut09, mut09.idx)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plotRunstest}\NormalTok{(fit, mut09.idx, }\AttributeTok{combine =}\NormalTok{ F) }\SpecialCharTok{+} \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{age)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/idxrunstest-1.png}
\caption{\label{fig:idxrunstest}Runstest for the abundance index}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plotRunstest}\NormalTok{(}\FunctionTok{catch.n}\NormalTok{(mut09), }\FunctionTok{catch.n}\NormalTok{(mut09 }\SpecialCharTok{+}\NormalTok{ fit), }\AttributeTok{combine =}\NormalTok{ F) }\SpecialCharTok{+} \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{age)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/catchrunstest-1.png}
\caption{\label{fig:catchrunstest}Runstest for the catch by age}
\end{figure}

Green shading indicates no evidence \((p < 0.05)\) and red shading evidence \((p >0.05)\) to reject the hypothesis of a randomly distributed time-series of residuals, respectively. The shaded (green/red) area spans three residual standard deviations to either side from zero, and the red points outside of the shading violate the `\(3\sigma\) limit' for that series.

\hypertarget{residuals-and-submodels-misspecifiction}{%
\section{Residuals and submodels misspecifiction}\label{residuals-and-submodels-misspecifiction}}

\hypertarget{the-mean-model}{%
\subsection{The ``mean'' model}\label{the-mean-model}}

To start the analysis we'll fit a ``mean'' model, where all submodels will be set to an overall average, by using the \(\sim 1\) formula. This will be our reference model to see how adding age and year effects will show up in the diagnostic tools, in particular in the residuals.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(hke1567)}
\FunctionTok{data}\NormalTok{(hke1567.idx)}
\NormalTok{fit01 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{res01 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit01, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

The common residuals plot clearly shows a trend across ages (Figure \ref{fig:meanresbyage}) for both datasets.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res01)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/meanresbyyear-1.png}
\caption{\label{fig:meanresbyyear}Mean fit residuals by year)}
\end{figure}

Which is even clearer when plotting the residuals by age across years.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res01, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/meanresbyage-1} \caption{Mean fit residuals by age)}\label{fig:meanresbyage}
\end{figure}

\hypertarget{the-age-effects}{%
\subsection{The age effects}\label{the-age-effects}}

These models will introduce age effects in the fishing mortality submodel and catchability submodel. First in the fishinf mortality submodel.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit02 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age), }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{res02 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit02, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

The residuals plot now shows catch at age residuals less stagered, reflecting the modelling of the age effect.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res02)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/fageresbyyear-1.png}
\caption{\label{fig:fageresbyyear}f age effect fit residuals by year)}
\end{figure}

The residuals plot by age shows the same outcome.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res02, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/fageresbyage-1} \caption{f age effect fit residuals by age)}\label{fig:fageresbyage}
\end{figure}

Follwed by the same addition to the catchability model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit03 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age)), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{res03 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit03, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res03)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/qageresbyyear-1.png}
\caption{\label{fig:qageresbyyear}q age effect fit residuals by year)}
\end{figure}

The residuals plot by age shows the same outcome.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res03, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/qageresbyage-1} \caption{q age effect fit residuals by age)}\label{fig:qageresbyage}
\end{figure}

Finally both effects are brought together.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit04 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age), }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age)), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{res04 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit04, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res04)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/fqageresbyyear-1.png}
\caption{\label{fig:fqageresbyyear}q age effect fit residuals by year)}
\end{figure}

The residuals plot by age shows the same outcome.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res04, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/fqageresbyage-1} \caption{q age effect fit residuals by age)}\label{fig:fqageresbyage}
\end{figure}

\hypertarget{the-fishing-mortality-year-model}{%
\subsection{The fishing mortality year model}\label{the-fishing-mortality-year-model}}

This model will introduce an year effect in the fishing mortality submodel on top of the F age effect added before.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit05 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(year), }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{)}
\NormalTok{res05 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit05, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

The residuals plot now shows catch at age residuals stagered as before. The year trends are less pronounced although, because the data doesn't have a very strong year effect, it's less clear than when modelling the age effect.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res05)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/fyearresbyyear-1.png}
\caption{\label{fig:fyearresbyyear}f year effect fit residuals by year)}
\end{figure}

The residuals plot by age shows the same outcome.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res05, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/fyearresbyage-1} \caption{f year effect fit residuals by age)}\label{fig:fyearresbyage}
\end{figure}

We can see now that the residuals show a lot less patterns than before. There's still some issues, the survey catchability seems to have an year trend. However the model is not fully specified yet, stock recruitment is modelled as constant over time, the initial population abundance is also modelled as a constant as well as the variance models.

\hypertarget{the-initial-year-population-abundance-model-aka-n1}{%
\subsection{The initial year population abundance model, aka N1}\label{the-initial-year-population-abundance-model-aka-n1}}

This model will introduce an age effect in the population abundance in the first year of the time series. This model sets the n-at-age in the first year of the time series, which is needed due to the lack of previous data to reconstruct those cohorts.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit06 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(year), }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age)), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age))}
\NormalTok{res06 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit06, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

The residuals plot now shows catch at age residuals stagered as before. The year trends are less pronounced although, because the data doesn't have a very strong year effect, it's less clear than when modelling the age effect.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res06)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/n1arresbyyear-1.png}
\caption{\label{fig:n1arresbyyear}f year effect fit residuals by year)}
\end{figure}

The residuals by age (Figure \ref{fig:n1resbyage}) the residuals' improvement in the first year of the catch at age time series (bottom left plots).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res06, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/n1resbyage-1} \caption{f year effect fit residuals by age)}\label{fig:n1resbyage}
\end{figure}

\hypertarget{the-stock-recruitment-submodel}{%
\subsection{The stock recruitment submodel}\label{the-stock-recruitment-submodel}}

In this example we'll simply add a model to allow recruitment to vary over time and we'll see how to track potential improvements in the residuals.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit07 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(year), }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age)), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(year), }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age))}
\NormalTok{res07 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit07, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

The residuals plot by year are very useful to see the effect of adding a varying stock recruitment model. The year trends present in previous models are not absent. Recruitment variability when left unmodelled was being picked up by trends in the survey catchability and catch at age. And due to the cohort dynamics underlying the catch at age model, where propagating into other ages' estimates.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res07)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/srresbyyear-1.png}
\caption{\label{fig:srresbyyear}f year effect fit residuals by year)}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res07, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/srresbyage-1} \caption{f year effect fit residuals by age)}\label{fig:srresbyage}
\end{figure}

\hypertarget{the-variance-submodel}{%
\subsection{The variance submodel}\label{the-variance-submodel}}

Finally, we're testing the variance submodel, specifically the catch at age variance model. We won't dig into the catchability variance model though. It's common to accept that a scientific survey following a well designed sampling protocol will have equal variance across ages since no preferential areas are sampled.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit10 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{10}\NormalTok{), }\AttributeTok{qmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age)), }\AttributeTok{srmod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(year, }\AttributeTok{k=}\DecValTok{10}\NormalTok{), }\AttributeTok{vmod=}\FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age), }\SpecialCharTok{\textasciitilde{}}\DecValTok{1}\NormalTok{),  }\AttributeTok{n1mod=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{factor}\NormalTok{(age))}
\NormalTok{res10 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(fit10, hke1567, hke1567.idx)}
\end{Highlighting}
\end{Shaded}

To see what's happening with the variance model one can use predict to plot the different models fitted.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{mod10=}\FunctionTok{predict}\NormalTok{(fit10)}\SpecialCharTok{$}\NormalTok{vmodel}\SpecialCharTok{$}\NormalTok{catch[,}\StringTok{"2022"}\NormalTok{], }\AttributeTok{mod07=}\FunctionTok{predict}\NormalTok{(fit07)}\SpecialCharTok{$}\NormalTok{vmodel}\SpecialCharTok{$}\NormalTok{catch[,}\StringTok{"2022"}\NormalTok{])}
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{group=}\NormalTok{qname, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{, }\AttributeTok{auto.key=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/vagepredbyage-1.png}
\caption{\label{fig:vagepredbyage}Variance models for catch at age}
\end{figure}

To see the effect these models have on the estimated quantities one can look at the variance of the estimates:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{mod10=}\FunctionTok{catch.n}\NormalTok{(hke1567}\SpecialCharTok{+}\FunctionTok{simulate}\NormalTok{(fit10, }\AttributeTok{nsim=}\DecValTok{500}\NormalTok{))[,}\StringTok{"2022"}\NormalTok{], }\AttributeTok{mod07=}\FunctionTok{catch.n}\NormalTok{(hke1567}\SpecialCharTok{+}\FunctionTok{simulate}\NormalTok{(fit07, }\AttributeTok{nsim=}\DecValTok{500}\NormalTok{))[,}\StringTok{"2022"}\NormalTok{])}
\FunctionTok{bwplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{qname}\SpecialCharTok{|}\FunctionTok{factor}\NormalTok{(age),  }\AttributeTok{data=}\FunctionTok{as.data.frame}\NormalTok{(flqs), }\AttributeTok{scales=}\StringTok{"free"}\NormalTok{, }\AttributeTok{auto.key=}\NormalTok{T)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/vage-1.png}
\caption{\label{fig:vage}Estimates of population abundance with different variance models}
\end{figure}

and the usual residuals

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res10, }\AttributeTok{auxline=}\StringTok{"r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/vageresbyyear-1.png}
\caption{\label{fig:vageresbyyear}f year effect fit residuals by year)}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(res10, }\AttributeTok{auxline=}\StringTok{"l"}\NormalTok{, }\AttributeTok{by=}\StringTok{"age"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=25cm,height=18cm,angle=90]{_bookdown_files/_main_files/figure-html/vageresbyage-1} \caption{f year effect fit residuals by age)}\label{fig:vageresbyage}
\end{figure}

\hypertarget{hindcast}{%
\chapter{Hindcast}\label{hindcast}}

alternative setups and metrics and what it means (EJ to share an initial structure)

\hypertarget{reference-points}{%
\chapter{Reference Points}\label{reference-points}}

One of the primary objectives of stock assessment is the estimation of reference points. These serve as benchmarks for evaluating the outputs of assessment models and determining the status of a fish stock. Reference points are critical for effective fisheries management, guiding decisions on sustainable exploitation.

The most common classification of stock status is bidimensional, comparing exploitation levels and biomass sizes against target reference points. This framework allows for the assessment of whether a stock is overfished or experiencing overfishing:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Exploitation Levels}: Typically represented by fishing mortality (F), overfishing occurs when F exceeds the target reference point. Conversely, if F is below the reference, the stock is considered to be sustainably fished.
\item
  \textbf{Biomass Size}: Commonly measured by spawning stock biomass (SSB), stocks are deemed overfished if the SSB falls below the reference point.
\end{enumerate}

These assessments often utilize tools like the Kobe plot, which visually represents stock status in relation to these metrics.

In addition to target reference points, \textbf{limit reference points} (LRPs) are commonly included in stock assessments. These represent thresholds that should not be crossed, as they signal a high risk of stock collapse or significant uncertainty in population dynamics. Effective management aims to maintain fishing pressure and biomass levels within safe biological limits, ensuring long-term sustainability and reducing the risk of adverse outcomes.

Advancements in stock assessment science continue to refine these reference points. For example, \textbf{Maximum Sustainable Yield (MSY)} and its proxies, such as B\(_{MSY}\) (biomass at MSY) and F\(_{MSY}\) (fishing mortality at MSY), remain widely used.

These reference points are related with the stock's productivity, which in itself is a complex interaction between recruitment, growth and mortality processes.

Recruitment is the process of input to the population, it defines the number of fish that will enter the population and are vulnerable to fishing. It encompasses the process of spawning, which depends on the reproductive potential of the individuals, and the survivability of the laervae up to entering the fishery, which mostly depends on environmental conditions. Individual growth defines the time needed for an individual to gain weight, grow in length and eventualy mature and spawn. Mortality is commonly split between mortality caused by fishing and mortality caused by natural events. Natural mortality merges together all factors by which an individual may die and are not related to fishing, for example predation from other species. These processes, recruitment, individual growth and natural mortality depend on a mix of interactions between environmental conditions and species' biology.

Fishing mortality on the other hand is mostly dependent on the human factor, it's related with the choice to fish and the way to fish. It's the outcome of the effort the fleet deploys, the selectivity of the gear used and the availability of individuals. For example, the productivity of the stock will be different if the fleet fishes in an area with lots of young fish using a small mesh size, from a fleet fishing in an area where young fish are not common and using a large mesh size.

For this section we'll be using the package \texttt{FLBRP} (REF) from the FLR family of packages.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(FLBRP)}
\FunctionTok{library}\NormalTok{(FLa4a)}
\FunctionTok{data}\NormalTok{(ple4)}
\FunctionTok{data}\NormalTok{(ple4.indices)}
\NormalTok{fit0 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices)}
\NormalTok{stk0 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+}\NormalTok{ fit0}
\end{Highlighting}
\end{Shaded}

To proceed with the computation of reference points we must start by creating an \texttt{FLBRP} object and afterwards run the fitting process with \texttt{brp()}. The FLBRP class has information on selection pattern, mass at age, and biological parameters. The information is stored in the object's slots which can be accessed with the usual commands, respectively \texttt{catch.sel()}, \texttt{discards.sel()}, \texttt{stock.wt()}, \texttt{catch.wt()}, \texttt{discards.wt()}, \texttt{m()} and \texttt{mat()}. These quantities are computed by averaging the 3 most recent years of the relevant stock object slots. In the case of selection pattern the values are scaled so that \(\bar{F}=1\) \textbf{{[}IAGO TO CHECK{]}}. \texttt{FLBRP} creates a harvest slot with 100 computations of fishing mortality at age scaled from \(\bar{F}=0\) up to \(\bar{F}=4\), which is later used in the fitting process.

A number of parameters can be set by the user to create the \texttt{FLBRP} object: fbar = seq(0, 4, length.out = 101), nyears = 3, biol.nyears = nyears, fbar.nyears = nyears, sel.nyears = fbar.nyears, na.rm = TRUE, mean = ``arithmetic''. \textbf{{[}IAGO is this somewhere we can point to instead of adding it here?{]}}

\hypertarget{yield-per-recruit-reference-points}{%
\section{Yield per recruit reference points}\label{yield-per-recruit-reference-points}}

In the case where no stock recruitment relationship exists, or was fitted, \texttt{brp()} will return yield per recruit reference points. By default it computes biomasses in the absence of fishing, also know as virgin biomass, \(F_{MAX}\), \(F_{0.1}\) and 40\% Spawning per recruit reference points.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{brp0 }\OtherTok{\textless{}{-}} \FunctionTok{FLBRP}\NormalTok{(stk0)}
\NormalTok{brp0 }\OtherTok{\textless{}{-}} \FunctionTok{brp}\NormalTok{(brp0)}
\FunctionTok{summary}\NormalTok{(brp0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLBRP"
## 
## Name:  
## Description:  
## Quant: age 
## Dims:  age   year    unit    season  area    iter
##  10  101 1   1   1   1   
## 
## Range:  min  max pgroup  minfbar maxfbar 
##  1   10  10  2   6   
## 
## 
## Model:   rec ~ a
##     params
## iter a
##    1 1
## 
## refpts:  calculated
\end{verbatim}

The selection pattern and other quantities can be depicted by calling \texttt{plot()} on the specific \texttt{FLBRP} object's slot.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age,}\AttributeTok{data=}\FunctionTok{catch.sel}\NormalTok{(brp0),}\AttributeTok{type=}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}l\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/selection pattern-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{age}\SpecialCharTok{|}\NormalTok{qname, }\AttributeTok{data=}\FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{sel=}\FunctionTok{catch.sel}\NormalTok{(brp0),}
    \AttributeTok{dsel=}\FunctionTok{discards.sel}\NormalTok{(brp0), }\AttributeTok{swt=}\FunctionTok{stock.wt}\NormalTok{(brp0),}
    \AttributeTok{cwt =}\FunctionTok{catch.wt}\NormalTok{(brp0), }\AttributeTok{mat=} \FunctionTok{mat}\NormalTok{(brp0), }\AttributeTok{m =} \FunctionTok{m}\NormalTok{(brp0)),}
    \AttributeTok{type=}\StringTok{"l"}\NormalTok{,}\AttributeTok{scale=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/relevant quantities for reference points-1.png}

To extract a table with all reference points one uses the method \texttt{refpts()}. Note in this case \(F_{msy}\) is the same as \(F_{max}\), since the assumed stock recruitment is mean recruitment.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{refpts}\NormalTok{(brp0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##         quant
## refpt    harvest  yield    rec      ssb      biomass  revenue  cost    
##   virgin 0.00e+00 0.00e+00 1.00e+00 3.42e+00 3.53e+00       NA       NA
##   msy    2.10e-01 7.08e-02 1.00e+00 9.44e-01 1.03e+00       NA       NA
##   crash  1.47e+01 6.02e-06 1.00e+00 4.38e-06 2.87e-02       NA       NA
##   f0.1   1.58e-01 6.85e-02 1.00e+00 1.28e+00 1.38e+00       NA       NA
##   fmax   2.10e-01 7.08e-02 1.00e+00 9.44e-01 1.03e+00       NA       NA
##   spr.30 1.96e-01 7.06e-02 1.00e+00 1.03e+00 1.12e+00       NA       NA
##   mey          NA       NA       NA       NA       NA       NA       NA
##         quant
## refpt    profit  
##   virgin       NA
##   msy          NA
##   crash        NA
##   f0.1         NA
##   fmax         NA
##   spr.30       NA
##   mey          NA
## units:  NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{refpts}\NormalTok{(brp0)[}\FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}msy\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}fmax\textquotesingle{}}\NormalTok{)), ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##       quant
## refpt  harvest yield  rec    ssb    biomass revenue cost   profit
##   msy  0.2099  0.0708 1.0000 0.9436 1.0349      NA      NA     NA
##   fmax 0.2099  0.0708 1.0000 0.9436 1.0349      NA      NA     NA
## units:  NA
\end{verbatim}

The depiction of the reference points with the method \texttt{plot()} shows recruitment as constant over all levels of biomass and set to \(1\).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(brp0)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/reference points-1.png}

\hypertarget{stock-recruitment-relationship-based-reference-points}{%
\section{Stock recruitment relationship based reference points}\label{stock-recruitment-relationship-based-reference-points}}

An important way to improve reference points is to include stock recruitment dynamics. Yield per recruit, as in previous section, ignores this dynamics and assumes recruitment will be the same no matter SSB's size, which is obviously wrong although in many cases due to unknown or very uncertain dynamics it's the best one can do.

The stock recruitment model must be fitted before computing reference points and the \texttt{FLSR} object has to be passed to the \texttt{FLBRP} call to create the object that \texttt{brp()} method will use. There's two ways of fitting stock recruitment models: (i) after fitting the stock assessment model by using its outputs, \texttt{SSB} and recruitment, as data to fit the model; (ii) inside the stock assessment model together with all other quantities. There's pros and cons on both approaches, we're not going to dwell on those now though.

\hypertarget{stock-recruitment-after-fitting-the-stock-assessment-model}{%
\subsection{Stock recruitment after fitting the stock assessment model}\label{stock-recruitment-after-fitting-the-stock-assessment-model}}

In the following example we'll use a Beverton and Holt stock recruitment reltionship. There are several other relationships that can be used, see \textbf{{[}IAGO CHECK THIS{]}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sr0 }\OtherTok{\textless{}{-}} \FunctionTok{as.FLSR}\NormalTok{(stk0, }\AttributeTok{model=}\NormalTok{bevholt)}
\NormalTok{sr0 }\OtherTok{\textless{}{-}} \FunctionTok{fmle}\NormalTok{(sr0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   Nelder-Mead direct search function minimizer
## function value for initial parameters = -18.229811
##   Scaled convergence tolerance is 2.71645e-07
## Stepsize computed as 138047.472012
## BUILD              3 -8.381087 -21.236493
## REFLECTION         5 -18.229811 -23.986923
## LO-REDUCTION       7 -21.236493 -23.986923
## HI-REDUCTION       9 -23.670348 -23.986923
## REFLECTION        11 -23.689833 -24.357493
## LO-REDUCTION      13 -23.986923 -24.517332
## LO-REDUCTION      15 -24.357493 -24.651322
## LO-REDUCTION      17 -24.517332 -24.735311
## LO-REDUCTION      19 -24.651322 -24.782483
## LO-REDUCTION      21 -24.735311 -24.826934
## LO-REDUCTION      23 -24.782483 -24.842111
## LO-REDUCTION      25 -24.826934 -24.866395
## HI-REDUCTION      27 -24.842111 -24.872880
## HI-REDUCTION      29 -24.866395 -24.884011
## LO-REDUCTION      31 -24.872880 -24.884011
## HI-REDUCTION      33 -24.879745 -24.884011
## EXTENSION         35 -24.882025 -24.888317
## EXTENSION         37 -24.884011 -24.897425
## EXTENSION         39 -24.888317 -24.904784
## EXTENSION         41 -24.897425 -24.937270
## EXTENSION         43 -24.904784 -24.940973
## EXTENSION         45 -24.937270 -25.043544
## LO-REDUCTION      47 -24.940973 -25.043544
## EXTENSION         49 -25.008191 -25.186152
## LO-REDUCTION      51 -25.043544 -25.186152
## EXTENSION         53 -25.161825 -25.335939
## EXTENSION         55 -25.186152 -25.540561
## LO-REDUCTION      57 -25.335939 -25.540561
## EXTENSION         59 -25.501589 -25.922665
## EXTENSION         61 -25.540561 -26.001469
## EXTENSION         63 -25.922665 -26.704604
## LO-REDUCTION      65 -26.001469 -26.704604
## LO-REDUCTION      67 -26.468110 -26.704604
## LO-REDUCTION      69 -26.695594 -26.704604
## HI-REDUCTION      71 -26.703662 -26.727696
## HI-REDUCTION      73 -26.704604 -26.729632
## HI-REDUCTION      75 -26.726736 -26.729632
## HI-REDUCTION      77 -26.727696 -26.731255
## HI-REDUCTION      79 -26.729632 -26.731255
## HI-REDUCTION      81 -26.731204 -26.731582
## HI-REDUCTION      83 -26.731255 -26.731744
## HI-REDUCTION      85 -26.731582 -26.731772
## HI-REDUCTION      87 -26.731744 -26.731820
## HI-REDUCTION      89 -26.731772 -26.731823
## HI-REDUCTION      91 -26.731820 -26.731835
## HI-REDUCTION      93 -26.731823 -26.731844
## LO-REDUCTION      95 -26.731835 -26.731844
## Exiting from Nelder Mead minimizer
##     97 function evaluations used
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(sr0)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-85-1.png}

We now need to provide the \texttt{FLSR} object, \texttt{sr0}, to the \texttt{FLBRP} call and refit the reference points.

\begin{verbatim}
## rec ~ a * ssb/(b + ssb)
## <environment: 0x5cadb696a5b8>
\end{verbatim}

\begin{verbatim}
## An object of class "FLPar"
## params
##       a       b 
## 1038832    9829 
## units:  NA
\end{verbatim}

The new reference points can now be extracted using the \texttt{refpts} method with the \texttt{FLBRP} object as the main argument, and depict the relationships with \texttt{plot()}. Note this time by setting the flag \texttt{obs} to \texttt{TRUE} the plot will include the estimates of \(SSB\) and \(R\).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{refpts}\NormalTok{(brp0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##         quant
## refpt    harvest  yield    rec      ssb      biomass  revenue  cost    
##   virgin 0.00e+00 0.00e+00 1.04e+06 3.54e+06 3.65e+06       NA       NA
##   msy    2.07e-01 7.28e+04 1.03e+06 9.87e+05 1.08e+06       NA       NA
##   crash  2.25e+00 1.11e-06 3.87e-04 3.66e-06 1.83e-05       NA       NA
##   f0.1   1.58e-01 7.06e+04 1.03e+06 1.32e+06 1.42e+06       NA       NA
##   fmax   2.10e-01 7.28e+04 1.03e+06 9.70e+05 1.06e+06       NA       NA
##   spr.30 1.96e-01 7.27e+04 1.03e+06 1.06e+06 1.15e+06       NA       NA
##   mey          NA       NA       NA       NA       NA       NA       NA
##         quant
## refpt    profit  
##   virgin       NA
##   msy          NA
##   crash        NA
##   f0.1         NA
##   fmax         NA
##   spr.30       NA
##   mey          NA
## units:  NA
\end{verbatim}

Note \(MSY\) based reference points are no longer the same as \(F_{MAX}\), and recruitment is no longer constant over all \(SSB\) levels.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(brp0, }\AttributeTok{obs=}\ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-88-1.png}

\hypertarget{stock-recruitment-during-fitting-the-stock-assessment-model}{%
\subsection{Stock recruitment during fitting the stock assessment model}\label{stock-recruitment-during-fitting-the-stock-assessment-model}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel =} \SpecialCharTok{\textasciitilde{}} \FunctionTok{bevholt}\NormalTok{(}\AttributeTok{CV =} \FloatTok{0.5}\NormalTok{))}

\NormalTok{a4aflsr }\OtherTok{\textless{}{-}} \FunctionTok{as}\NormalTok{(}\FunctionTok{stkmodel}\NormalTok{(fit1), }\StringTok{"FLSR"}\NormalTok{)}

\CommentTok{\# or}
\NormalTok{a4aflsr }\OtherTok{\textless{}{-}} \FunctionTok{as}\NormalTok{(fit1, }\StringTok{"FLSR"}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(a4aflsr, }\AttributeTok{obs =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-89-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a4abrp }\OtherTok{\textless{}{-}} \FunctionTok{FLBRP}\NormalTok{(stk0, a4aflsr)}
\end{Highlighting}
\end{Shaded}

\hypertarget{economics-reference-points}{%
\section{Economics reference points}\label{economics-reference-points}}

We can add economic data to the \texttt{FLBRP} object to calculate economic based reference points, like maximum economic yield (MEY). We need to provide information about price, variable costs and fixed costs. The first in value at age per weight of fish, the others in value per unit of fishing mortality.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# price}
\FunctionTok{price}\NormalTok{(brp0) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{),}\FunctionTok{rep}\NormalTok{(}\FloatTok{1.5}\NormalTok{,}\DecValTok{2}\NormalTok{),}\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{5}\NormalTok{))}
\FunctionTok{price}\NormalTok{(brp0)}\SpecialCharTok{@}\NormalTok{units }\OtherTok{\textless{}{-}} \StringTok{"1000 euro per ton"}

\CommentTok{\# variable costs per F }
\FunctionTok{vcost}\NormalTok{(brp0) }\OtherTok{\textless{}{-}} \DecValTok{100000}
\FunctionTok{vcost}\NormalTok{(brp0)}\SpecialCharTok{@}\NormalTok{units }\OtherTok{\textless{}{-}} \StringTok{"1000 euro per F"}

\CommentTok{\# fixed costs per F }
\FunctionTok{fcost}\NormalTok{(brp0) }\OtherTok{\textless{}{-}} \DecValTok{50000}
\FunctionTok{fcost}\NormalTok{(brp0)}\SpecialCharTok{@}\NormalTok{units }\OtherTok{\textless{}{-}} \StringTok{"1000 euro per F"}

\CommentTok{\# reference points}
\NormalTok{brp0 }\OtherTok{\textless{}{-}} \FunctionTok{brp}\NormalTok{(brp0)}
\FunctionTok{refpts}\NormalTok{(brp0)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##         quant
## refpt    harvest   yield     rec       ssb       biomass   revenue   cost     
##   virgin  0.00e+00  0.00e+00  1.04e+06  3.54e+06  3.65e+06  0.00e+00  5.00e+04
##   msy     2.07e-01  7.28e+04  1.03e+06  9.87e+05  1.08e+06  1.21e+05  7.07e+04
##   crash   2.25e+00  1.11e-06  3.87e-04  3.66e-06  1.83e-05  1.15e-06  2.75e+05
##   f0.1    1.58e-01  7.06e+04  1.03e+06  1.32e+06  1.42e+06  1.20e+05  6.58e+04
##   fmax    2.10e-01  7.28e+04  1.03e+06  9.70e+05  1.06e+06  1.21e+05  7.10e+04
##   spr.30  1.96e-01  7.27e+04  1.03e+06  1.06e+06  1.15e+06  1.22e+05  6.96e+04
##   mey     2.19e-01  7.27e+04  1.03e+06  9.22e+05  1.02e+06  1.21e+05  7.19e+04
##         quant
## refpt    profit   
##   virgin -5.00e+04
##   msy     5.07e+04
##   crash  -2.75e+05
##   f0.1    5.38e+04
##   fmax    5.03e+04
##   spr.30  5.21e+04
##   mey     4.89e+04
## units:  NA
\end{verbatim}

The reference points table is now complete with values for \texttt{revenue}, \texttt{costs} and \texttt{profit}, as well as estimtes for \(MEY\) based reference points. The point where \texttt{profits} are maximized, instead of the point where \texttt{catch} is maximized as in the case of \texttt{MSY}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(brp0)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-91-1.png}

\hypertarget{computing-user-specific-reference-points}{%
\section{Computing user specific reference points}\label{computing-user-specific-reference-points}}

There is an option to calculate user defined reference points given a target F:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{custom\_refs }\OtherTok{\textless{}{-}} \FunctionTok{FLPar}\NormalTok{(}\AttributeTok{Ftrgt1 =} \FloatTok{0.33}\NormalTok{, }\AttributeTok{Ftrgt2 =} \FloatTok{0.44}\NormalTok{)}
\NormalTok{brp1 }\OtherTok{\textless{}{-}}\NormalTok{ brp0 }\SpecialCharTok{+}\NormalTok{ custom\_refs}
\FunctionTok{refpts}\NormalTok{(brp1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##         quant
## refpt    harvest   yield     rec       ssb       biomass   revenue   cost     
##   virgin  0.00e+00  0.00e+00  1.04e+06  3.54e+06  3.65e+06  0.00e+00  5.00e+04
##   msy     2.07e-01  7.28e+04  1.03e+06  9.87e+05  1.08e+06  1.21e+05  7.07e+04
##   crash   2.25e+00  1.11e-06  3.87e-04  3.66e-06  1.83e-05  1.15e-06  2.75e+05
##   f0.1    1.58e-01  7.06e+04  1.03e+06  1.32e+06  1.42e+06  1.20e+05  6.58e+04
##   fmax    2.10e-01  7.28e+04  1.03e+06  9.70e+05  1.06e+06  1.21e+05  7.10e+04
##   spr.30  1.96e-01  7.27e+04  1.03e+06  1.06e+06  1.15e+06  1.22e+05  6.96e+04
##   mey     2.19e-01  7.27e+04  1.03e+06  9.22e+05  1.02e+06  1.21e+05  7.19e+04
##   Ftrgt1  3.30e-01  6.53e+04  1.02e+06  4.95e+05  5.80e+05  1.05e+05  8.30e+04
##   Ftrgt2  4.40e-01  5.37e+04  1.00e+06  2.81e+05  3.58e+05  8.27e+04  9.40e+04
##         quant
## refpt    profit   
##   virgin -5.00e+04
##   msy     5.07e+04
##   crash  -2.75e+05
##   f0.1    5.38e+04
##   fmax    5.03e+04
##   spr.30  5.21e+04
##   mey     4.89e+04
##   Ftrgt1  2.16e+04
##   Ftrgt2 -1.13e+04
## units:  NA
\end{verbatim}

Or create an empty FLPar with specified reference points and recalculate everything:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#brp2 \textless{}{-} FLPar(NA,dimnames=list(refpt=c("virgin","f0.1","fmax","spr.30","spr.35","spr.45"), quantity=c("harvest","yield","rec","ssb","biomass","revenue","cost","profit"), iter=1))}
\NormalTok{brp2 }\OtherTok{\textless{}{-}}\NormalTok{ brp1}

\NormalTok{brp2}\SpecialCharTok{@}\NormalTok{refpts }\OtherTok{\textless{}{-}} \FunctionTok{FLPar}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{dimnames=}\FunctionTok{list}\NormalTok{(}\AttributeTok{refpt =} \FunctionTok{c}\NormalTok{(}\StringTok{"virgin"}\NormalTok{, }\StringTok{"f0.1"}\NormalTok{, }\StringTok{"fmax"}\NormalTok{, }\StringTok{"spr.30"}\NormalTok{, }\StringTok{"spr.35"}\NormalTok{,}\StringTok{"spr.45"}\NormalTok{), }\AttributeTok{quantity=}\FunctionTok{c}\NormalTok{(}\StringTok{"harvest"}\NormalTok{, }\StringTok{"yield"}\NormalTok{, }\StringTok{"rec"}\NormalTok{, }\StringTok{"ssb"}\NormalTok{, }\StringTok{"biomass"}\NormalTok{, }\StringTok{"revenue"}\NormalTok{, }\StringTok{"cost"}\NormalTok{, }\StringTok{"profit"}\NormalTok{), }\AttributeTok{iter=}\DecValTok{1}\NormalTok{))}

\NormalTok{brp2 }\OtherTok{\textless{}{-}} \FunctionTok{brp}\NormalTok{(brp2)}
\FunctionTok{refpts}\NormalTok{(brp2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##         quantity
## refpt    harvest   yield     rec       ssb       biomass   revenue   cost     
##   virgin  0.00e+00  0.00e+00  1.04e+06  3.54e+06  3.65e+06  0.00e+00  5.00e+04
##   f0.1    1.58e-01  7.06e+04  1.03e+06  1.32e+06  1.42e+06  1.20e+05  6.58e+04
##   fmax    2.10e-01  7.28e+04  1.03e+06  9.70e+05  1.06e+06  1.21e+05  7.10e+04
##   spr.30  1.96e-01  7.27e+04  1.03e+06  1.06e+06  1.15e+06  1.22e+05  6.96e+04
##   spr.35  1.69e-01  7.16e+04  1.03e+06  1.23e+06  1.33e+06  1.21e+05  6.69e+04
##   spr.45  1.27e-01  6.64e+04  1.03e+06  1.59e+06  1.69e+06  1.13e+05  6.27e+04
##         quantity
## refpt    profit   
##   virgin -5.00e+04
##   f0.1    5.38e+04
##   fmax    5.03e+04
##   spr.30  5.21e+04
##   spr.35  5.38e+04
##   spr.45  5.07e+04
## units:  NA
\end{verbatim}

One specific case is to compute \(F_{MSY}\) ranges according to Hilborn (2010) and Rindorf (2012) ideas. For this case there's already the method \texttt{msyRanges}, which takes as argument a fitted \texttt{FLBRP} object and delivers a \texttt{FLPar} object, similar to \texttt{refpts}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp.rngs }\OtherTok{\textless{}{-}} \FunctionTok{msyRange}\NormalTok{(brp0, }\AttributeTok{range=}\FloatTok{0.05}\NormalTok{)}
\NormalTok{rp.rngs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "FLPar"
##      quantity
## refpt harvest  yield    rec      ssb      biomass  revenue  cost     profit  
##   msy 2.07e-01 7.28e+04 1.03e+06 9.87e+05 1.08e+06 1.21e+05 7.07e+04 5.07e+04
##   min 1.45e-01 6.92e+04 1.03e+06 1.43e+06 1.53e+06 1.18e+05 6.45e+04 5.31e+04
##   max 2.87e-01 6.92e+04 1.02e+06 6.26e+05 7.14e+05 1.12e+05 7.87e+04 3.36e+04
## units:  NA
\end{verbatim}

Another simple way, although it onl;y works for \(SPR\) based reference points, is to include other \texttt{spr.\#\#} points in the \texttt{refpts} table.

\textbf{{[}IAGO: NEED TO EXPLAIN THE CODE ABOVE ABOUT EXTENDING THE REFPTS FLPAR{]}}

\hypertarget{projections-and-harvest-control-rules}{%
\chapter{Projections and harvest control rules}\label{projections-and-harvest-control-rules}}

Massad et.al has a nice definition ``Prediction in general science can be divided into two components: forecasting and projections {[}2{]}. A forecast is an attempt to predict what will happen. A projection is an attempt to describe what would happen, given certain hypotheses {[}3{]}.''

(OECD)
``Forecasting'' and ``prediction'' are often used synonymously in the customary sense of assessing the magnitude which a quantity will assume at some future point of time .

Medium-term projections or scenarios In the context of the OECD's Economic Outlook, medium-term projections or scenarios look out five to six years, and are published as part of the OECD's projection exercise.

Projection
This term is used in two connected senses.
1. In relation to a time series it means a future value calculated according to predetermined changes in the
assumptions of the environment.
2. More recently, it has been used in probability theory to denote the conditional expectation of a variate. Since a regression equation gives the expectation of the dependent variate conditional upon values of the predicted (``independent'') variates and such equations are used for forecasting or prediction, the usages are connected.

Considering the above definitions one can think of the process of advising future fishing opportunities as a mix of forecasting and projections. When using a HCR that is accepted by decision makers to predict the catches which can be taken from the stock, one's in forecasting space. The process will retur what will happen having into account the known conditions of the system. On the other hand, when exploring potential future outcomes based on a set of scenarios previously defined, one's much more in projection's space.

In fisheries science it's not common to make the distinction between forecasts and predictions, and, in general, the approach tends to be much more within the realm of predictions. For example, it's common to run scenarios when giving advice to fisheries managers or test different assumptions about future events.

Strickly speaking projections are not part of the stock assessment process. The assessment of the status of the stock is completed when the analysts produces a comparison between the estimates of biomass and fishing mortality and the respective reference points. At that point it's possible to make statements about the stock being overfished, or not, and being subject to overfishing, or not.

Projections tend to come after having estimates of abundance or biomass and fishing mortality. Together with estimates, or assumptions, about the population's dynamics: growth, reproduction, natural mortality, etc; one can predict catches, biomass, abundance and other relevant statistics, under spoecific conditions and with a certain level of uncertainty.

For this section we'll be using the package \texttt{FLasher} (REF) from the FLR family of packages. Starting by fitting a model including a stock recruitment model. For projections one needs to set future recruitment.

The basic workflow to project with \texttt{FLasher} is to extend the \texttt{FLStock} object to store the predictions using the method \texttt{fwdWindow}, set the targets for the projection with method \texttt{fwdControl} and project the fishery with the method \texttt{fwd} with a \texttt{FLStock} and a \texttt{FLSR}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# model fit}
\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{geomean}\NormalTok{()) }
\NormalTok{sr00 }\OtherTok{\textless{}{-}} \FunctionTok{as}\NormalTok{(fit00, }\StringTok{"FLSR"}\NormalTok{)}
\NormalTok{stk00 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+}\NormalTok{ fit00}
\CommentTok{\# set projection}
\NormalTok{projy }\OtherTok{\textless{}{-}} \DecValTok{5}
\NormalTok{endpy }\OtherTok{\textless{}{-}}\NormalTok{ maxy }\SpecialCharTok{+}\NormalTok{ projy}
\NormalTok{inipy }\OtherTok{\textless{}{-}}\NormalTok{ maxy }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{stk00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdWindow}\NormalTok{(stk00, }\AttributeTok{end =}\NormalTok{ endpy)}
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \StringTok{"f"}\NormalTok{, }\AttributeTok{value =} \FloatTok{0.3}\NormalTok{)}
\CommentTok{\# project}
\NormalTok{stk01 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-97-1.png}
\caption{\label{fig:unnamed-chunk-97}Projection of stock for 5 years with fixed fishing mortality and recruitment}
\end{figure}

A natural addition to this forecast is to add uncertainty. We'll do that by generating uncertainty in population numbers, catch numbers and fishing mortality, using \texttt{simulate}, and add stock recruitment uncertainty using the residuals of the fit.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stk00 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+} \FunctionTok{simulate}\NormalTok{(fit00, nsim)}
\NormalTok{stk00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdWindow}\NormalTok{(stk00, }\AttributeTok{end =}\NormalTok{ endpy)}
\NormalTok{res00 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(sr00)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{window}\NormalTok{(}\FunctionTok{rec}\NormalTok{(stk00), }\DecValTok{2018}\NormalTok{, }\DecValTok{2022}\NormalTok{)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{rlnorm}\NormalTok{(rec00, }\FunctionTok{mean}\NormalTok{(res00), }\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(res00)))}
\NormalTok{stk02 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-99-1.png}
\caption{\label{fig:unnamed-chunk-99}Stochastic projection of stock for 5 years with fixed fishing mortality and recruitment}
\end{figure}

An alternative to the above workflow is to fit the stock recruitment model after the stock assessment model, using the outputs of the assessment as input to the stock recruitment fit. In which case stock recruitment estimation uncertainty can be added by fitting the stock recruitment model over stock assessment uncertainty, so that there will be stock-recruitment fit to each iteration generated from the stock assessment model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices) }
\NormalTok{stk00 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+} \FunctionTok{simulate}\NormalTok{(fit00, nsim)}
\NormalTok{sr00 }\OtherTok{\textless{}{-}} \FunctionTok{as.FLSR}\NormalTok{(stk00, }\AttributeTok{model=}\StringTok{"geomean"}\NormalTok{)}
\NormalTok{sr00 }\OtherTok{\textless{}{-}} \FunctionTok{fmle}\NormalTok{(sr00, }\AttributeTok{control =} \FunctionTok{list}\NormalTok{(}\AttributeTok{trace =} \DecValTok{0}\NormalTok{))}
\NormalTok{stk00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdWindow}\NormalTok{(stk00, }\AttributeTok{end =}\NormalTok{ endpy)}
\NormalTok{res00 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(sr00)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{window}\NormalTok{(}\FunctionTok{rec}\NormalTok{(stk00), inipy, endpy)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{rlnorm}\NormalTok{(rec00, }\FunctionTok{c}\NormalTok{(}\FunctionTok{yearMeans}\NormalTok{(res00)), }\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{yearVars}\NormalTok{(res00))))}
\NormalTok{stk03 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

{[}IAGO, check rlnorm, it doesn't work if the meanlog and sdlog are FLQuants{]}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-101-1.png}
\caption{\label{fig:unnamed-chunk-101}Stochastic projection of stock for 5 years with fixed fishing mortality and recruitment}
\end{figure}

These two methods don't give very different result when the stock recruitment model is not having a large impact in the other parameters. However the second method is much slower due to all the fits needed to have the empirical distribution of the stock recruitment model parameters.

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-102-1.png}
\caption{\label{fig:unnamed-chunk-102}Stochastic projection of stock for 5 years with fixed fishing mortality and recruitment}
\end{figure}

\hypertarget{initial-condition-assumptions-check-fwdwindow}{%
\section{Initial condition assumptions {[}CHECK fwdWindow{]}}\label{initial-condition-assumptions-check-fwdwindow}}

When projecting the stock forward one needs to make a number of assumptions about initial conditions, the starting point from where projections will be made. The method \texttt{fwdWindow} has a set of options that allows the analyst to decide about those assumptions:
- \texttt{wt}: Number of years to average over to get the future mean weights at age, default is 3
- \texttt{mat}: Number of years to average over to get the future proportion mature at age, default is 3
- \texttt{m}: Number of years to average over to get the future natural mortality at age, default is 3
- \texttt{spwn}: Number of years to average over to get the future fraction of mortality before spawning, default is 3
- \texttt{discards.ratio}: Number of years to average over to get the future mean proportion of discards at age. Default is 3
- \texttt{catch.sel}: Number of years to average over to get the future selection patern (fishing mortality at age which will be scaled based on canges in \(\bar{F}\)). Default is 3

One can also define if those assumptions will be based on the mean value over the time period set, or randomly sampled from historical values, through setting the argument \texttt{fun} to \texttt{mean} or \texttt{sample}, respectively.

For the next examples we'll use the approach of fitting the stock recruitment within the assessment together with other parameters. We'll set to 20 the number of years to compute mean weights at age, to 10 the number of years to average across and estimate the selection pattern in terms of fishing mortality at age. Finally, we'll use a 10 year period to compute the average discard ratio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{geomean}\NormalTok{()) }
\NormalTok{sr00 }\OtherTok{\textless{}{-}} \FunctionTok{as}\NormalTok{(fit00, }\StringTok{"FLSR"}\NormalTok{)}
\NormalTok{stk00 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+}\NormalTok{ fit00}
\NormalTok{stk00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdWindow}\NormalTok{(stk00, }\AttributeTok{end =}\NormalTok{ endpy, }\AttributeTok{years =} \FunctionTok{list}\NormalTok{(}\AttributeTok{wt =} \DecValTok{20}\NormalTok{, }\AttributeTok{catch.sel =} \DecValTok{10}\NormalTok{, }\AttributeTok{discards.ratio =} \DecValTok{10}\NormalTok{), }\AttributeTok{fun =} \FunctionTok{list}\NormalTok{(}\AttributeTok{wt =} \StringTok{"sample"}\NormalTok{))}
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \StringTok{"f"}\NormalTok{, }\AttributeTok{value =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{stk04 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-104-1.png}
\caption{\label{fig:unnamed-chunk-104}Stochastic projections of stock for 5 years with fixed fishing mortality and recruitment. Two scenarios with different assumptions about initial conditions}
\end{figure}

\hypertarget{scenarios}{%
\section{Scenarios}\label{scenarios}}

There's a wide range of scenarios that can be of interest to project in order to give advice to policy makers, or to better understand the fitted stock assessment model. For example, forecasting the stock in the absence of fishing for a few generations, gives good insights about the dynamics of the population being modelled.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{geomean}\NormalTok{())}
\NormalTok{sr00 }\OtherTok{\textless{}{-}} \FunctionTok{as}\NormalTok{(fit00, }\StringTok{"FLSR"}\NormalTok{)}
\NormalTok{stk00 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+} \FunctionTok{simulate}\NormalTok{(fit00, nsim)}
\CommentTok{\# set projection}
\NormalTok{projy }\OtherTok{\textless{}{-}} \DecValTok{25}
\NormalTok{endpy }\OtherTok{\textless{}{-}}\NormalTok{ maxy }\SpecialCharTok{+}\NormalTok{ projy}
\NormalTok{inipy }\OtherTok{\textless{}{-}}\NormalTok{ maxy }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{stk00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdWindow}\NormalTok{(stk00, }\AttributeTok{end =}\NormalTok{ endpy)}
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \StringTok{"f"}\NormalTok{, }\AttributeTok{value =} \DecValTok{0}\NormalTok{)}
\CommentTok{\# recruitment uncertainty}
\NormalTok{res00 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(sr00)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{window}\NormalTok{(}\FunctionTok{rec}\NormalTok{(stk00), inipy, endpy)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{rlnorm}\NormalTok{(rec00, }\FunctionTok{mean}\NormalTok{(res00), }\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(res00)))}
\CommentTok{\# project}
\NormalTok{stk05 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-106-1.png}
\caption{\label{fig:unnamed-chunk-106}Stochastic projection of stock for 25 years with fixed fishing mortality and recruitment}
\end{figure}

These scenarios are defined by the target quantities one's trying to achieve. In \texttt{FLasher} there are the following target quantities:
- srp
- ssb\_end
- biomass\_end
- ssb\_spawn
- biomass\_spawn
- ssb\_flash
- biomass\_flash
- inmb\_end
- indb
- catch
- landings
- discards
- f
- fbar
- revenue
- effort

{[}IAGO NEED YOUR HELP HERE{]}

When projecting the stock under the conditions defined by the scenario one can mix several quantities. For example it may be interesting to project an initial situation of growing the stock followed by a higher exploitation to evaluate how catches would behave.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{"ssb\_end"}\NormalTok{, }\DecValTok{15}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\StringTok{"f"}\NormalTok{, }\DecValTok{10}\NormalTok{)), }\AttributeTok{value =} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{2000000}\NormalTok{, }\DecValTok{15}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\DecValTok{10}\NormalTok{)))}
\NormalTok{stk06 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-108-1.png}
\caption{\label{fig:unnamed-chunk-108}Stochastic projection of stock for 25 years with fixed SSB for 15 years followed by fixed fishing mortality for 10 years and constant recruitment}
\end{figure}

\hypertarget{relative-scenarios}{%
\subsection{Relative scenarios}\label{relative-scenarios}}

Another scenario that is very useful when advising decision makers is to have objectives which are relative to previous preformances. For example one could increase spwanwing stock biomass by 10\% each year. This is done buy using the argument \texttt{relYear} and setting \texttt{value} in relative terms, \(1.1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices, }\AttributeTok{srmodel=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{geomean}\NormalTok{())}
\NormalTok{sr00 }\OtherTok{\textless{}{-}} \FunctionTok{as}\NormalTok{(fit00, }\StringTok{"FLSR"}\NormalTok{)}
\NormalTok{stk00 }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+} \FunctionTok{simulate}\NormalTok{(fit00, nsim)}
\CommentTok{\# set projection}
\NormalTok{projy }\OtherTok{\textless{}{-}} \DecValTok{5}
\NormalTok{endpy }\OtherTok{\textless{}{-}}\NormalTok{ maxy }\SpecialCharTok{+}\NormalTok{ projy}
\NormalTok{inipy }\OtherTok{\textless{}{-}}\NormalTok{ maxy }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{stk00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdWindow}\NormalTok{(stk00, }\AttributeTok{end =}\NormalTok{ endpy)}
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \StringTok{"ssb\_end"}\NormalTok{, }\AttributeTok{value =} \FloatTok{1.1}\NormalTok{, }\AttributeTok{relYear =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy}\DecValTok{{-}1}\NormalTok{)}
\CommentTok{\# recruitment uncertainty}
\NormalTok{res00 }\OtherTok{\textless{}{-}} \FunctionTok{residuals}\NormalTok{(sr00)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{window}\NormalTok{(}\FunctionTok{rec}\NormalTok{(stk00), inipy, endpy)}
\NormalTok{rec00 }\OtherTok{\textless{}{-}} \FunctionTok{rlnorm}\NormalTok{(rec00, }\FunctionTok{mean}\NormalTok{(res00), }\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{var}\NormalTok{(res00)))}
\CommentTok{\# project}
\NormalTok{stk07 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

Similar scenarios can be set for all quantities and any years to use as reference. The next example sets a scenario where \(SSB\) levels are set in relation to the most recent estimate out of the assessmeent.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \StringTok{"ssb\_end"}\NormalTok{, }\AttributeTok{value =} \FloatTok{1.1}\NormalTok{, }\AttributeTok{relYear =}\NormalTok{ maxy)}
\NormalTok{stk08 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-111-1.png}
\caption{\label{fig:unnamed-chunk-111}Stochastic projection of stock for 25 years with fixed SSB for 15 years followed by fixed fishing mortality for 10 years and constant recruitment}
\end{figure}

\hypertarget{limits}{%
\subsection{Limits}\label{limits}}

An important element when projecting the stock forward is to keep the performance of the fishery within some boundaries. A common one requested by the industry is to keep catches within some stability. \texttt{fwd} can include those constraints using the \texttt{min} and \texttt{max} arguments. The next example sets the minimum future catches to half of mean historical catches.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trg00 }\OtherTok{\textless{}{-}} \FunctionTok{fwdControl}\NormalTok{(}\AttributeTok{year =}\NormalTok{ inipy}\SpecialCharTok{:}\NormalTok{endpy, }\AttributeTok{quant =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"ssb\_end"}\NormalTok{, }\StringTok{"catch"}\NormalTok{), projy), }\AttributeTok{value =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1500000}\NormalTok{, }\ConstantTok{NA}\NormalTok{), projy), }\AttributeTok{min=}\FunctionTok{rep}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FloatTok{0.5}\SpecialCharTok{*}\FunctionTok{mean}\NormalTok{(}\FunctionTok{catch}\NormalTok{(stk00), }\AttributeTok{na.rm=}\ConstantTok{TRUE}\NormalTok{)), projy))}
\NormalTok{stk09 }\OtherTok{\textless{}{-}} \FunctionTok{fwd}\NormalTok{(stk00, }\AttributeTok{control=}\NormalTok{trg00, }\AttributeTok{sr=}\NormalTok{sr00, }\AttributeTok{residuals=}\NormalTok{rec00)}
\end{Highlighting}
\end{Shaded}

\hypertarget{complex-scenario}{%
\subsection{Complex scenario}\label{complex-scenario}}

\hypertarget{predict-and-simulate}{%
\chapter{\texorpdfstring{Predict and simulate \label{sec:predsim}}{Predict and simulate }}\label{predict-and-simulate}}

To predict and simulate \texttt{R} uses the methods \texttt{predict()} and \texttt{simulate()}, which were implemented in \texttt{FLa4a} in the same fashion.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit0 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.index, }\AttributeTok{fit=}\StringTok{"assessment"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{basic-functions}{%
\section{Basic functions\}}\label{basic-functions}}

Simulation and prediction in FLa4a is based on three functions: \texttt{simulate} and \texttt{genFLQuant}.

\hypertarget{simulate}{%
\subsection{simulate()}\label{simulate}}

Unlike the stats function \texttt{stats::simulate}, \texttt{FLa4a::simulate} will return the same object as it was passed. For example, if you simulate from a FLa4a fit, you will get an FLa4a fit object back, in which the coefficients of the object are simulations from the model. Likewise, if you call simulate on a submodel object you will get back a submodel object inwhich the coefficients are simulations from the model. Simulations are always done by generating random draws from a multivariate normal distribution with mean given by the coeffients of the model, and variance matrix given by the estimated covariance matrix of the coefficients (in practice this is a submatrix of the inverse of the hessian matrix).

Simulate works on several classes from full fits right down to the individual model compents, so if \texttt{my\textbackslash{}\_fit} is a fitted \texttt{a4a} model, then \texttt{simulate(my\textbackslash{}\_fit,\ nsim\ =\ 100)} will return a new fitted \texttt{a4a} model where the model coefficients now have 100 iters and are drawn from the full variance matrix of the fitted model. Similarly, \texttt{simulate(fmodel(my\textbackslash{}\_fit),\ nsim\ =\ 100)} will return a submodel with the same formula as the fishing mortality model as in the \texttt{a4a} fit but where the coefficients are simulated from the variance matrix of the relavent parameters.

\hypertarget{genflquant}{%
\subsection{genFLQuant()}\label{genflquant}}

This is a special function who's purpose is to return an \texttt{FLQuant} or \texttt{FLQuants}. It essentially provides predictions from a model and provides in them as FLQuants of the correct dimensions. \texttt{genFLQuant} also has an argument \texttt{nsim} which if set to a value greater than zero produces simulated predictions from the model based on simulations of the model coefficients.

\hypertarget{submodels}{%
\section{submodels}\label{submodels}}

In an \texttt{sca} fit individual submodel objects are often combined into a collection of \texttt{submodels}, for example the models for survey catchability are a collection of submodels

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qmod }\OtherTok{\textless{}{-}} \FunctionTok{qmodel}\NormalTok{(fit0)}
\end{Highlighting}
\end{Shaded}

which contains a submodel for each survey catchability. Now (almost) the same code can be run as before to plot the estimates with confidence intervals, the difference with submodels is all the results will be \texttt{FLQuants} so, \texttt{lapply} must be used to do computations on the predictions for each submodel seperately.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qmod\_fit\_sim }\OtherTok{\textless{}{-}} \FunctionTok{genFLQuant}\NormalTok{(qmod, }\AttributeTok{nsim =} \DecValTok{999}\NormalTok{)}

\CommentTok{\# reduce to quantiles}
\NormalTok{qmod\_fit\_sim }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(qmod\_fit\_sim, }\StringTok{"["}\NormalTok{, }\AttributeTok{j =} \StringTok{"2016"}\NormalTok{)}
\NormalTok{qmod\_fit\_sim }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(qmod\_fit\_sim, quantile, }\AttributeTok{prob =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.50}\NormalTok{, }\FloatTok{0.975}\NormalTok{))}

\CommentTok{\# reshape}
\NormalTok{dat }\OtherTok{\textless{}{-}} \FunctionTok{reshape}\NormalTok{(}
    \FunctionTok{as.data.frame}\NormalTok{(qmod\_fit\_sim, }\AttributeTok{drop=}\ConstantTok{TRUE}\NormalTok{), }
    \AttributeTok{timevar =} \StringTok{"iter"}\NormalTok{, }\AttributeTok{idvar =} \FunctionTok{c}\NormalTok{(}\StringTok{"age"}\NormalTok{, }\StringTok{"qname"}\NormalTok{), }\AttributeTok{direction =} \StringTok{"wide"}  
\NormalTok{  )}

\CommentTok{\# plot}
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data=}\NormalTok{dat, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ age, }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{data.50\%}\StringTok{\textasciigrave{}}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{ymin =} \StringTok{\textasciigrave{}}\AttributeTok{data.2.5\%}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{ymax =} \StringTok{\textasciigrave{}}\AttributeTok{data.97.5\%}\StringTok{\textasciigrave{}}\NormalTok{), }
              \AttributeTok{fill =} \StringTok{"red"}\NormalTok{, }\AttributeTok{alpha =}\NormalTok{ .}\DecValTok{15}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Estimated catchability at age"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ qname, }\AttributeTok{scales =} \StringTok{"free\_x"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

as before the data, coefficients and variance covariance are all available via

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{coef}\NormalTok{(qmod)}
\FunctionTok{vcov}\NormalTok{(qmod)}
\end{Highlighting}
\end{Shaded}

\hypertarget{predict}{%
\section{Predict}\label{predict}}

Predict simply computes the quantities of interest using the estimated coefficients and the design matrix of the model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit0)}
\FunctionTok{lapply}\NormalTok{(fit.pred, names)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $stkmodel
## [1] "harvest" "rec"     "ny1"    
## 
## $qmodel
## [1] "BTS-Isis-early"                  "BTS-Combined (ISIS and TRIDENS)"
## [3] "SNS"                             "BTS-Combined (all)"             
## [5] "IBTS_Q3"                         "IBTS_Q1"                        
## 
## $vmodel
## [1] "catch"                           "BTS-Isis-early"                 
## [3] "BTS-Combined (ISIS and TRIDENS)" "SNS"                            
## [5] "BTS-Combined (all)"              "IBTS_Q3"                        
## [7] "IBTS_Q1"
\end{verbatim}

\hypertarget{simulate-1}{%
\section{Simulate}\label{simulate-1}}

Simulate uses the variance-covariance matrix computed from the Hessian returned by \texttt{ADMB} and the fitted parameters, to parametrize a multivariate normal distribution. The simulations are carried out using the method \texttt{mvrnorm()} provided by the R package \href{http://cran.r-project.org/web/packages/MASS/}{MASS}. Figure \ref{fig:sim} shows a comparison between the estimated values and the medians of the simulation, while Figure \ref{fig:sim2} presents the stock summary of the simulated and fitted data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OtherTok{\textless{}{-}} \FunctionTok{simulate}\NormalTok{(fit0, }\DecValTok{100}\NormalTok{)}
\NormalTok{flqs }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{sim=}\FunctionTok{iterMedians}\NormalTok{(}\FunctionTok{stock.n}\NormalTok{(fits)), }\AttributeTok{det=}\FunctionTok{stock.n}\NormalTok{(fit0))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(data}\SpecialCharTok{\textasciitilde{}}\NormalTok{year}\SpecialCharTok{|}\NormalTok{age, }\AttributeTok{groups=}\NormalTok{qname, }\AttributeTok{data=}\NormalTok{flqs, }\AttributeTok{type=}\StringTok{"l"}\NormalTok{,}
       \AttributeTok{scales=}\FunctionTok{list}\NormalTok{(}\AttributeTok{y=}\FunctionTok{list}\NormalTok{(}\AttributeTok{relation=}\StringTok{"free"}\NormalTok{, }\AttributeTok{draw=}\ConstantTok{FALSE}\NormalTok{)),}
       \AttributeTok{auto.key=}\FunctionTok{list}\NormalTok{(}\AttributeTok{points=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{lines=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{columns=}\DecValTok{2}\NormalTok{),}
       \AttributeTok{par.settings=}\FunctionTok{list}\NormalTok{(}\AttributeTok{superpose.line=}\FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\FunctionTok{c}\NormalTok{(}\StringTok{"gray35"}\NormalTok{, }\StringTok{"black"}\NormalTok{)),}
       \AttributeTok{strip.background=}\FunctionTok{list}\NormalTok{(}\AttributeTok{col=}\StringTok{"gray90"}\NormalTok{)), }\AttributeTok{ylab=}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/sim-1.png}
\caption{\label{fig:sim}Median simulations VS fit}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stks }\OtherTok{\textless{}{-}}\NormalTok{ ple4 }\SpecialCharTok{+}\NormalTok{ fits}
\FunctionTok{plot}\NormalTok{(stks)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/sim2-1.png}
\caption{\label{fig:sim2}Stock summary of the simulated and fitted data}
\end{figure}

\hypertarget{the-statistical-catch-at-age-stock-assessment-framework-with-mcmc}{%
\chapter{\texorpdfstring{The statistical catch-at-age stock assessment framework with MCMC \label{sec:mcmc}}{The statistical catch-at-age stock assessment framework with MCMC }}\label{the-statistical-catch-at-age-stock-assessment-framework-with-mcmc}}

The previous methods were demonstrated using the maximum likelihood estimation method. However, \texttt{ADMB} can also use MCMC methods to fit the model. This section shows how the \texttt{sca} methods interface with \texttt{ADMB} to use the MCMC fits. For this section we'll use the hake assessment in mediterranean areas (gsa) 1, 5, 6 and 7.

The \texttt{sca} likelihood estimate is:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ll}
\FunctionTok{data}\NormalTok{(hke1567)}
\FunctionTok{data}\NormalTok{(hke1567.idx)}
\NormalTok{fmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}}\FunctionTok{s}\NormalTok{(age, }\AttributeTok{k =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{8}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{8}\NormalTok{, }\AttributeTok{by =} \FunctionTok{as.numeric}\NormalTok{(age }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)) }\SpecialCharTok{+} \FunctionTok{s}\NormalTok{(year, }\AttributeTok{k =} \DecValTok{8}\NormalTok{, }\AttributeTok{by =} \FunctionTok{as.numeric}\NormalTok{(age }\SpecialCharTok{==} \DecValTok{4}\NormalTok{))}
\NormalTok{qmod }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{I}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1} \SpecialCharTok{+} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{age))))}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod)}
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{simulate}\NormalTok{(fit, }\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

To run the MCMC method, one needs to configure a set of arguments, which is done by creating a \texttt{SCAMCMC} object. For details on the MCMC configuration in \texttt{ADMB} visit the \texttt{ADMB} website.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# mcmc}
\NormalTok{mc }\OtherTok{\textless{}{-}} \FunctionTok{SCAMCMC}\NormalTok{()}
\CommentTok{\# check the default pars}
\NormalTok{mc}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## An object of class "SCAMCMC"
## Slot "mcmc":
## [1] 10000
## 
## Slot "mcsave":
## [1] 100
## 
## Slot "mcscale":
## [1] NaN
## 
## Slot "mcmult":
## [1] NaN
## 
## Slot "mcrb":
## [1] NaN
## 
## Slot "mcprobe":
## [1] NaN
## 
## Slot "mcseed":
## [1] NaN
## 
## Slot "mcdiag":
## [1] FALSE
## 
## Slot "mcnoscale":
## [1] FALSE
## 
## Slot "mcu":
## [1] FALSE
## 
## Slot "hybrid":
## [1] FALSE
## 
## Slot "hynstep":
## [1] NaN
## 
## Slot "hyeps":
## [1] NaN
\end{verbatim}

Defaults for now are ok, so lets fit the model. Note that the argument \texttt{fit} must be set to \texttt{MCMC} and the argument \texttt{mcmc} takes the \texttt{SCAMCMC} object. A major check when running MCMC is the acceptance rate, which should be around 0.3. This is a rule of thumb, for more information read the (extensive) literature on MCMC. The slot \texttt{fitSumm} stores that information.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# fit the model}
\NormalTok{fitmc00 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{fit =} \StringTok{"MCMC"}\NormalTok{, }\AttributeTok{mcmc=}\NormalTok{mc)}
\CommentTok{\# check acceptance rate}
\FunctionTok{fitSumm}\NormalTok{(fitmc00)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              iters
##                      1
##   nopar        52.0000
##   nlogl             NA
##   maxgrad           NA
##   nobs        176.0000
##   gcv               NA
##   convergence       NA
##   accrate       0.3271
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(hke1567 }\SpecialCharTok{+}\NormalTok{ fitmc00)}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-119-1.png}

As mentioned above \texttt{ADMB} has several options for MCMC. Here we demonstrate one of them, \texttt{mcprobe} which sets a fat-tailed proposal distribution, as an example of how to use the \texttt{SCAMCMC} objects.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mc }\OtherTok{\textless{}{-}} \FunctionTok{SCAMCMC}\NormalTok{(}\AttributeTok{mcprobe=}\FloatTok{0.45}\NormalTok{)}
\NormalTok{fitmc01 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{fit =} \StringTok{"MCMC"}\NormalTok{, }\AttributeTok{mcmc=}\NormalTok{mc)}
\end{Highlighting}
\end{Shaded}

All fits together

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{FLStocks}\NormalTok{(}\AttributeTok{ll=}\NormalTok{hke1567 }\SpecialCharTok{+}\NormalTok{ fit, }\AttributeTok{mc=}\NormalTok{hke1567 }\SpecialCharTok{+}\NormalTok{ fitmc00, }\AttributeTok{mc\_alt=}\NormalTok{hke1567 }\SpecialCharTok{+}\NormalTok{ fitmc01))}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-121-1.png}

\hypertarget{diagnostics-with-coda}{%
\section{Diagnostics with CODA}\label{diagnostics-with-coda}}

We use the package \texttt{CODA} to run the diagnostics on MCMC fits. One needs to convert the \texttt{a4a} output into a \texttt{mcmc} CODA object over which several diagostics can be ran. The mcmc object is a matrix with the parameters (row = iters, cols= pars).

Common diagnostics for MCMC chains is to look at the burn-in period, auto-correlation and cross correlation\footnote{ToBe Added}. The first can be dealt by droping an initial set of iterations, which is done using the function \texttt{burnin}. The second can be managed by thinning the chain, in \texttt{ADMB} this is done through the parameter \texttt{mcsave\ N}, which defines the iteration's saving rate (the inverse of the thinning rate). This is the rate at which samples of the parameters are saved, such that thinning is effectively discarding draws.

Next fit will run 1000 iterations and save every iter (\texttt{mcsave=1}).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(coda)}
\NormalTok{mc }\OtherTok{\textless{}{-}} \FunctionTok{SCAMCMC}\NormalTok{(}\AttributeTok{mcmc=}\DecValTok{1000}\NormalTok{, }\AttributeTok{mcsave=}\DecValTok{1}\NormalTok{)}
\NormalTok{fitmc02 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{fit =} \StringTok{"MCMC"}\NormalTok{, }\AttributeTok{mcmc=}\NormalTok{mc)}
\NormalTok{fitmc02.mc }\OtherTok{\textless{}{-}}\NormalTok{ FLa4a}\SpecialCharTok{::}\FunctionTok{as.mcmc}\NormalTok{(fitmc02)}
\end{Highlighting}
\end{Shaded}

The autocorrelation plots will show the very strong correlation across samples, which we want to avoid. Figure \ref{fig:acf01} shows autocorrelation for the first parameter.

\textless{}\textgreater=
acf(fitmc02.mc{[},1{]})

\begin{verbatim}

Ploting the chain for the parameter clearly shows the autocorrelation but also the burnin phase, where there's no information about the parameter. These iterations must to be dropped. 

<<chain01>>=
xyplot(fitmc02.mc[,1])
\end{verbatim}

It's also important to check if the distribution of the parameters is normal, which can be done with the \texttt{densityplot}:

\textless{}\textgreater=
densityplot(fitmc02.mc{[},1{]})

\begin{verbatim}

Another interesting diagnostic is the Geweke-Brooks Z-score check. This diagnostic indicates if the first and last part of a sample from a Markov chain may not be drawn from the same distribution. It's useful to decide if the first few iterations should e discarded.

<<gew01>>=
geweke.plot(fitmc02.mc[,1])
\end{verbatim}

It's clear from the above diagnostics that a burnin phase of about 200 iterations should be considered. With relation to thining one needs to try several values until no autocorrelation exits.

Next fit will run 10000 iterations and save every 10th iteration (\texttt{mcsave=10}), so that the same 1000 iters are generated by the method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mc }\OtherTok{\textless{}{-}} \FunctionTok{SCAMCMC}\NormalTok{(}\AttributeTok{mcmc=}\DecValTok{10000}\NormalTok{, }\AttributeTok{mcsave=}\DecValTok{10}\NormalTok{)}
\NormalTok{fitmc03 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{fit =} \StringTok{"MCMC"}\NormalTok{, }\AttributeTok{mcmc=}\NormalTok{mc)}
\NormalTok{fitmc03.mc }\OtherTok{\textless{}{-}}\NormalTok{ FLa4a}\SpecialCharTok{::}\FunctionTok{as.mcmc}\NormalTok{(fitmc03)}
\end{Highlighting}
\end{Shaded}

The autocorrelation plots still shows a strong correlation across samples, although less than in the previous model.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{acf}\NormalTok{(fitmc03.mc[,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-124-1.png}

Next fit will run 100000 iterations and save every 100th iteration (\texttt{mcsave=100}), so that the same 1000 iters are generated by the method. Autocorrelation is much weaker, could still be reduced by increasing \texttt{mcsave}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mc }\OtherTok{\textless{}{-}} \FunctionTok{SCAMCMC}\NormalTok{(}\AttributeTok{mcmc=}\DecValTok{100000}\NormalTok{, }\AttributeTok{mcsave=}\DecValTok{100}\NormalTok{)}
\NormalTok{fitmc03 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{fit =} \StringTok{"MCMC"}\NormalTok{, }\AttributeTok{mcmc=}\NormalTok{mc)}
\NormalTok{fitmc03.mc }\OtherTok{\textless{}{-}}\NormalTok{ FLa4a}\SpecialCharTok{::}\FunctionTok{as.mcmc}\NormalTok{(fitmc03)}
\end{Highlighting}
\end{Shaded}

Next fit will run 200000 iterations and save every 200th iteration (\texttt{mcsave=200}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mc }\OtherTok{\textless{}{-}} \FunctionTok{SCAMCMC}\NormalTok{(}\AttributeTok{mcmc=}\DecValTok{200000}\NormalTok{, }\AttributeTok{mcsave=}\DecValTok{200}\NormalTok{)}
\NormalTok{fitmc03 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(hke1567, hke1567.idx, }\AttributeTok{fmodel=}\NormalTok{fmod, }\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{fit =} \StringTok{"MCMC"}\NormalTok{, }\AttributeTok{mcmc=}\NormalTok{mc)}
\NormalTok{fitmc03.mc }\OtherTok{\textless{}{-}}\NormalTok{ FLa4a}\SpecialCharTok{::}\FunctionTok{as.mcmc}\NormalTok{(fitmc03)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{acf}\NormalTok{(fitmc03.mc[,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-127-1.png}

All diagnostics improved with the new thining rate although some other improvements can be done. Note this diagnostics should be checked for all parameters. For the sake of space the demonstration uses only on the first.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{xyplot}\NormalTok{(fitmc03.mc[,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-128-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{densityplot}\NormalTok{(fitmc03.mc[,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-129-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{geweke.plot}\NormalTok{(fitmc03.mc[,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\includegraphics{_bookdown_files/_main_files/figure-html/unnamed-chunk-130-1.png}

Note: add correlation across parameters

The manual ``A Guide for Bayesian Analysis in AD Model Builder'' by Cole C. Monnahan, Melissa L. Muradian and Peter T. Kuriyam describe and explain a larger group of arguments that can be set when running MCMC with ADMB, which the engine \texttt{a4a} uses.

\hypertarget{propagate-uncertainty-into-stock-assessment}{%
\chapter{Propagate uncertainty into stock assessment}\label{propagate-uncertainty-into-stock-assessment}}

Representing the uncertainty in M and how this influences estimates of management quantities is therefore an important component of conducting stock assessments (Mounder et.al 2023 M paper in fishres).

Many values for M used in assessments remain based on life history theory, maximum age, and regression (LHMR) approaches. There will be cases when LHMR methods are more reliable than direct estimates and the results of stock assessments. However, LHMR methods should be used only if more direct estimates or stock assessment internal estimates are unavailable or unreliable (which, admittedly, is most of the time). If they are to be used, \textbf{they should be accompanied by measures of uncertainty (e.g., Cope and Hamel, 2022; Hamel and Cope, 2022), which should be propagated into the results of the assessment} either directly through Bayesian or related approaches, or through sensitivity analyses and profiles (Mounder et.al 2023 M paper in fishres).

In this section we give an example of how uncertainty in natural mortality, set up using the \texttt{m()} method and the class \texttt{a4aM} (see chapter XX), is propagated through the stock assessment. We'll start by fitting the default model to the data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(ple4, ple4.indices)}
\end{Highlighting}
\end{Shaded}

Using \texttt{a4a} methods we'll model natural mortality using a negative exponential model by age, Jensen's estimator for the level and a constant trend with time. We include multivariate normal uncertainty using the \texttt{mvrnorm()} method and create 10 iterations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nits }\OtherTok{\textless{}{-}} \DecValTok{10}

\NormalTok{shape }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{age}\FloatTok{{-}0.5}\NormalTok{))}
\NormalTok{level }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\NormalTok{k}\SpecialCharTok{\^{}}\FloatTok{0.66}\SpecialCharTok{*}\NormalTok{t}\SpecialCharTok{\^{}}\FloatTok{0.57}\NormalTok{, }\AttributeTok{params =} \FunctionTok{FLPar}\NormalTok{(}\AttributeTok{k=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{t=}\DecValTok{10}\NormalTok{),}
                     \AttributeTok{vcov=}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.002}\NormalTok{, }\FloatTok{0.01}\NormalTok{,}\FloatTok{0.01}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ncol=}\DecValTok{2}\NormalTok{))}
\NormalTok{trend }\OtherTok{\textless{}{-}} \FunctionTok{FLModelSim}\NormalTok{(}\AttributeTok{model=}\SpecialCharTok{\textasciitilde{}}\NormalTok{b, }\AttributeTok{params=}\FunctionTok{FLPar}\NormalTok{(}\AttributeTok{b=}\FloatTok{0.5}\NormalTok{), }\AttributeTok{vcov=}\FunctionTok{matrix}\NormalTok{(}\FloatTok{0.02}\NormalTok{))}

\NormalTok{m4 }\OtherTok{\textless{}{-}} \FunctionTok{a4aM}\NormalTok{(}\AttributeTok{shape=}\NormalTok{shape, }\AttributeTok{level=}\NormalTok{level, }\AttributeTok{trend=}\NormalTok{trend)}
\NormalTok{m4 }\OtherTok{\textless{}{-}} \FunctionTok{mvrnorm}\NormalTok{(nits, m4)}
\FunctionTok{range}\NormalTok{(m4)[] }\OtherTok{\textless{}{-}} \FunctionTok{range}\NormalTok{(ple4)[]}
\FunctionTok{range}\NormalTok{(m4)[}\FunctionTok{c}\NormalTok{(}\StringTok{"minmbar"}\NormalTok{,}\StringTok{"maxmbar"}\NormalTok{)]}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)}
\NormalTok{flq }\OtherTok{\textless{}{-}} \FunctionTok{m}\NormalTok{(m4)[]}
\FunctionTok{quant}\NormalTok{(flq) }\OtherTok{\textless{}{-}} \StringTok{"age"}
\NormalTok{stk }\OtherTok{\textless{}{-}} \FunctionTok{propagate}\NormalTok{(ple4, nits)}
\FunctionTok{m}\NormalTok{(stk) }\OtherTok{\textless{}{-}}\NormalTok{ flq}
\end{Highlighting}
\end{Shaded}

We fit the same model to the new stock object which has uncertainty in the natural mortality. The assessment is performed for each of the 10 iterations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stk, ple4.indices)}
\end{Highlighting}
\end{Shaded}

And compare the two results (Figure \ref{fig:mprop}). It's quite easy to run these kind of tests and a large part of our effort is to create the tools to do so.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{FLStocks}\NormalTok{(}\StringTok{"Jensen M with uncertainty"}\OtherTok{=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit1, }\StringTok{"M=0.2"}\OtherTok{=}\NormalTok{ple4}\SpecialCharTok{+}\NormalTok{fit), }\AttributeTok{key=}\ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{_bookdown_files/_main_files/figure-html/mprop-1.png}
\caption{\label{fig:mprop}Stock summary for two M models}
\end{figure}

\hypertarget{modelling-fleet-selectivity}{%
\chapter{Modelling fleet selectivity}\label{modelling-fleet-selectivity}}

\hypertarget{modelling-spatial-effects}{%
\chapter{Modelling spatial effects}\label{modelling-spatial-effects}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ridx01 }\OtherTok{\textless{}{-}}\NormalTok{ stk0}\SpecialCharTok{@}\NormalTok{stock.n[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{*}\FloatTok{0.7}\SpecialCharTok{*}\FloatTok{0.001}
\NormalTok{ridx01 }\OtherTok{\textless{}{-}} \FunctionTok{log}\NormalTok{(ridx01}\SpecialCharTok{*}\FunctionTok{rlnorm}\NormalTok{(ridx01))}
\NormalTok{ridx02 }\OtherTok{\textless{}{-}}\NormalTok{ stk0}\SpecialCharTok{@}\NormalTok{stock.n[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{*}\FloatTok{0.3}\SpecialCharTok{*}\FloatTok{0.001}
\NormalTok{ridx02 }\OtherTok{\textless{}{-}} \FunctionTok{log}\NormalTok{(ridx02}\SpecialCharTok{*}\FunctionTok{rlnorm}\NormalTok{(ridx02))}

\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{geomean}\NormalTok{(a}\SpecialCharTok{\textasciitilde{}}\NormalTok{ridx01}\SpecialCharTok{+}\NormalTok{ridx02, }\AttributeTok{CV=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{cvar }\OtherTok{\textless{}{-}} \FunctionTok{FLQuants}\NormalTok{(}\AttributeTok{ridx01 =}\NormalTok{ ridx01, }\AttributeTok{ridx02 =}\NormalTok{ ridx02)}
\NormalTok{fit01 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stock,tun.sel[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{)],}\AttributeTok{fmodel=}\NormalTok{fmod,}\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{srmodel=}\NormalTok{srmod, }\AttributeTok{covar=}\NormalTok{cvar)}
\FunctionTok{coef}\NormalTok{(fit01)}
\NormalTok{srmod }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{geomean}\NormalTok{(}\AttributeTok{CV=}\FloatTok{0.1}\NormalTok{)}
\NormalTok{fit02 }\OtherTok{\textless{}{-}} \FunctionTok{sca}\NormalTok{(stock,tun.sel[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{)],}\AttributeTok{fmodel=}\NormalTok{fmod,}\AttributeTok{qmodel=}\NormalTok{qmod, }\AttributeTok{srmodel=}\NormalTok{srmod)}
\FunctionTok{coef}\NormalTok{(fit02)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  check situation where the two areas are negatively correlated
\item
  the two covariates need to be at the same scale, in the sense of representing the same process
\item
  other examples (ICES, ask in the plenary if we can have access to the data)
\item
  dan ghotel ask for spatial workshop data
\end{itemize}

\hypertarget{sections-to-be-added}{%
\chapter{Sections to be added!?}\label{sections-to-be-added}}

\begin{itemize}
\tightlist
\item
  Assessing the coverage of confidence intervals??
\end{itemize}

\end{document}
