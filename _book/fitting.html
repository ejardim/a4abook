<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Fitting | Fish stock assessment with R</title>
  <meta name="description" content="How to do stock assessment in R using the a4a framework" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Fitting | Fish stock assessment with R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="How to do stock assessment in R using the a4a framework" />
  <meta name="github-repo" content="ejardim/a4abook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Fitting | Fish stock assessment with R" />
  
  <meta name="twitter:description" content="How to do stock assessment in R using the a4a framework" />
  

<meta name="author" content="John Doe and friends" />


<meta name="date" content="2025-03-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="submodel-structure.html"/>
<link rel="next" href="diagnostics.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Stock assessment framework</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> cover-image: path to the social sharing image like images/cover.jpg</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#license-documentation-and-development-status"><i class="fa fa-check"></i><b>1.1</b> License, documentation and development status</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installing-and-loading-libraries"><i class="fa fa-check"></i><b>1.2</b> Installing and loading libraries</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#how-to-read-this-document"><i class="fa fa-check"></i><b>1.3</b> How to read this document</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#how-to-get-help"><i class="fa fa-check"></i><b>1.4</b> How to get help</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#notation"><i class="fa fa-check"></i><b>1.5</b> Notation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#the-assessment-for-all-initiative-a4a"><i class="fa fa-check"></i><b>2.1</b> The “Assessment for All” Initiative (a4a)</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#multi-stage-modelling-approach"><i class="fa fa-check"></i><b>2.2</b> Multi-stage modelling approach</a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#stock-assessment-process"><i class="fa fa-check"></i><b>2.3</b> Stock Assessment Process</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#stock-assessment-as-a-linear-model-colin"><i class="fa fa-check"></i><b>2.4</b> Stock assessment as a linear model [COLIN]</a></li>
<li class="chapter" data-level="2.5" data-path="introduction.html"><a href="introduction.html#data-used-in-the-book"><i class="fa fa-check"></i><b>2.5</b> Data used in the book</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="introduction.html"><a href="introduction.html#plaice-in-area-fao-27-ices-area-iv"><i class="fa fa-check"></i><b>2.5.1</b> Plaice in area FAO 27, ICES area IV</a></li>
<li class="chapter" data-level="2.5.2" data-path="introduction.html"><a href="introduction.html#european-hake-in-fao-37-gsas-1567"><i class="fa fa-check"></i><b>2.5.2</b> European hake in FAO 37, GSAs 1,5,6,7</a></li>
<li class="chapter" data-level="2.5.3" data-path="introduction.html"><a href="introduction.html#mut-in-fao-37-gsas-1"><i class="fa fa-check"></i><b>2.5.3</b> MUT in FAO 37, GSAs 1</a></li>
<li class="chapter" data-level="2.5.4" data-path="introduction.html"><a href="introduction.html#stock-xx"><i class="fa fa-check"></i><b>2.5.4</b> stock xx</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html"><i class="fa fa-check"></i><b>3</b> Introduction to Splines</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#generalize-to-polynomials"><i class="fa fa-check"></i><b>3.1</b> Generalize to polynomials</a></li>
<li class="chapter" data-level="3.2" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#thin-plate-spline"><i class="fa fa-check"></i><b>3.2</b> Thin plate spline</a></li>
<li class="chapter" data-level="3.3" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#comparison"><i class="fa fa-check"></i><b>3.3</b> Comparison</a></li>
<li class="chapter" data-level="3.4" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#the-mgcv-package-inside-a4a"><i class="fa fa-check"></i><b>3.4</b> The <code>mgcv</code> package inside <code>a4a</code></a></li>
<li class="chapter" data-level="3.5" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#on-the-number-of-knots-k"><i class="fa fa-check"></i><b>3.5</b> On the number of knots <span class="math inline">\(k\)</span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><i class="fa fa-check"></i><b>4</b> Modelling Individual Growth and Using Stochastic Slicing to Convert Length-based Data Into Age-based Data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#a4agr---the-growth-class"><i class="fa fa-check"></i><b>4.1</b> a4aGr - The growth class</a></li>
<li class="chapter" data-level="4.2" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#adding-uncertainty-to-growth-parameters-with-a-multivariate-normal-distribution"><i class="fa fa-check"></i><b>4.2</b> Adding uncertainty to growth parameters with a multivariate normal distribution}</a></li>
<li class="chapter" data-level="4.3" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#adding-uncertainty-to-growth-parameters-with-a-multivariate-triangle-distribution"><i class="fa fa-check"></i><b>4.3</b> Adding uncertainty to growth parameters with a multivariate triangle distribution}</a></li>
<li class="chapter" data-level="4.4" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#adding-uncertainty-to-growth-parameters-with-statistical-copulas"><i class="fa fa-check"></i><b>4.4</b> Adding uncertainty to growth parameters with statistical copulas}</a></li>
<li class="chapter" data-level="4.5" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#converting-from-length-to-age-based-data---the-l2a-method"><i class="fa fa-check"></i><b>4.5</b> Converting from length to age based data - the <code>l2a()</code> method}</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="modelling-natural-mortality.html"><a href="modelling-natural-mortality.html"><i class="fa fa-check"></i><b>5</b> Modelling Natural Mortality</a>
<ul>
<li class="chapter" data-level="5.1" data-path="modelling-natural-mortality.html"><a href="modelling-natural-mortality.html#a4am---the-m-class"><i class="fa fa-check"></i><b>5.1</b> <code>a4aM</code> - The M class</a></li>
<li class="chapter" data-level="5.2" data-path="modelling-natural-mortality.html"><a href="modelling-natural-mortality.html#adding-uncertainty-to-natural-mortality-parameters-with-a-multivariate-normal-distribution"><i class="fa fa-check"></i><b>5.2</b> Adding uncertainty to natural mortality parameters with a multivariate normal distribution</a></li>
<li class="chapter" data-level="5.3" data-path="modelling-natural-mortality.html"><a href="modelling-natural-mortality.html#adding-uncertainty-to-natural-mortality-parameters-with-statistical-copulas"><i class="fa fa-check"></i><b>5.3</b> Adding uncertainty to natural mortality parameters with statistical copulas</a></li>
<li class="chapter" data-level="5.4" data-path="modelling-natural-mortality.html"><a href="modelling-natural-mortality.html#computing-natural-mortality-time-series---the-m-method"><i class="fa fa-check"></i><b>5.4</b> Computing natural mortality time series - the “m” method</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html"><i class="fa fa-check"></i><b>6</b> Stock assessment framework</a>
<ul>
<li class="chapter" data-level="6.1" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#maths-description"><i class="fa fa-check"></i><b>6.1</b> Maths description </a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#observations"><i class="fa fa-check"></i><b>6.1.1</b> Observations</a></li>
<li class="chapter" data-level="6.1.2" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#the-population-dynamics-model"><i class="fa fa-check"></i><b>6.1.2</b> The population dynamics model</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#classes-description"><i class="fa fa-check"></i><b>6.2</b> Classes Description </a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="submodel-structure.html"><a href="submodel-structure.html"><i class="fa fa-check"></i><b>7</b> Submodel structure </a>
<ul>
<li class="chapter" data-level="7.1" data-path="submodel-structure.html"><a href="submodel-structure.html#submodel-building-blocks-and-fundamental-r-formulas"><i class="fa fa-check"></i><b>7.1</b> Submodel building blocks and fundamental <code>R</code> formulas</a></li>
<li class="chapter" data-level="7.2" data-path="submodel-structure.html"><a href="submodel-structure.html#the-major-effects-available-for-modelling"><i class="fa fa-check"></i><b>7.2</b> The major effects available for modelling</a></li>
<li class="chapter" data-level="7.3" data-path="submodel-structure.html"><a href="submodel-structure.html#the-submodel-class-and-methods"><i class="fa fa-check"></i><b>7.3</b> The submodel class and methods</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="fitting.html"><a href="fitting.html"><i class="fa fa-check"></i><b>8</b> Fitting</a>
<ul>
<li class="chapter" data-level="8.1" data-path="fitting.html"><a href="fitting.html#fishing-mortality-submodel-f_ay"><i class="fa fa-check"></i><b>8.1</b> Fishing mortality submodel (<span class="math inline">\(F_{ay}\)</span>)</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="fitting.html"><a href="fitting.html#separable-model"><i class="fa fa-check"></i><b>8.1.1</b> Separable model</a></li>
<li class="chapter" data-level="8.1.2" data-path="fitting.html"><a href="fitting.html#constant-selectivity-for-contiguous-ages-or-years"><i class="fa fa-check"></i><b>8.1.2</b> Constant selectivity for contiguous ages or years</a></li>
<li class="chapter" data-level="8.1.3" data-path="fitting.html"><a href="fitting.html#time-blocks-selectivity"><i class="fa fa-check"></i><b>8.1.3</b> Time blocks selectivity</a></li>
<li class="chapter" data-level="8.1.4" data-path="fitting.html"><a href="fitting.html#time-changing-selectivity"><i class="fa fa-check"></i><b>8.1.4</b> Time changing selectivity</a></li>
<li class="chapter" data-level="8.1.5" data-path="fitting.html"><a href="fitting.html#closed-form-selection-pattern"><i class="fa fa-check"></i><b>8.1.5</b> Closed form selection pattern</a></li>
<li class="chapter" data-level="8.1.6" data-path="fitting.html"><a href="fitting.html#more-models-to-be-moved-to-its-own-section"><i class="fa fa-check"></i><b>8.1.6</b> More models [TO BE MOVED TO ITS OWN SECTION?]</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="fitting.html"><a href="fitting.html#abundance-indices-catchability-submodel-q_ays"><i class="fa fa-check"></i><b>8.2</b> Abundance indices catchability submodel (<span class="math inline">\(Q_{ays}\)</span>)</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="fitting.html"><a href="fitting.html#catchability-submodel-for-age-based-indices"><i class="fa fa-check"></i><b>8.2.1</b> Catchability submodel for age based indices</a></li>
<li class="chapter" data-level="8.2.2" data-path="fitting.html"><a href="fitting.html#catchability-submodel-for-age-aggregated-biomass-indices"><i class="fa fa-check"></i><b>8.2.2</b> Catchability submodel for age aggregated biomass indices</a></li>
<li class="chapter" data-level="8.2.3" data-path="fitting.html"><a href="fitting.html#catchability-submodel-for-single-age-indices"><i class="fa fa-check"></i><b>8.2.3</b> Catchability submodel for single age indices</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="fitting.html"><a href="fitting.html#stock-recruitment-submodel-r_y"><i class="fa fa-check"></i><b>8.3</b> Stock-recruitment submodel (<span class="math inline">\(R_y\)</span>)</a></li>
<li class="chapter" data-level="8.4" data-path="fitting.html"><a href="fitting.html#observation-variance-submodel-sigma2_ay-tau2_ays"><i class="fa fa-check"></i><b>8.4</b> Observation variance submodel (<span class="math inline">\(\{\sigma^2_{ay}, \tau^2_{ays}\}\)</span>)</a></li>
<li class="chapter" data-level="8.5" data-path="fitting.html"><a href="fitting.html#initial-year-abundance-submodel-n_ay1"><i class="fa fa-check"></i><b>8.5</b> Initial year abundance submodel (<span class="math inline">\(N_{a,y=1}\)</span>)</a></li>
<li class="chapter" data-level="8.6" data-path="fitting.html"><a href="fitting.html#data-weigthing"><i class="fa fa-check"></i><b>8.6</b> Data weigthing</a></li>
<li class="chapter" data-level="8.7" data-path="fitting.html"><a href="fitting.html#working-with-covariates"><i class="fa fa-check"></i><b>8.7</b> Working with covariates</a></li>
<li class="chapter" data-level="8.8" data-path="fitting.html"><a href="fitting.html#assessing-files"><i class="fa fa-check"></i><b>8.8</b> Assessing files</a></li>
<li class="chapter" data-level="8.9" data-path="fitting.html"><a href="fitting.html#missing-observations-in-the-catch-matrix-or-index"><i class="fa fa-check"></i><b>8.9</b> Missing observations in the catch matrix or index</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="diagnostics.html"><a href="diagnostics.html"><i class="fa fa-check"></i><b>9</b> Diagnostics </a>
<ul>
<li class="chapter" data-level="9.1" data-path="diagnostics.html"><a href="diagnostics.html#residuals"><i class="fa fa-check"></i><b>9.1</b> Residuals</a></li>
<li class="chapter" data-level="9.2" data-path="diagnostics.html"><a href="diagnostics.html#predictive-skill"><i class="fa fa-check"></i><b>9.2</b> Predictive skill</a></li>
<li class="chapter" data-level="9.3" data-path="diagnostics.html"><a href="diagnostics.html#aggreagted-catch-in-weight"><i class="fa fa-check"></i><b>9.3</b> Aggreagted catch in weight</a></li>
<li class="chapter" data-level="9.4" data-path="diagnostics.html"><a href="diagnostics.html#fit-summary-information-and-cross-validation-metrics"><i class="fa fa-check"></i><b>9.4</b> Fit summary, information and cross-validation metrics</a></li>
<li class="chapter" data-level="9.5" data-path="diagnostics.html"><a href="diagnostics.html#the-package-a4adiags"><i class="fa fa-check"></i><b>9.5</b> The package a4adiags</a></li>
<li class="chapter" data-level="9.6" data-path="diagnostics.html"><a href="diagnostics.html#retrospective-analysis"><i class="fa fa-check"></i><b>9.6</b> Retrospective analysis</a></li>
<li class="chapter" data-level="9.7" data-path="diagnostics.html"><a href="diagnostics.html#hindcast"><i class="fa fa-check"></i><b>9.7</b> Hindcast</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html"><i class="fa fa-check"></i><b>10</b> Predict and simulate </a>
<ul>
<li class="chapter" data-level="10.1" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#basic-functions"><i class="fa fa-check"></i><b>10.1</b> Basic functions}</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#simulate"><i class="fa fa-check"></i><b>10.1.1</b> simulate()</a></li>
<li class="chapter" data-level="10.1.2" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#genflquant"><i class="fa fa-check"></i><b>10.1.2</b> genFLQuant()</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#submodels"><i class="fa fa-check"></i><b>10.2</b> submodels</a></li>
<li class="chapter" data-level="10.3" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#predict"><i class="fa fa-check"></i><b>10.3</b> Predict</a></li>
<li class="chapter" data-level="10.4" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#simulate-1"><i class="fa fa-check"></i><b>10.4</b> Simulate</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><i class="fa fa-check"></i><b>11</b> The statistical catch-at-age stock assessment framework with Markov Chain Monte Carlo (MCMC) </a>
<ul>
<li class="chapter" data-level="11.1" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#the-mcmc-method-for-sca"><i class="fa fa-check"></i><b>11.1</b> The MCMC method for <code>sca</code></a></li>
<li class="chapter" data-level="11.2" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#diagnostics-with-coda"><i class="fa fa-check"></i><b>11.2</b> Diagnostics with CODA</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#traceplots"><i class="fa fa-check"></i><b>11.2.1</b> Traceplots</a></li>
<li class="chapter" data-level="11.2.2" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#autocorrelation-and-crosscorrelation-analysis"><i class="fa fa-check"></i><b>11.2.2</b> Autocorrelation and crosscorrelation analysis</a></li>
<li class="chapter" data-level="11.2.3" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#geweke-diagnostic"><i class="fa fa-check"></i><b>11.2.3</b> Geweke diagnostic</a></li>
<li class="chapter" data-level="11.2.4" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#cumulative-means"><i class="fa fa-check"></i><b>11.2.4</b> Cumulative means</a></li>
<li class="chapter" data-level="11.2.5" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#distribution-density"><i class="fa fa-check"></i><b>11.2.5</b> Distribution density</a></li>
<li class="chapter" data-level="11.2.6" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#gelman-rubin-statistic"><i class="fa fa-check"></i><b>11.2.6</b> Gelman-Rubin statistic</a></li>
<li class="chapter" data-level="11.2.7" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#acceptance-rate"><i class="fa fa-check"></i><b>11.2.7</b> Acceptance rate</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#admbs-arguments-to-tune-the-mcmc-algorithm"><i class="fa fa-check"></i><b>11.3</b> <code>ADMB</code>’s arguments to tune the MCMC algorithm</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#thinning-rate"><i class="fa fa-check"></i><b>11.3.1</b> Thinning rate</a></li>
<li class="chapter" data-level="11.3.2" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#mcscale-and-mcnoscale"><i class="fa fa-check"></i><b>11.3.2</b> mcscale and mcnoscale</a></li>
<li class="chapter" data-level="11.3.3" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#mcprobe"><i class="fa fa-check"></i><b>11.3.3</b> mcprobe</a></li>
<li class="chapter" data-level="11.3.4" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#mcrb"><i class="fa fa-check"></i><b>11.3.4</b> mcrb</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-markov-chain-monte-carlo-mcmc.html#references"><i class="fa fa-check"></i><b>11.4</b> References:</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html"><i class="fa fa-check"></i><b>12</b> Projections and harvest control rules</a>
<ul>
<li class="chapter" data-level="12.0.1" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#references-1"><i class="fa fa-check"></i><b>12.0.1</b> References:</a></li>
<li class="chapter" data-level="12.1" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#simple-workflow"><i class="fa fa-check"></i><b>12.1</b> Simple workflow</a></li>
<li class="chapter" data-level="12.2" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#initial-condition-assumptions-check-fwdwindow"><i class="fa fa-check"></i><b>12.2</b> Initial condition assumptions [CHECK fwdWindow]</a></li>
<li class="chapter" data-level="12.3" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#scenarios"><i class="fa fa-check"></i><b>12.3</b> Scenarios</a></li>
<li class="chapter" data-level="12.4" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#relative-scenarios"><i class="fa fa-check"></i><b>12.4</b> Relative scenarios</a></li>
<li class="chapter" data-level="12.5" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#limits"><i class="fa fa-check"></i><b>12.5</b> Limits</a></li>
<li class="chapter" data-level="12.6" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#harvest-control-rule"><i class="fa fa-check"></i><b>12.6</b> Harvest Control Rule</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="reference-points.html"><a href="reference-points.html"><i class="fa fa-check"></i><b>13</b> Reference Points</a>
<ul>
<li class="chapter" data-level="13.1" data-path="reference-points.html"><a href="reference-points.html#yield-per-recruit-reference-points"><i class="fa fa-check"></i><b>13.1</b> Yield per recruit reference points</a></li>
<li class="chapter" data-level="13.2" data-path="reference-points.html"><a href="reference-points.html#stock-recruitment-relationship-based-reference-points"><i class="fa fa-check"></i><b>13.2</b> Stock recruitment relationship based reference points</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="reference-points.html"><a href="reference-points.html#stock-recruitment-after-fitting-the-stock-assessment-model"><i class="fa fa-check"></i><b>13.2.1</b> Stock recruitment after fitting the stock assessment model</a></li>
<li class="chapter" data-level="13.2.2" data-path="reference-points.html"><a href="reference-points.html#stock-recruitment-during-fitting-the-stock-assessment-model"><i class="fa fa-check"></i><b>13.2.2</b> Stock recruitment during fitting the stock assessment model</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="reference-points.html"><a href="reference-points.html#economics-reference-points"><i class="fa fa-check"></i><b>13.3</b> Economics reference points</a></li>
<li class="chapter" data-level="13.4" data-path="reference-points.html"><a href="reference-points.html#computing-user-specific-reference-points"><i class="fa fa-check"></i><b>13.4</b> Computing user specific reference points</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="propagate-uncertainty-into-stock-assessment.html"><a href="propagate-uncertainty-into-stock-assessment.html"><i class="fa fa-check"></i><b>14</b> Propagate uncertainty into stock assessment</a></li>
<li class="chapter" data-level="15" data-path="modelling-fleet-selectivity.html"><a href="modelling-fleet-selectivity.html"><i class="fa fa-check"></i><b>15</b> Modelling fleet selectivity</a></li>
<li class="chapter" data-level="16" data-path="modelling-spatial-effects.html"><a href="modelling-spatial-effects.html"><i class="fa fa-check"></i><b>16</b> Modelling spatial effects</a></li>
<li class="chapter" data-level="17" data-path="sections-to-be-added.html"><a href="sections-to-be-added.html"><i class="fa fa-check"></i><b>17</b> Sections to be added!?</a></li>
<li class="chapter" data-level="18" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html"><i class="fa fa-check"></i><b>18</b> Annex - stock assessment workflow</a>
<ul>
<li class="chapter" data-level="18.1" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#the-mean-model"><i class="fa fa-check"></i><b>18.1</b> The “mean” model</a></li>
<li class="chapter" data-level="18.2" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#the-age-effects"><i class="fa fa-check"></i><b>18.2</b> The age effects</a></li>
<li class="chapter" data-level="18.3" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#year-effect-on-fishing-mortality"><i class="fa fa-check"></i><b>18.3</b> Year effect on fishing mortality</a></li>
<li class="chapter" data-level="18.4" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#year-effect-on-catchability"><i class="fa fa-check"></i><b>18.4</b> Year effect on catchability</a></li>
<li class="chapter" data-level="18.5" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#the-initial-year-population-abundance-model-aka-n1"><i class="fa fa-check"></i><b>18.5</b> The initial year population abundance model, aka N1</a></li>
<li class="chapter" data-level="18.6" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#the-stock-recruitment-submodel"><i class="fa fa-check"></i><b>18.6</b> The stock recruitment submodel</a></li>
<li class="chapter" data-level="18.7" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#the-variance-submodel"><i class="fa fa-check"></i><b>18.7</b> The variance submodel</a></li>
<li class="chapter" data-level="18.8" data-path="annex---stock-assessment-workflow.html"><a href="annex---stock-assessment-workflow.html#final-comments"><i class="fa fa-check"></i><b>18.8</b> Final comments</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fish stock assessment with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="fitting" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">8</span> Fitting<a href="fitting.html#fitting" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The <code>a4a</code> stock assessment framework is implemented in <code>R</code> through the method <code>sca()</code>. The method call requires as a minimum a FLStock object and a FLIndices object, in which case the default submodels will be set by the method.</p>
<p>Having described building blocks, basic formulations and effects available to build a submodel’s model, it’s important to look into specific formulations and relate them to commonly known representations. Note that although a large number of formulations are available for each submodel, the user must carefuly decide on the full stock assessment model being build and avoid over-paramerizing. Over-parametrization may lead to non-convergence, but may also end up not being very useful for prediction/forecasting, which is one of the main objectives of stock assessment.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="fitting.html#cb1-1" tabindex="-1"></a><span class="fu">data</span>(ple4)</span>
<span id="cb1-2"><a href="fitting.html#cb1-2" tabindex="-1"></a><span class="fu">data</span>(ple4.indices)</span>
<span id="cb1-3"><a href="fitting.html#cb1-3" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices)</span>
<span id="cb1-4"><a href="fitting.html#cb1-4" tabindex="-1"></a>stk <span class="ot">&lt;-</span> ple4 <span class="sc">+</span> fit</span>
<span id="cb1-5"><a href="fitting.html#cb1-5" tabindex="-1"></a><span class="fu">plot</span>(stk)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>By calling the fitted object the default submodel formulas are printed in the console:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="fitting.html#cb2-1" tabindex="-1"></a>fit</span></code></pre></div>
<pre><code>## a4a model fit for: PLE 
## 
## Call:
## .local(stock = stock, indices = indices)
## 
## Time used:
##  Pre-processing     Running a4a Post-processing           Total 
##        1.083177       15.839170        0.221837       17.144184 
## 
## Submodels:
##   fmodel: ~te(age, year, k = c(6, 30), bs = &quot;tp&quot;) + s(age, k = 6)
##  srmodel: ~factor(year)
##  n1model: ~s(age, k = 3)
##   qmodel:
##     BTS-Isis-early:                  ~s(age, k = 6)
##     BTS-Combined (ISIS and TRIDENS): ~s(age, k = 6)
##     SNS:                             ~s(age, k = 5)
##     BTS-Combined (all):              ~s(age, k = 6)
##     IBTS_Q3:                         ~s(age, k = 6)
##     IBTS_Q1:                         ~s(age, k = 5)
##   vmodel:
##     catch:                           ~s(age, k = 3)
##     BTS-Isis-early:                  ~1
##     BTS-Combined (ISIS and TRIDENS): ~1
##     SNS:                             ~1
##     BTS-Combined (all):              ~1
##     IBTS_Q3:                         ~1
##     IBTS_Q1:                         ~1</code></pre>
<p>To set specific submodels the user has to write the relevant R formula and include it in the call. The arguments for each submodel are self-explanatory: fishing mortality is ‘fmodel’, indices’ catchability is ‘qmodel’, stock-recruitment is ‘srmodel’, observation variance is ‘vmodel’ and for initial year’s abundance is ‘n1model’. The following model comes closer to the official stock assessment of North Sea plaice, as such we’ll name it <span class="math inline">\(0\)</span> and keep it for future comparisons:</p>
<p>For future referencing we’ll start with a base fit to be used for future comparisons, named fit 0.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="fitting.html#cb4-1" tabindex="-1"></a>fmod0 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">10</span>)<span class="sc">+</span><span class="fu">te</span>(age, year, <span class="at">k=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">8</span>))</span>
<span id="cb4-2"><a href="fitting.html#cb4-2" tabindex="-1"></a>qmod0 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">4</span>), <span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">3</span>), <span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">3</span>)<span class="sc">+</span>year, <span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">3</span>), <span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">4</span>), <span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">6</span>))</span>
<span id="cb4-3"><a href="fitting.html#cb4-3" tabindex="-1"></a>srmod0 <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">20</span>)</span>
<span id="cb4-4"><a href="fitting.html#cb4-4" tabindex="-1"></a>vmod0 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>), <span class="sc">~</span><span class="dv">1</span>,  <span class="sc">~</span><span class="dv">1</span>, <span class="sc">~</span><span class="dv">1</span>, <span class="sc">~</span><span class="dv">1</span>, <span class="sc">~</span><span class="dv">1</span>, <span class="sc">~</span><span class="dv">1</span>, <span class="sc">~</span><span class="dv">1</span>)</span>
<span id="cb4-5"><a href="fitting.html#cb4-5" tabindex="-1"></a>n1mod0 <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">3</span>)</span>
<span id="cb4-6"><a href="fitting.html#cb4-6" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmod0, <span class="at">qmodel=</span>qmod0, <span class="at">srmodel=</span>srmod0, <span class="at">n1model=</span>n1mod0, <span class="at">vmodel=</span>vmod0)</span>
<span id="cb4-7"><a href="fitting.html#cb4-7" tabindex="-1"></a>stk0 <span class="ot">&lt;-</span> ple4 <span class="sc">+</span> fit0</span>
<span id="cb4-8"><a href="fitting.html#cb4-8" tabindex="-1"></a><span class="fu">plot</span>(stk0)</span></code></pre></div>
<p><img src="_main_files/figure-html/fit0-1.png" width="672" /></p>
<p>As before by calling the fitted object submodels’ formulas are printed in the console:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="fitting.html#cb5-1" tabindex="-1"></a>fit</span></code></pre></div>
<pre><code>## a4a model fit for: PLE 
## 
## Call:
## .local(stock = stock, indices = indices)
## 
## Time used:
##  Pre-processing     Running a4a Post-processing           Total 
##        1.083177       15.839170        0.221837       17.144184 
## 
## Submodels:
##   fmodel: ~te(age, year, k = c(6, 30), bs = &quot;tp&quot;) + s(age, k = 6)
##  srmodel: ~factor(year)
##  n1model: ~s(age, k = 3)
##   qmodel:
##     BTS-Isis-early:                  ~s(age, k = 6)
##     BTS-Combined (ISIS and TRIDENS): ~s(age, k = 6)
##     SNS:                             ~s(age, k = 5)
##     BTS-Combined (all):              ~s(age, k = 6)
##     IBTS_Q3:                         ~s(age, k = 6)
##     IBTS_Q1:                         ~s(age, k = 5)
##   vmodel:
##     catch:                           ~s(age, k = 3)
##     BTS-Isis-early:                  ~1
##     BTS-Combined (ISIS and TRIDENS): ~1
##     SNS:                             ~1
##     BTS-Combined (all):              ~1
##     IBTS_Q3:                         ~1
##     IBTS_Q1:                         ~1</code></pre>
<p>The method <code>sca</code> has other arguments which may be set by the user:</p>
<ul>
<li>[covar:] a `FLQuant} with covariates;</li>
<li>[wkdir:] a folder (character) where the files will be saved for posterior inspection by the user;</li>
<li>[verbose:] be more verbose (logical);</li>
<li>[fit:] type of fit (character),
<ul>
<li>‘MP’ runs the minimizer without trying to invert the hessian and as such doesn’t return the covariance matrix of the parameters, normally used inside loops where parameter variance may not be relevant;</li>
<li>‘assessment’ runs minimizer and inverts hessian, returns the covariance matrix of the estimated parameters and the convergence criteria set in ;</li>
<li>‘MCMC’ runs ’s MCMC fit</li>
</ul></li>
<li>[center:] shall observations be centered before fitting (logical);</li>
<li>[mcmc:] ’s MCMC arguments (character vector), must be paired with `fit=“MCMC”}.</li>
</ul>
<p>There are a set of methods for <code>a4a</code> fit objects which help manipulating <code>sca()</code> results, namely:</p>
<ul>
<li>[+:] update the stock object with the fitted fishing mortalities, population abundance and catch in numbers at age;</li>
</ul>
<div id="fishing-mortality-submodel-f_ay" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Fishing mortality submodel (<span class="math inline">\(F_{ay}\)</span>)<a href="fitting.html#fishing-mortality-submodel-f_ay" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will now take a look at some examples for <span class="math inline">\(F\)</span> models and the forms that we can get.</p>
<p>A non-separable model, where we consider age and year to interact can be modeled using a smooth interaction term in the F model using a tensor product of cubic splines with the <code>te</code> method (Figure <a href="fitting.html#fig:te1">8.1</a>), again borrowed from <a href="http://cran.r-project.org/web/packages/mgcv/index.html">mgcv</a>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="fitting.html#cb7-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">te</span>(age, year, <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">20</span>))</span>
<span id="cb7-2"><a href="fitting.html#cb7-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], fmod)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="fitting.html#cb8-1" tabindex="-1"></a><span class="fu">wireframe</span>(<span class="fu">harvest</span>(fit), <span class="at">zlab=</span><span class="st">&quot;F&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:te1"></span>
<img src="_main_files/figure-html/te1-1.png" alt="Fishing mortality smoothed non-separable model" width="672" />
<p class="caption">
Figure 8.1: Fishing mortality smoothed non-separable model
</p>
</div>
<p>In the last examples the fishing mortalities (Fs’) are linked across age and time. What if we want to free up a specific age class because in the residuals we see a consistent pattern. This can happen, for example, if the spatial distribution of juveniles is disconnected to the distribution of adults. The fishery focuses on the adult fish, and therefore the the F on young fish is a function of the distribution of the juveniles and could deserve a specific model. This can be achieved by adding a component for the year effect on age 1 (Figure <a href="fitting.html#fig:age1">8.2</a>).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="fitting.html#cb9-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">te</span>(age, year, <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">20</span>)) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">by =</span> <span class="fu">as.numeric</span>(age<span class="sc">==</span><span class="dv">1</span>))</span>
<span id="cb9-2"><a href="fitting.html#cb9-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], fmod)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="fitting.html#cb10-1" tabindex="-1"></a><span class="fu">wireframe</span>(<span class="fu">harvest</span>(fit), <span class="at">zlab=</span><span class="st">&quot;F&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:age1"></span>
<img src="_main_files/figure-html/age1-1.png" alt="Fishing mortality age-year interaction model with extra age 1 smoother." width="672" />
<p class="caption">
Figure 8.2: Fishing mortality age-year interaction model with extra age 1 smoother.
</p>
</div>
<div id="separable-model" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Separable model<a href="fitting.html#separable-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One of the most useful models for fishing mortality is one in which ‘age’ and ‘year’ effects are independent, that is, where the shape of the selection pattern does not change over time, but the overall level of fishing mortality do. Commonly called a ‘separable model’.</p>
<p>A full separable model in <code>a4a</code> is written using the <code>factor</code> function which converts age and year effects into categorical values, forcing a different coefficient to be estimated for each level of both effects. This model has <code>age x year</code> number of parameters.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="fitting.html#cb11-1" tabindex="-1"></a>fmod1 <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">factor</span>(age) <span class="sc">+</span> <span class="fu">factor</span>(year)</span>
<span id="cb11-2"><a href="fitting.html#cb11-2" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmod1, <span class="at">fit=</span><span class="st">&quot;MP&quot;</span>)</span></code></pre></div>
<p>One can reduce the number of parameters and add dependency along both effects, although still keeping independence of each other, by using smoothers rather than <code>factor</code>. We’ll use a (unpenalised) thin plate spline provided by package <a href="http://cran.r-project.org/web/packages/mgcv/">mgcv</a> method <code>s()</code>. We’re using the North Sea Plaice data, and since it has 10 ages we will use a simple rule of thumb that the spline should have fewer than <span class="math inline">\(\frac{10}{2} = 5\)</span> degrees of freedom, and so we opt for 4 degrees of freedom. We will also do the same for year and model the change in <span class="math inline">\(F\)</span> through time as a smoother with 20 degrees of freedom.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="fitting.html#cb12-1" tabindex="-1"></a>fmod2 <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">20</span>)</span>
<span id="cb12-2"><a href="fitting.html#cb12-2" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmod2, <span class="at">fit=</span><span class="st">&quot;MP&quot;</span>)</span></code></pre></div>
<p>An interesting extension of the separable model is the ‘double separable’ where a third factor or smoother is added for the cohort effect.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="fitting.html#cb13-1" tabindex="-1"></a>fmod3 <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">20</span>) <span class="sc">+</span> <span class="fu">s</span>(<span class="fu">as.numeric</span>(year<span class="sc">-</span>age), <span class="at">k=</span><span class="dv">10</span>)</span>
<span id="cb13-2"><a href="fitting.html#cb13-2" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmod3, <span class="at">fit=</span><span class="st">&quot;MP&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: *** ~s(age, k = 4) + s(year, k = 20) + s(as.numeric(year - age),     k = 10) has 1 too many parameter(s)!!
##     i will remove the redundant ones:
##  s(as.numeric(year - age)).9</code></pre>
<p>Figures <a href="fitting.html#fig:sep00">8.3</a> and <a href="fitting.html#fig:sep01">8.4</a> depicts the three models selectivities for each year. Each separable model has a single selectivity that changes it’s overall scale in each year, while the double separable introduces some variability over time by modeling the cohort factor.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="fitting.html#cb15-1" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">factor=</span><span class="fu">harvest</span>(fit1), <span class="at">smooth=</span><span class="fu">harvest</span>(fit2), <span class="at">double=</span><span class="fu">harvest</span>(fit3))</span>
<span id="cb15-2"><a href="fitting.html#cb15-2" tabindex="-1"></a>pset <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">strip.background=</span><span class="fu">list</span>(<span class="at">col=</span><span class="st">&quot;gray90&quot;</span>))</span>
<span id="cb15-3"><a href="fitting.html#cb15-3" tabindex="-1"></a><span class="fu">xyplot</span>(data<span class="sc">~</span>age<span class="sc">|</span>qname, <span class="at">groups=</span>year, <span class="at">data=</span>flqs, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">col=</span><span class="dv">1</span>, <span class="at">layout=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="at">ylab=</span><span class="st">&quot;fishing mortality&quot;</span>, <span class="at">par.settings=</span>pset)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:sep00"></span>
<img src="_main_files/figure-html/sep00-1.png" alt="Selection pattern of separable models. Each line represents the selection pattern in a specific year. Independent age and year effects (factor), internally dependent age and year (smooth), double separable (double)." width="672" />
<p class="caption">
Figure 8.3: Selection pattern of separable models. Each line represents the selection pattern in a specific year. Independent age and year effects (factor), internally dependent age and year (smooth), double separable (double).
</p>
</div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="fitting.html#cb16-1" tabindex="-1"></a><span class="fu">wireframe</span>(data<span class="sc">~</span>age<span class="sc">+</span>year<span class="sc">|</span>qname, <span class="at">data=</span><span class="fu">as.data.frame</span>(flqs), <span class="at">layout=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:sep01"></span>
<img src="_main_files/figure-html/sep01-1.png" alt="Fishing mortality of separable models. Independent age and year effects (factor), internally dependent age and year (smooth), double separable (double)." width="672" />
<p class="caption">
Figure 8.4: Fishing mortality of separable models. Independent age and year effects (factor), internally dependent age and year (smooth), double separable (double).
</p>
</div>
</div>
<div id="constant-selectivity-for-contiguous-ages-or-years" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Constant selectivity for contiguous ages or years<a href="fitting.html#constant-selectivity-for-contiguous-ages-or-years" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To set these models we’ll use the method <code>replace()</code> to define which ages or years will be modelled together with a single coefficient. The following example shows <code>replace()</code> in operation. The dependent variables used in the model will be changed and attributed the same age or year, as such during the fit observations of those age or year with will be seen as replicates. One can think of it as sharing the same mean value, which will be estimated by the model.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="fitting.html#cb17-1" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb17-2"><a href="fitting.html#cb17-2" tabindex="-1"></a><span class="co"># last age same as previous</span></span>
<span id="cb17-3"><a href="fitting.html#cb17-3" tabindex="-1"></a><span class="fu">replace</span>(age, age<span class="sc">&gt;</span><span class="dv">9</span>, <span class="dv">9</span>)</span></code></pre></div>
<pre><code>##  [1] 1 2 3 4 5 6 7 8 9 9</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="fitting.html#cb19-1" tabindex="-1"></a><span class="co"># all ages after age 6</span></span>
<span id="cb19-2"><a href="fitting.html#cb19-2" tabindex="-1"></a><span class="fu">replace</span>(age, age<span class="sc">&gt;</span><span class="dv">6</span>, <span class="dv">6</span>)</span></code></pre></div>
<pre><code>##  [1] 1 2 3 4 5 6 6 6 6 6</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="fitting.html#cb21-1" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="dv">1950</span><span class="sc">:</span><span class="dv">2010</span></span>
<span id="cb21-2"><a href="fitting.html#cb21-2" tabindex="-1"></a><span class="fu">replace</span>(year, year<span class="sc">&gt;</span><span class="dv">2005</span>, <span class="dv">2005</span>)</span></code></pre></div>
<pre><code>##  [1] 1950 1951 1952 1953 1954 1955 1956 1957 1958 1959 1960 1961
## [13] 1962 1963 1964 1965 1966 1967 1968 1969 1970 1971 1972 1973
## [25] 1974 1975 1976 1977 1978 1979 1980 1981 1982 1983 1984 1985
## [37] 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1996 1997
## [49] 1998 1999 2000 2001 2002 2003 2004 2005 2005 2005 2005 2005
## [61] 2005</code></pre>
<p>In the <span class="math inline">\(F\)</span> submodel one can use this method to fix the estimation of <span class="math inline">\(F\)</span> in the plus group to be the same as in the last non-aggregated age.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="fitting.html#cb23-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(<span class="fu">replace</span>(age, age<span class="sc">&gt;</span><span class="dv">9</span>, <span class="dv">9</span>), <span class="at">k=</span><span class="dv">4</span>) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">20</span>)</span>
<span id="cb23-2"><a href="fitting.html#cb23-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, fmod)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="fitting.html#cb24-1" tabindex="-1"></a><span class="fu">wireframe</span>(<span class="fu">harvest</span>(fit), <span class="at">zlab=</span><span class="st">&quot;F&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:ctsselage"></span>
<img src="_main_files/figure-html/ctsselage-1.png" alt="F-at-age fixed above age 9" width="672" />
<p class="caption">
Figure 8.5: F-at-age fixed above age 9
</p>
</div>
<p>Or estimate the average <span class="math inline">\(F\)</span> in the most recent years, instead of averaging after the assessment to compute the <em>statu quo</em> selection pattern.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="fitting.html#cb25-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>) <span class="sc">+</span> <span class="fu">s</span>(<span class="fu">replace</span>(year, year<span class="sc">&gt;</span><span class="dv">2013</span>, <span class="dv">2013</span>), <span class="at">k=</span><span class="dv">20</span>)</span>
<span id="cb25-2"><a href="fitting.html#cb25-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, fmod)</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="fitting.html#cb26-1" tabindex="-1"></a><span class="fu">wireframe</span>(data<span class="sc">~</span>age<span class="sc">+</span>year, <span class="at">data=</span><span class="fu">harvest</span>(fit)[,<span class="fu">ac</span>(<span class="dv">2010</span><span class="sc">:</span><span class="dv">2017</span>)], <span class="at">screen=</span><span class="fu">c</span>(<span class="at">z=</span><span class="sc">-</span><span class="dv">130</span>, <span class="at">y=</span><span class="dv">0</span>, <span class="at">x=</span><span class="sc">-</span><span class="dv">60</span>), <span class="at">zlab=</span><span class="st">&quot;F&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:ctsselyear"></span>
<img src="_main_files/figure-html/ctsselyear-1.png" alt="F-at-age fixed for the most recent 5 years" width="672" />
<p class="caption">
Figure 8.6: F-at-age fixed for the most recent 5 years
</p>
</div>
</div>
<div id="time-blocks-selectivity" class="section level3 hasAnchor" number="8.1.3">
<h3><span class="header-section-number">8.1.3</span> Time blocks selectivity<a href="fitting.html#time-blocks-selectivity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To define blocks of data <code>sca()</code> uses the method <code>breakpts()</code>, which creates a factor from a vector with levels defined by the second argument.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="fitting.html#cb27-1" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="dv">1950</span><span class="sc">:</span><span class="dv">2010</span></span>
<span id="cb27-2"><a href="fitting.html#cb27-2" tabindex="-1"></a><span class="co"># two levels separated in 2000</span></span>
<span id="cb27-3"><a href="fitting.html#cb27-3" tabindex="-1"></a><span class="fu">breakpts</span>(year, <span class="dv">2000</span>)</span></code></pre></div>
<pre><code>##  [1] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
##  [6] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [11] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [16] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [21] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [26] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [31] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [36] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [41] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [46] (1949,2000] (1949,2000] (1949,2000] (1949,2000] (1949,2000]
## [51] (1949,2000] (2000,2010] (2000,2010] (2000,2010] (2000,2010]
## [56] (2000,2010] (2000,2010] (2000,2010] (2000,2010] (2000,2010]
## [61] (2000,2010]
## Levels: (1949,2000] (2000,2010]</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="fitting.html#cb29-1" tabindex="-1"></a><span class="co"># five periods with equal interval</span></span>
<span id="cb29-2"><a href="fitting.html#cb29-2" tabindex="-1"></a><span class="fu">breakpts</span>(year, <span class="fu">seq</span>(<span class="dv">1949</span>, <span class="dv">2010</span>, <span class="at">length=</span><span class="dv">6</span>))</span></code></pre></div>
<pre><code>##  [1] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
##  [4] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
##  [7] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
## [10] (1949,1961.2]   (1949,1961.2]   (1949,1961.2]  
## [13] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [16] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [19] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [22] (1961.2,1973.4] (1961.2,1973.4] (1961.2,1973.4]
## [25] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [28] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [31] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [34] (1973.4,1985.6] (1973.4,1985.6] (1973.4,1985.6]
## [37] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [40] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [43] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [46] (1985.6,1997.8] (1985.6,1997.8] (1985.6,1997.8]
## [49] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [52] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [55] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [58] (1997.8,2010]   (1997.8,2010]   (1997.8,2010]  
## [61] (1997.8,2010]  
## 5 Levels: (1949,1961.2] (1961.2,1973.4] ... (1997.8,2010]</code></pre>
<p>Note <code>seq()</code> computes ‘left-open’ intervals, which means that to include 1950 the sequence must start one year earlier.</p>
<p>These methods can be used to create discrete time series, for which a different selection pattern is allowed in each block. This is called an interaction in statistical modelling parlance, and typically a <code>*</code> denotes an interaction term; for smoothers an interaction is achieved using the <code>by</code> argument. When this argument is a <code>factor</code> a replicate of the smooth is produced for each factor level.</p>
<p>In the next case we’ll use the <code>breakpts()</code> to split the time series at 1990, although keeping the same shape in both periods, a thin plate spline with 3 knots (Figure <a href="fitting.html#fig:brk">8.7</a>).</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="fitting.html#cb31-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">3</span>, <span class="at">by =</span> <span class="fu">breakpts</span>(year, <span class="dv">1990</span>))</span>
<span id="cb31-2"><a href="fitting.html#cb31-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, fmod)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:brk"></span>
<img src="_main_files/figure-html/brk-1.png" alt="F-at-age in two periods using in both cases a thin plate spline with 3 knots" width="672" />
<p class="caption">
Figure 8.7: F-at-age in two periods using in both cases a thin plate spline with 3 knots
</p>
</div>
</div>
<div id="time-changing-selectivity" class="section level3 hasAnchor" number="8.1.4">
<h3><span class="header-section-number">8.1.4</span> Time changing selectivity<a href="fitting.html#time-changing-selectivity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In many cases, it may be desirable to allow the selection pattern to evolve over time, from year to year. Again there are several ways to do this, one way is to estimate a mean selection pattern, while also allowing F to vary over time for each age. This is like a seperate smoother over year, with ‘age blocks’ so, looking back at previous examples, we have:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="fitting.html#cb32-1" tabindex="-1"></a>fmodel <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">15</span>, <span class="at">by =</span> <span class="fu">factor</span>(age)) <span class="sc">+</span> <span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">4</span>)</span></code></pre></div>
<p>This is a type of interaction between age and year, but the only connection (or correlation) across ages is via the smoother on age, however there are still 15 degrees of freedom for each age, so the model 5 x 15 + 4 = 69 degrees of freedom. To include correlation across ages and years together then the tensor product (<code>te()</code> function) is used, this has the effect of restricting the flexibility of the model for F. In the following, there is a smoother in 2 dimensions (age and year) where there is 5 degrees of freedom in the age direction, and 15 in the year dimension, resulting in a total of 5 x 15 = 65 degrees of freedom</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="fitting.html#cb33-1" tabindex="-1"></a>fmodel <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">te</span>(age, year, <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">15</span>))</span></code></pre></div>
<p>Often the above formulations provide too much flexibility, and a more complicated, but simpler model is preferable:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="fitting.html#cb34-1" tabindex="-1"></a>fmodel <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">4</span>) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">15</span>) <span class="sc">+</span> <span class="fu">te</span>(age, year, <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>))</span></code></pre></div>
<p>in the above model, the main effects for age and year still have similar flexibility to the full tensor model, however, the interaction (or the change in F at age over time) has been restricted, so that the full model now has 4 + 15 + 3 x 5 = 34 degrees of freedom.</p>
</div>
<div id="closed-form-selection-pattern" class="section level3 hasAnchor" number="8.1.5">
<h3><span class="header-section-number">8.1.5</span> Closed form selection pattern<a href="fitting.html#closed-form-selection-pattern" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One can use a closed form for the selection pattern. The only requirement is to be able to write it as a formula, the example below uses a logistic form.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="fitting.html#cb35-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">I</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>age)))</span>
<span id="cb35-2"><a href="fitting.html#cb35-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, fmod)</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="fitting.html#cb36-1" tabindex="-1"></a><span class="fu">wireframe</span>(<span class="fu">harvest</span>(fit), <span class="at">zlab=</span><span class="st">&quot;F&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:logistic"></span>
<img src="_main_files/figure-html/logistic-1.png" alt="F-at-age logistic" width="672" />
<p class="caption">
Figure 8.8: F-at-age logistic
</p>
</div>
</div>
<div id="more-models-to-be-moved-to-its-own-section" class="section level3 hasAnchor" number="8.1.6">
<h3><span class="header-section-number">8.1.6</span> More models [TO BE MOVED TO ITS OWN SECTION?]<a href="fitting.html#more-models-to-be-moved-to-its-own-section" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>More complicated models can be built with these tools. For example, Figure <a href="fitting.html#fig:ageind">8.9</a> shows a model where the age effect is modelled as a smoother (the same thin plate spline) throughout years but independent from each other.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="fitting.html#cb37-1" tabindex="-1"></a>fmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">factor</span>(age) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">10</span>, <span class="at">by =</span> <span class="fu">breakpts</span>(age, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>)))</span>
<span id="cb37-2"><a href="fitting.html#cb37-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, fmod)</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="fitting.html#cb38-1" tabindex="-1"></a><span class="fu">wireframe</span>(<span class="fu">harvest</span>(fit), <span class="at">zlab=</span><span class="st">&quot;F&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:ageind"></span>
<img src="_main_files/figure-html/ageind-1.png" alt="F-at-age as thin plate spline with 3 knots for each age" width="672" />
<p class="caption">
Figure 8.9: F-at-age as thin plate spline with 3 knots for each age
</p>
</div>
<p>A quite complex model that implements a cohort effect can be set through the following formula. Figure <a href="fitting.html#fig:coh">8.10</a> shows the resulting fishing mortality. Note that in this case we end up with a variable F pattern over time, but rather than using 4 * 10 = 40 parameters, it uses, 4 + 10 + 10 = 24.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="fitting.html#cb39-1" tabindex="-1"></a>fmodel <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(age, <span class="at">k =</span> <span class="dv">4</span>) <span class="sc">+</span> <span class="fu">s</span>(<span class="fu">pmax</span>(year <span class="sc">-</span> age, <span class="dv">1957</span>), <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span> <span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb39-2"><a href="fitting.html#cb39-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmodel)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:coh"></span>
<img src="_main_files/figure-html/coh-1.png" alt="F-at-age with a cohort effect." width="672" />
<p class="caption">
Figure 8.10: F-at-age with a cohort effect.
</p>
</div>
</div>
</div>
<div id="abundance-indices-catchability-submodel-q_ays" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Abundance indices catchability submodel (<span class="math inline">\(Q_{ays}\)</span>)<a href="fitting.html#abundance-indices-catchability-submodel-q_ays" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The catchability submodel is set up the same way as the <span class="math inline">\(F\)</span> submodel and the tools available are the same. The only difference is that the submodel is set up as a list of formulas, where each formula relates with one abundance index. There’s no limitation in the number of indices or type that can be used for a fit. It’s the analyst that has to decide based on her/his expertise and knowledge of the stock and fleet dynamics.</p>
<div id="catchability-submodel-for-age-based-indices" class="section level3 hasAnchor" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Catchability submodel for age based indices<a href="fitting.html#catchability-submodel-for-age-based-indices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A first model is simply a dummy effect on age, which means that a coefficient will be estimated for each age. Note that this kind of model considers that levels of the factor are independent (Figure <a href="fitting.html#fig:dummyage">8.11</a>).</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="fitting.html#cb40-1" tabindex="-1"></a>qmod <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="sc">~</span><span class="fu">factor</span>(age))</span>
<span id="cb40-2"><a href="fitting.html#cb40-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">qmodel=</span>qmod)</span>
<span id="cb40-3"><a href="fitting.html#cb40-3" tabindex="-1"></a>qhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit)<span class="sc">$</span>qmodel[[<span class="dv">1</span>]]</span>
<span id="cb40-4"><a href="fitting.html#cb40-4" tabindex="-1"></a><span class="fu">wireframe</span>(qhat, <span class="at">zlab=</span><span class="st">&quot;q&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:dummyage"></span>
<img src="_main_files/figure-html/dummyage-1.png" alt="Catchability age independent model" width="672" />
<p class="caption">
Figure 8.11: Catchability age independent model
</p>
</div>
<p>If one considers catchability at a specific age to be dependent on catchability on the other ages, similar to a selectivity modelling approach, one option is to use a smoother at age, and let the data ‘speak’ regarding the shape (Figure <a href="fitting.html#fig:smoothage">8.12</a>).</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="fitting.html#cb41-1" tabindex="-1"></a>qmod <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="sc">~</span> <span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>))</span>
<span id="cb41-2"><a href="fitting.html#cb41-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">qmodel=</span>qmod)</span>
<span id="cb41-3"><a href="fitting.html#cb41-3" tabindex="-1"></a>qhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit)<span class="sc">$</span>qmodel[[<span class="dv">1</span>]]</span>
<span id="cb41-4"><a href="fitting.html#cb41-4" tabindex="-1"></a><span class="fu">wireframe</span>(qhat, <span class="at">zlab=</span><span class="st">&quot;q&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:smoothage"></span>
<img src="_main_files/figure-html/smoothage-1.png" alt="Catchability smoother age model" width="672" />
<p class="caption">
Figure 8.12: Catchability smoother age model
</p>
</div>
<p>Finally, one may want to investigate a trend in catchability with time, very common in indices built from CPUE data. In the example given here we’ll use a linear trend in time, set up by a simple linear model (Figure <a href="fitting.html#fig:qtrend">8.13</a>).</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="fitting.html#cb42-1" tabindex="-1"></a>qmod <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="sc">~</span> <span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>) <span class="sc">+</span> year)</span>
<span id="cb42-2"><a href="fitting.html#cb42-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">qmodel=</span>qmod)</span>
<span id="cb42-3"><a href="fitting.html#cb42-3" tabindex="-1"></a>qhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit)<span class="sc">$</span>qmodel[[<span class="dv">1</span>]]</span>
<span id="cb42-4"><a href="fitting.html#cb42-4" tabindex="-1"></a><span class="fu">wireframe</span>(qhat, <span class="at">zlab=</span><span class="st">&quot;q&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:qtrend"></span>
<img src="_main_files/figure-html/qtrend-1.png" alt="Catchability with a linear trend in year" width="672" />
<p class="caption">
Figure 8.13: Catchability with a linear trend in year
</p>
</div>
</div>
<div id="catchability-submodel-for-age-aggregated-biomass-indices" class="section level3 hasAnchor" number="8.2.2">
<h3><span class="header-section-number">8.2.2</span> Catchability submodel for age aggregated biomass indices<a href="fitting.html#catchability-submodel-for-age-aggregated-biomass-indices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The previous section was focused on age disaggregated indices, but age aggregated indices (CPUE, biomass, DEPM, etc) may also be used to tune the total biomass of the population. In these cases a different class for the index must be used, the <code>FLIndexBiomass</code>, which uses a vector <code>index</code> with the age dimension called ‘all’. Note that in this case the qmodel should be set without age factors, although it can have a ‘year’ component and covariates if needed. An interesting feature with biomass indices is the age range they refer to can be specified.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="fitting.html#cb43-1" tabindex="-1"></a><span class="co"># simulating a biomass index (note the name of the first dimension element) using</span></span>
<span id="cb43-2"><a href="fitting.html#cb43-2" tabindex="-1"></a><span class="co"># the ple4 biomass and an arbritary catchability of 0.001 plus a lognormal error.</span></span>
<span id="cb43-3"><a href="fitting.html#cb43-3" tabindex="-1"></a>dnms <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span><span class="st">&quot;all&quot;</span>, <span class="at">year=</span><span class="fu">range</span>(ple4)[<span class="st">&quot;minyear&quot;</span>]<span class="sc">:</span><span class="fu">range</span>(ple4)[<span class="st">&quot;maxyear&quot;</span>])</span>
<span id="cb43-4"><a href="fitting.html#cb43-4" tabindex="-1"></a>bioidx <span class="ot">&lt;-</span> <span class="fu">FLIndexBiomass</span>(<span class="fu">FLQuant</span>(<span class="cn">NA</span>, <span class="at">dimnames=</span>dnms))</span>
<span id="cb43-5"><a href="fitting.html#cb43-5" tabindex="-1"></a><span class="fu">index</span>(bioidx) <span class="ot">&lt;-</span> <span class="fu">stock</span>(ple4)<span class="sc">*</span><span class="fl">0.001</span></span>
<span id="cb43-6"><a href="fitting.html#cb43-6" tabindex="-1"></a><span class="fu">index</span>(bioidx) <span class="ot">&lt;-</span> <span class="fu">index</span>(bioidx)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="fu">index</span>(bioidx), <span class="at">sd=</span><span class="fl">0.1</span>))</span>
<span id="cb43-7"><a href="fitting.html#cb43-7" tabindex="-1"></a><span class="fu">range</span>(bioidx)[<span class="fu">c</span>(<span class="st">&quot;startf&quot;</span>,<span class="st">&quot;endf&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb43-8"><a href="fitting.html#cb43-8" tabindex="-1"></a><span class="co"># note the name of the first dimension element</span></span>
<span id="cb43-9"><a href="fitting.html#cb43-9" tabindex="-1"></a><span class="fu">index</span>(bioidx)</span></code></pre></div>
<pre><code>## An object of class &quot;FLQuant&quot;
## , , unit = unique, season = all, area = unique
## 
##      year
## age   1957 1958 1959 1960 1961 1962 1963 1964 1965 1966 1967 1968
##   all  372  382  408  528  521  539  517  681  545  587  565  587
##      year
## age   1969 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979 1980
##   all  479  514  428  429  391  511  394  522  514  497  534  448
##      year
## age   1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992
##   all  395  413  578  720  591  630  927  728  770  524  568  428
##      year
## age   1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004
##   all  365  329  346  308  412  338  399  304  315  342  402  385
##      year
## age   2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016
##   all  379  368  490  532  520  625  757  725  848 1004  929  843
##      year
## age   2017
##   all 1132
## 
## units:  t</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="fitting.html#cb45-1" tabindex="-1"></a><span class="co"># fitting the model</span></span>
<span id="cb45-2"><a href="fitting.html#cb45-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, <span class="fu">FLIndices</span>(bioidx), <span class="at">qmodel=</span><span class="fu">list</span>(<span class="sc">~</span><span class="dv">1</span>))</span></code></pre></div>
<p>To estimate a constant selectivity over time one used the model <span class="math inline">\(\sim 1\)</span>. As a matter of fact the estimate value, 0.00101, is not very far from the simulated one, 0.001.</p>
<p>An example where the biomass index refers only to age 2 to 4 (for example a CPUE that targets these particular ages).</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="fitting.html#cb46-1" tabindex="-1"></a><span class="co"># creating the index</span></span>
<span id="cb46-2"><a href="fitting.html#cb46-2" tabindex="-1"></a>dnms <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span><span class="st">&quot;all&quot;</span>, <span class="at">year=</span><span class="fu">range</span>(ple4)[<span class="st">&quot;minyear&quot;</span>]<span class="sc">:</span><span class="fu">range</span>(ple4)[<span class="st">&quot;maxyear&quot;</span>])</span>
<span id="cb46-3"><a href="fitting.html#cb46-3" tabindex="-1"></a>bioidx <span class="ot">&lt;-</span> <span class="fu">FLIndexBiomass</span>(<span class="fu">FLQuant</span>(<span class="cn">NA</span>, <span class="at">dimnames=</span>dnms))</span>
<span id="cb46-4"><a href="fitting.html#cb46-4" tabindex="-1"></a><span class="co"># but now use only ages 2:4</span></span>
<span id="cb46-5"><a href="fitting.html#cb46-5" tabindex="-1"></a><span class="fu">index</span>(bioidx) <span class="ot">&lt;-</span> <span class="fu">tsb</span>(ple4[<span class="fu">ac</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)])<span class="sc">*</span><span class="fl">0.001</span></span>
<span id="cb46-6"><a href="fitting.html#cb46-6" tabindex="-1"></a><span class="fu">index</span>(bioidx) <span class="ot">&lt;-</span> <span class="fu">index</span>(bioidx)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="fu">index</span>(bioidx), <span class="at">sd=</span><span class="fl">0.1</span>))</span>
<span id="cb46-7"><a href="fitting.html#cb46-7" tabindex="-1"></a><span class="fu">range</span>(bioidx)[<span class="fu">c</span>(<span class="st">&quot;startf&quot;</span>,<span class="st">&quot;endf&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb46-8"><a href="fitting.html#cb46-8" tabindex="-1"></a><span class="co"># to pass this information to the model one needs to specify an age range</span></span>
<span id="cb46-9"><a href="fitting.html#cb46-9" tabindex="-1"></a><span class="fu">range</span>(bioidx)[<span class="fu">c</span>(<span class="st">&quot;min&quot;</span>,<span class="st">&quot;max&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)</span>
<span id="cb46-10"><a href="fitting.html#cb46-10" tabindex="-1"></a><span class="co"># fitting the model</span></span>
<span id="cb46-11"><a href="fitting.html#cb46-11" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, <span class="fu">FLIndices</span>(bioidx), <span class="at">qmodel=</span><span class="fu">list</span>(<span class="sc">~</span><span class="dv">1</span>))</span></code></pre></div>
<p>Once more the estimate value, 9.9^{-4}, is not very far from the simulated one, 0.001.</p>
</div>
<div id="catchability-submodel-for-single-age-indices" class="section level3 hasAnchor" number="8.2.3">
<h3><span class="header-section-number">8.2.3</span> Catchability submodel for single age indices<a href="fitting.html#catchability-submodel-for-single-age-indices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Similar to age aggregated indices one may have an index that relates only to one age, like a recruitment index. In this case the `FLIndex} object must have in the first dimension the age it referes to. The fit is then done relating the index with the proper age in numbers. Note that in this case the qmodel should be set without age factors, although it can have a ‘year’ component and covariates if needed.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="fitting.html#cb47-1" tabindex="-1"></a>idx <span class="ot">&lt;-</span> ple4.indices[[<span class="dv">1</span>]][<span class="dv">1</span>]</span>
<span id="cb47-2"><a href="fitting.html#cb47-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, <span class="fu">FLIndices</span>(<span class="at">recidx=</span>idx), <span class="at">qmodel=</span><span class="fu">list</span>(<span class="sc">~</span><span class="dv">1</span>))</span>
<span id="cb47-3"><a href="fitting.html#cb47-3" tabindex="-1"></a><span class="co"># the estimated catchability is</span></span>
<span id="cb47-4"><a href="fitting.html#cb47-4" tabindex="-1"></a><span class="fu">predict</span>(fit)<span class="sc">$</span>qmodel[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## An object of class &quot;FLQuant&quot;
## , , unit = unique, season = all, area = unique
## 
##    year
## age 1985     1986     1987     1988     1989     1990    
##   1 0.000302 0.000302 0.000302 0.000302 0.000302 0.000302
##    year
## age 1991     1992     1993     1994     1995    
##   1 0.000302 0.000302 0.000302 0.000302 0.000302
## 
## units:</code></pre>
</div>
</div>
<div id="stock-recruitment-submodel-r_y" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Stock-recruitment submodel (<span class="math inline">\(R_y\)</span>)<a href="fitting.html#stock-recruitment-submodel-r_y" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The S/R submodel is a special case, in the sense that it can be set up with the same linear tools as the <span class="math inline">\(F\)</span> and <span class="math inline">\(Q\)</span> models, but it can also use some hard coded models. The example shows how to set up a simple dummy model with <code>factor()</code>, a smooth model with <code>s()</code>, a Ricker model (<code>ricker()</code>), a Beverton and Holt model (<code>bevholt()</code>), a hockey stick model (<code>hockey()</code>), and a geometric mean model (<code>geomean()</code>). See Figure <a href="fitting.html#fig:srmod">8.14</a> for results. As mentioned before, the ‘structural’ models have a fixed variance, which must be set by defining the coefficient of variation.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="fitting.html#cb49-1" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">factor</span>(year)</span>
<span id="cb49-2"><a href="fitting.html#cb49-2" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">srmodel=</span>srmod)</span>
<span id="cb49-3"><a href="fitting.html#cb49-3" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">s</span>(year, <span class="at">k=</span><span class="dv">10</span>)</span>
<span id="cb49-4"><a href="fitting.html#cb49-4" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">srmodel=</span>srmod)</span>
<span id="cb49-5"><a href="fitting.html#cb49-5" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">ricker</span>(<span class="at">CV=</span><span class="fl">0.3</span>)</span>
<span id="cb49-6"><a href="fitting.html#cb49-6" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">srmodel=</span>srmod)</span>
<span id="cb49-7"><a href="fitting.html#cb49-7" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">bevholt</span>(<span class="at">CV=</span><span class="fl">0.3</span>)</span>
<span id="cb49-8"><a href="fitting.html#cb49-8" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">srmodel=</span>srmod)</span>
<span id="cb49-9"><a href="fitting.html#cb49-9" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">hockey</span>(<span class="at">CV=</span><span class="fl">0.3</span>)</span>
<span id="cb49-10"><a href="fitting.html#cb49-10" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">srmodel=</span>srmod)</span>
<span id="cb49-11"><a href="fitting.html#cb49-11" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">geomean</span>(<span class="at">CV=</span><span class="fl">0.3</span>)</span>
<span id="cb49-12"><a href="fitting.html#cb49-12" tabindex="-1"></a>fit5 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">srmodel=</span>srmod)</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="fitting.html#cb50-1" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">factor=</span><span class="fu">stock.n</span>(fit)[<span class="dv">1</span>], <span class="at">smother=</span><span class="fu">stock.n</span>(fit1)[<span class="dv">1</span>], <span class="at">ricker=</span><span class="fu">stock.n</span>(fit2)[<span class="dv">1</span>], <span class="at">bevholt=</span><span class="fu">stock.n</span>(fit3)[<span class="dv">1</span>], <span class="at">hockey=</span><span class="fu">stock.n</span>(fit4)[<span class="dv">1</span>], <span class="at">geomean=</span><span class="fu">stock.n</span>(fit5)[<span class="dv">1</span>])</span>
<span id="cb50-2"><a href="fitting.html#cb50-2" tabindex="-1"></a><span class="fu">xyplot</span>(data<span class="sc">~</span>year, <span class="at">groups=</span>qname, <span class="at">data=</span>flqs, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">auto.key=</span><span class="fu">list</span>(<span class="at">points=</span><span class="cn">FALSE</span>, <span class="at">lines=</span><span class="cn">TRUE</span>, <span class="at">columns=</span><span class="dv">3</span>), <span class="at">ylab=</span><span class="st">&quot;No. recruits&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:srmod"></span>
<img src="_main_files/figure-html/srmod-1.png" alt="Stock-recruitment models fits" width="672" />
<p class="caption">
Figure 8.14: Stock-recruitment models fits
</p>
</div>
</div>
<div id="observation-variance-submodel-sigma2_ay-tau2_ays" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Observation variance submodel (<span class="math inline">\(\{\sigma^2_{ay}, \tau^2_{ays}\}\)</span>)<a href="fitting.html#observation-variance-submodel-sigma2_ay-tau2_ays" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The variance model allows the user to set up the shape of the observation variances <span class="math inline">\(\sigma^2_{ay}\)</span> and <span class="math inline">\(\tau^2_{ays}\)</span>. This is an important subject related with fisheries data used for input to stock assessment models.</p>
<p>The defaults assume a U-shape model for catch-at-age and constant variance for abundance indices. The first relies on the fact that it’s common to have more precision on the most represented ages and less precision on the less frequent ages which tend to be the younger and older individuals. These sizes are less caught by the fleets and as such do not appear as often at the auction markets samples. With regards to the abundance indices, one assumes a scientific survey to have a well designed sampling scheme and protocols which keep observation error at similar levels across ages.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="fitting.html#cb51-1" tabindex="-1"></a>vmod <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">3</span>), <span class="sc">~</span><span class="dv">1</span>)</span>
<span id="cb51-2"><a href="fitting.html#cb51-2" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">vmodel=</span>vmod)</span>
<span id="cb51-3"><a href="fitting.html#cb51-3" tabindex="-1"></a>vmod <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">3</span>), <span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">3</span>))</span>
<span id="cb51-4"><a href="fitting.html#cb51-4" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">vmodel=</span>vmod)</span></code></pre></div>
<p>Variance estimated for the constant model is 0.476 while for the U-shape model, fitted with a smoother, changes with ages (Figure <a href="fitting.html#fig:vmod">8.15</a>).</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="fitting.html#cb52-1" tabindex="-1"></a><span class="fu">wireframe</span>(<span class="fu">predict</span>(fit2)<span class="sc">$</span>vmodel[[<span class="dv">2</span>]], <span class="at">zlab=</span><span class="st">&quot;variance&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:vmod"></span>
<img src="_main_files/figure-html/vmod-1.png" alt="Abundance index observation variance estimate" width="672" />
<p class="caption">
Figure 8.15: Abundance index observation variance estimate
</p>
</div>
<p>Observation variance options have an impact in the final estimates of population abundance, which can be seen in Figure <a href="fitting.html#fig:vmodimpact">8.16</a>.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="fitting.html#cb53-1" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">smother=</span><span class="fu">stock.n</span>(fit1), <span class="at">factor=</span><span class="fu">stock.n</span>(fit2))</span>
<span id="cb53-2"><a href="fitting.html#cb53-2" tabindex="-1"></a><span class="fu">xyplot</span>(data<span class="sc">~</span>year<span class="sc">|</span>age, <span class="at">groups=</span>qname, <span class="at">data=</span>flqs, <span class="at">type=</span><span class="st">&quot;l&quot;</span>,</span>
<span id="cb53-3"><a href="fitting.html#cb53-3" tabindex="-1"></a>       <span class="at">scales=</span><span class="fu">list</span>(<span class="at">y=</span><span class="fu">list</span>(<span class="at">relation=</span><span class="st">&quot;free&quot;</span>, <span class="at">draw=</span><span class="cn">FALSE</span>)),</span>
<span id="cb53-4"><a href="fitting.html#cb53-4" tabindex="-1"></a>       <span class="at">auto.key=</span><span class="fu">list</span>(<span class="at">points=</span><span class="cn">FALSE</span>, <span class="at">lines=</span><span class="cn">TRUE</span>, <span class="at">columns=</span><span class="dv">2</span>),</span>
<span id="cb53-5"><a href="fitting.html#cb53-5" tabindex="-1"></a>       <span class="at">par.settings=</span><span class="fu">list</span>(<span class="at">superpose.line=</span><span class="fu">list</span>(<span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;gray35&quot;</span>, <span class="st">&quot;black&quot;</span>)),</span>
<span id="cb53-6"><a href="fitting.html#cb53-6" tabindex="-1"></a>       <span class="at">strip.background=</span><span class="fu">list</span>(<span class="at">col=</span><span class="st">&quot;gray90&quot;</span>)), <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:vmodimpact"></span>
<img src="_main_files/figure-html/vmodimpact-1.png" alt="Population estimates using two different variance models" width="672" />
<p class="caption">
Figure 8.16: Population estimates using two different variance models
</p>
</div>
</div>
<div id="initial-year-abundance-submodel-n_ay1" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Initial year abundance submodel (<span class="math inline">\(N_{a,y=1}\)</span>)<a href="fitting.html#initial-year-abundance-submodel-n_ay1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The submodel for the stock number at age in the first year of the time series is set up with the usual modelling tools (Figure <a href="fitting.html#fig:ny1">8.17</a>). Beare in mind that the year effect does not make sense here since it refers to a single year, the first in the time series of data available. This model has its influence limited to the initial lower triangle of the population matrix, which in assessments with long time series doesn’t make much difference. Nevertheless, when modelling stocks with short time series in relation to the number of ages present, it becomes more important and should be given proper attention.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="fitting.html#cb54-1" tabindex="-1"></a>n1mod <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">3</span>)</span>
<span id="cb54-2"><a href="fitting.html#cb54-2" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmod0, <span class="at">qmodel=</span>qmod0, <span class="at">srmodel=</span>srmod0, <span class="at">vmodel=</span>vmod0, <span class="at">n1model=</span>n1mod)</span>
<span id="cb54-3"><a href="fitting.html#cb54-3" tabindex="-1"></a>n1mod <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">factor</span>(age)</span>
<span id="cb54-4"><a href="fitting.html#cb54-4" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">fmodel=</span>fmod0, <span class="at">qmodel=</span>qmod0, <span class="at">srmodel=</span>srmod0, <span class="at">vmodel=</span>vmod0, <span class="at">n1model=</span>n1mod)</span>
<span id="cb54-5"><a href="fitting.html#cb54-5" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">smother=</span><span class="fu">stock.n</span>(fit1)[,<span class="dv">1</span>], <span class="at">factor=</span><span class="fu">stock.n</span>(fit2)[,<span class="dv">1</span>])</span></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="fitting.html#cb55-1" tabindex="-1"></a>pset <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">superpose.line=</span><span class="fu">list</span>(<span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;gray50&quot;</span>, <span class="st">&quot;black&quot;</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span>
<span id="cb55-2"><a href="fitting.html#cb55-2" tabindex="-1"></a><span class="fu">xyplot</span>(data<span class="sc">~</span>age, <span class="at">groups=</span>qname, <span class="at">data=</span>flqs, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">auto.key=</span>lgnd, <span class="at">par.settings=</span>pset, <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:ny1"></span>
<img src="_main_files/figure-html/ny1-1.png" alt="Nay=1 models" width="672" />
<p class="caption">
Figure 8.17: Nay=1 models
</p>
</div>
<p>The impact in the overall perspective of the stock status is depicted in Figure <a href="fitting.html#fig:n1modimpact">8.18</a>. As time goes by the effect of this model vanishes and the fits become similar.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="fitting.html#cb56-1" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">smother=</span><span class="fu">stock.n</span>(fit1), <span class="at">factor=</span><span class="fu">stock.n</span>(fit2))</span>
<span id="cb56-2"><a href="fitting.html#cb56-2" tabindex="-1"></a>pset<span class="sc">$</span>strip.background <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">col=</span><span class="st">&quot;gray90&quot;</span>)</span>
<span id="cb56-3"><a href="fitting.html#cb56-3" tabindex="-1"></a>scl <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y=</span><span class="fu">list</span>(<span class="at">relation=</span><span class="st">&quot;free&quot;</span>, <span class="at">draw=</span><span class="cn">FALSE</span>))</span>
<span id="cb56-4"><a href="fitting.html#cb56-4" tabindex="-1"></a><span class="fu">xyplot</span>(data<span class="sc">~</span>year<span class="sc">|</span><span class="fu">factor</span>(age), <span class="at">groups=</span>qname, <span class="at">data=</span>flqs, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">scales=</span>scl, <span class="at">auto.key=</span>lgnd, <span class="at">par.settings=</span>pset, <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:n1modimpact"></span>
<img src="_main_files/figure-html/n1modimpact-1.png" alt="Population estimates using two different variance models" width="672" />
<p class="caption">
Figure 8.18: Population estimates using two different variance models
</p>
</div>
</div>
<div id="data-weigthing" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Data weigthing<a href="fitting.html#data-weigthing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>%====================================================================
% COLIN TO CHECK THE SECTION
%====================================================================</p>
<p>By default the likelihood components are not weighted and the contribution of each to the maximum likelihood depends on their own likelihood score. However, the user may change these weights by penalizing data points, the <span class="math inline">\(w_{ays}\)</span> in section <a href="#sec:maths"><strong>??</strong></a>. The likelihood score of each data point will be multiplied by the normalized weights (<span class="math inline">\(\sum w_{ays} = 1\)</span>). This is done by adding a variance matrix to the <code>catch.n</code> and <code>index.n</code> slots of the stock and index objects. The values should be given as coefficients of variation on the log scale, so that variance is <span class="math inline">\(\log{({CV}^2 + 1)}\)</span>. Figures <a href="fitting.html#fig:likwgt">8.19</a> and <a href="fitting.html#fig:likwgtimpact">8.20</a> show the results of the two fits in the population abundance and stock summary.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="fitting.html#cb57-1" tabindex="-1"></a>stk <span class="ot">&lt;-</span> ple4</span>
<span id="cb57-2"><a href="fitting.html#cb57-2" tabindex="-1"></a>idx <span class="ot">&lt;-</span> ple4.indices[<span class="dv">1</span>]</span>
<span id="cb57-3"><a href="fitting.html#cb57-3" tabindex="-1"></a><span class="co"># cv of observed catches</span></span>
<span id="cb57-4"><a href="fitting.html#cb57-4" tabindex="-1"></a>varslt <span class="ot">&lt;-</span> <span class="fu">catch.n</span>(stk)</span>
<span id="cb57-5"><a href="fitting.html#cb57-5" tabindex="-1"></a>varslt[] <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb57-6"><a href="fitting.html#cb57-6" tabindex="-1"></a><span class="fu">catch.n</span>(stk) <span class="ot">&lt;-</span> <span class="fu">FLQuantDistr</span>(<span class="fu">catch.n</span>(stk), varslt)</span>
<span id="cb57-7"><a href="fitting.html#cb57-7" tabindex="-1"></a><span class="co"># cv of observed indices</span></span>
<span id="cb57-8"><a href="fitting.html#cb57-8" tabindex="-1"></a>varslt <span class="ot">&lt;-</span> <span class="fu">index</span>(idx[[<span class="dv">1</span>]])</span>
<span id="cb57-9"><a href="fitting.html#cb57-9" tabindex="-1"></a>varslt[] <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb57-10"><a href="fitting.html#cb57-10" tabindex="-1"></a><span class="fu">index.var</span>(idx[[<span class="dv">1</span>]]) <span class="ot">&lt;-</span> varslt</span>
<span id="cb57-11"><a href="fitting.html#cb57-11" tabindex="-1"></a><span class="co"># run</span></span>
<span id="cb57-12"><a href="fitting.html#cb57-12" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel=</span>fmod0, <span class="at">qmodel=</span>qmod0, <span class="at">srmodel=</span>srmod0, <span class="at">vmodel=</span>vmod0, <span class="at">n1model=</span>n1mod0)</span></code></pre></div>
<pre><code>## Note: Provided variances will be used to weight observations.
##  Weighting assumes variances are on the log scale or equivalently log(CV^2 + 1).</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="fitting.html#cb59-1" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">nowgt=</span><span class="fu">stock.n</span>(fit0), <span class="at">extwgt=</span><span class="fu">stock.n</span>(fit1))</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="fitting.html#cb60-1" tabindex="-1"></a><span class="fu">xyplot</span>(data<span class="sc">~</span>year<span class="sc">|</span><span class="fu">factor</span>(age), <span class="at">groups=</span>qname, <span class="at">data=</span>flqs, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">scales=</span>scl, <span class="at">auto.key=</span>lgnd, <span class="at">par.settings=</span>pset, <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:likwgt"></span>
<img src="_main_files/figure-html/likwgt-1.png" alt="Stock summary of distinct likelihood weightings" width="672" />
<p class="caption">
Figure 8.19: Stock summary of distinct likelihood weightings
</p>
</div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="fitting.html#cb61-1" tabindex="-1"></a>flsts <span class="ot">&lt;-</span> <span class="fu">FLStocks</span>(<span class="at">nowgt=</span>ple4<span class="sc">+</span>fit0, <span class="at">wgt=</span>ple4 <span class="sc">+</span> fit1)</span>
<span id="cb61-2"><a href="fitting.html#cb61-2" tabindex="-1"></a><span class="fu">plot</span>(flsts)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:likwgtimpact"></span>
<img src="_main_files/figure-html/likwgtimpact-1.png" alt="Population estimates using two different variance models" width="672" />
<p class="caption">
Figure 8.20: Population estimates using two different variance models
</p>
</div>
<p>Note that by using a smaller CV for the index, one is increasing the contribution of the survey and penalizing catch at age, in relative terms. The ratio between likelihood scores of both fits show this effect with catch at age increasing by 2.3 while the index increases almost 8 fold.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="fitting.html#cb62-1" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">fmodel=</span>fmod0, <span class="at">qmodel=</span>qmod0, <span class="at">srmodel=</span>srmod0, <span class="at">vmodel=</span>vmod0, <span class="at">n1model=</span>n1mod0)</span>
<span id="cb62-2"><a href="fitting.html#cb62-2" tabindex="-1"></a>(<span class="fu">fitSumm</span>(fit1)<span class="sc">/</span><span class="fu">fitSumm</span>(fit0))[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">8</span>,<span class="dv">9</span>),]</span></code></pre></div>
<pre><code>##       nlogl nlogl_comp1 nlogl_comp2 
##    5.158773    2.577961    9.762901</code></pre>
</div>
<div id="working-with-covariates" class="section level2 hasAnchor" number="8.7">
<h2><span class="header-section-number">8.7</span> Working with covariates<a href="fitting.html#working-with-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In linear model one can use covariates to explain part of the variance observed on the data that the ‘core’ model does not explain. The same can be done in the <code>a4a</code> framework. The example below uses the North Atlantic Oscillation (NAO) index to model recruitment.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="fitting.html#cb64-1" tabindex="-1"></a>nao <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;https://www.cpc.ncep.noaa.gov/products/precip/CWlink/pna/norm.nao.monthly.b5001.current.ascii.table&quot;</span>, <span class="at">skip=</span><span class="dv">1</span>, <span class="at">fill=</span><span class="cn">TRUE</span>, <span class="at">na.strings=</span><span class="st">&quot;-99.90&quot;</span>)</span>
<span id="cb64-2"><a href="fitting.html#cb64-2" tabindex="-1"></a>dnms <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">quant=</span><span class="st">&quot;nao&quot;</span>, <span class="at">year=</span><span class="dv">1950</span><span class="sc">:</span><span class="dv">2024</span>, <span class="at">unit=</span><span class="st">&quot;unique&quot;</span>, <span class="at">season=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">area=</span><span class="st">&quot;unique&quot;</span>)</span>
<span id="cb64-3"><a href="fitting.html#cb64-3" tabindex="-1"></a>nao <span class="ot">&lt;-</span> <span class="fu">FLQuant</span>(<span class="fu">unlist</span>(nao[,<span class="sc">-</span><span class="dv">1</span>]), <span class="at">dimnames=</span>dnms, <span class="at">units=</span><span class="st">&quot;nao&quot;</span>)</span>
<span id="cb64-4"><a href="fitting.html#cb64-4" tabindex="-1"></a>nao <span class="ot">&lt;-</span> <span class="fu">seasonMeans</span>(<span class="fu">trim</span>(nao, <span class="at">year=</span><span class="fu">dimnames</span>(<span class="fu">stock.n</span>(ple4))<span class="sc">$</span>year))</span></code></pre></div>
<p>First by simply assuming that the NAO index drives recruitment (Figure <a href="fitting.html#fig:naor">8.21</a>).</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="fitting.html#cb65-1" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> nao</span>
<span id="cb65-2"><a href="fitting.html#cb65-2" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">qmodel=</span><span class="fu">list</span>(<span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>)), <span class="at">srmodel=</span>srmod, <span class="at">covar=</span><span class="fu">FLQuants</span>(<span class="at">nao=</span>nao))</span>
<span id="cb65-3"><a href="fitting.html#cb65-3" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">simple=</span><span class="fu">stock.n</span>(fit)[<span class="dv">1</span>], <span class="at">covar=</span><span class="fu">stock.n</span>(fit2)[<span class="dv">1</span>])</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:naor"></span>
<img src="_main_files/figure-html/naor-1.png" alt="Recruitment model with covariates. Using the NAO index as a recruitment index." width="672" />
<p class="caption">
Figure 8.21: Recruitment model with covariates. Using the NAO index as a recruitment index.
</p>
</div>
<p>In a second model we’re using the NAO index not to model recruitment directly but to model one of the parameters of the S/R function (Figure <a href="fitting.html#fig:naor2">8.22</a>).</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="fitting.html#cb66-1" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="er">~</span> <span class="fu">ricker</span>(<span class="at">a=</span><span class="sc">~</span>nao, <span class="at">CV=</span><span class="fl">0.25</span>)</span>
<span id="cb66-2"><a href="fitting.html#cb66-2" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices[<span class="dv">1</span>], <span class="at">qmodel=</span><span class="fu">list</span>(<span class="sc">~</span><span class="fu">s</span>(age, <span class="at">k=</span><span class="dv">4</span>)), <span class="at">srmodel=</span>srmod, <span class="at">covar=</span><span class="fu">FLQuants</span>(<span class="at">nao=</span>nao))</span>
<span id="cb66-3"><a href="fitting.html#cb66-3" tabindex="-1"></a>flqs <span class="ot">&lt;-</span> <span class="fu">FLQuants</span>(<span class="at">simple=</span><span class="fu">stock.n</span>(fit)[<span class="dv">1</span>], <span class="at">covar=</span><span class="fu">stock.n</span>(fit3)[<span class="dv">1</span>])</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:naor2"></span>
<img src="_main_files/figure-html/naor2-1.png" alt="Recruitment model with covariates. Using the NAO index as a covariate for the stock-recruitment model parameters." width="672" />
<p class="caption">
Figure 8.22: Recruitment model with covariates. Using the NAO index as a covariate for the stock-recruitment model parameters.
</p>
</div>
<p>Note that covariates can be added to any submodel using the linear model capabilities of R.</p>
</div>
<div id="assessing-files" class="section level2 hasAnchor" number="8.8">
<h2><span class="header-section-number">8.8</span> Assessing files<a href="fitting.html#assessing-files" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The framework gives access to the files produced to run the <code>ADMB</code> fitting routine through the argument <code>wkdir</code>. When set up all the <code>ADMB</code> files will be left in the directory. Note that the <code>ADMB</code> tpl file is distributed with the <code>FLa4a</code>. One can get it from your <code>R</code> library, under the folder <code>myRlib/FLa4a/admb/</code>.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="fitting.html#cb67-1" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices, <span class="at">wkdir=</span><span class="st">&quot;fit1run&quot;</span>)</span></code></pre></div>
</div>
<div id="missing-observations-in-the-catch-matrix-or-index" class="section level2 hasAnchor" number="8.9">
<h2><span class="header-section-number">8.9</span> Missing observations in the catch matrix or index<a href="fitting.html#missing-observations-in-the-catch-matrix-or-index" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Missing observations are encoded as <code>NA</code>, and usually occur if there was no sampling for a year, or, since we model observations on the log scale, if the observation was zero. The <code>a4a</code> framework can deal with missing observations in the catches and indices.</p>
<p>The example below shows how to set up a model with missing observations in the catch matrix, to demonstrate the effect of missing observations, using the default model settings.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="fitting.html#cb68-1" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4, ple4.indices)</span>
<span id="cb68-2"><a href="fitting.html#cb68-2" tabindex="-1"></a></span>
<span id="cb68-3"><a href="fitting.html#cb68-3" tabindex="-1"></a>ple4_missing <span class="ot">&lt;-</span> ple4</span>
<span id="cb68-4"><a href="fitting.html#cb68-4" tabindex="-1"></a><span class="fu">catch.n</span>(ple4_missing)[<span class="fu">ac</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>), <span class="st">&quot;2013&quot;</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb68-5"><a href="fitting.html#cb68-5" tabindex="-1"></a></span>
<span id="cb68-6"><a href="fitting.html#cb68-6" tabindex="-1"></a>fit_missing <span class="ot">&lt;-</span> <span class="fu">sca</span>(ple4_missing, ple4.indices)</span></code></pre></div>
<p>In effect the information on F and Q for the missing observations is taken from the structural assumptions in the model. If a seperable F model is used, the F at age comes from the relationship between F at the other ages in that year, and the level of F from the relationship across years for the ages which have data. The same is true for the Q model. The effect of missing observations can be seen in the figures below, where box plots of the predicted catch at age with estimation error is shown.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>This is a simple example, but the same principle applies to more complex models. However, if there are many missing observations, the model cannot be too flexible, otherwise the model will not be able to estimate the missing observations.</p>
<p>Another point to note, is that if observations are systematically missing, for example due to the actual observation being below a detection limit, or zero, then the model may overestimate the true catch at age. This is a common problem in stock assessment models, and is not unique to the <code>a4a</code> framework. Proposed solutions to this issue are to replace zeros with a small number, or half of the smallest observed value.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="submodel-structure.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="diagnostics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/USERNAME/REPO/edit/BRANCH/07-fitting.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf", "_main.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
