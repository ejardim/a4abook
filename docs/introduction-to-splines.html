<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Introduction to Splines | Fish stock assessment with R</title>
  <meta name="description" content="How to do stock assessment in R using the a4a framework" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Introduction to Splines | Fish stock assessment with R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="How to do stock assessment in R using the a4a framework" />
  <meta name="github-repo" content="ejardim/a4abook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Introduction to Splines | Fish stock assessment with R" />
  
  <meta name="twitter:description" content="How to do stock assessment in R using the a4a framework" />
  

<meta name="author" content="John Doe and friends" />


<meta name="date" content="2024-12-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Stock assessment framework</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Before starting</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#license-documentation-and-development-status"><i class="fa fa-check"></i><b>1.1</b> License, documentation and development status</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installing-and-loading-libraries"><i class="fa fa-check"></i><b>1.2</b> Installing and loading libraries</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#how-to-read-this-document"><i class="fa fa-check"></i><b>1.3</b> How to read this document</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#how-to-get-help"><i class="fa fa-check"></i><b>1.4</b> How to get help</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#notation"><i class="fa fa-check"></i><b>1.5</b> Notation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html"><i class="fa fa-check"></i><b>3</b> Introduction to Splines</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#understanding-spline-basics"><i class="fa fa-check"></i><b>3.1</b> Understanding Spline Basics</a></li>
<li class="chapter" data-level="3.2" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#generate-some-artificial-data"><i class="fa fa-check"></i><b>3.2</b> Generate some artificial data</a></li>
<li class="chapter" data-level="3.3" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#cubic-regression-splines"><i class="fa fa-check"></i><b>3.3</b> Cubic Regression Splines</a></li>
<li class="chapter" data-level="3.4" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#thin-plate-spline"><i class="fa fa-check"></i><b>3.4</b> Thin plate spline</a></li>
<li class="chapter" data-level="3.5" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#comparison"><i class="fa fa-check"></i><b>3.5</b> Comparison</a></li>
<li class="chapter" data-level="3.6" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#the-mgcv-package-inside-a4a"><i class="fa fa-check"></i><b>3.6</b> The <code>mgcv</code> package inside <code>a4a</code></a></li>
<li class="chapter" data-level="3.7" data-path="introduction-to-splines.html"><a href="introduction-to-splines.html#on-the-number-of-knots-k"><i class="fa fa-check"></i><b>3.7</b> On the number of knots <span class="math inline">\(k\)</span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><i class="fa fa-check"></i><b>4</b> Modelling Individual Growth and Using Stochastic Slicing to Convert Length-based Data Into Age-based Data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#background"><i class="fa fa-check"></i><b>4.1</b> Background</a></li>
<li class="chapter" data-level="4.2" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#a4agr---the-growth-class"><i class="fa fa-check"></i><b>4.2</b> a4aGr - The growth class</a></li>
<li class="chapter" data-level="4.3" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#adding-uncertainty-to-growth-parameters-with-a-multivariate-normal-distribution"><i class="fa fa-check"></i><b>4.3</b> Adding uncertainty to growth parameters with a multivariate normal distribution}</a></li>
<li class="chapter" data-level="4.4" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#adding-uncertainty-to-growth-parameters-with-a-multivariate-triangle-distribution"><i class="fa fa-check"></i><b>4.4</b> Adding uncertainty to growth parameters with a multivariate triangle distribution}</a></li>
<li class="chapter" data-level="4.5" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#adding-uncertainty-to-growth-parameters-with-statistical-copulas"><i class="fa fa-check"></i><b>4.5</b> Adding uncertainty to growth parameters with statistical copulas}</a></li>
<li class="chapter" data-level="4.6" data-path="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html"><a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html#converting-from-length-to-age-based-data---the-l2a-method"><i class="fa fa-check"></i><b>4.6</b> Converting from length to age based data - the <code>l2a()</code> method}</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="natural-mortality-modelling.html"><a href="natural-mortality-modelling.html"><i class="fa fa-check"></i><b>5</b> Natural Mortality Modelling</a>
<ul>
<li class="chapter" data-level="5.1" data-path="natural-mortality-modelling.html"><a href="natural-mortality-modelling.html#background-1"><i class="fa fa-check"></i><b>5.1</b> Background</a></li>
<li class="chapter" data-level="5.2" data-path="natural-mortality-modelling.html"><a href="natural-mortality-modelling.html#a4am---the-m-class"><i class="fa fa-check"></i><b>5.2</b> <code>a4aM</code> - The M class</a></li>
<li class="chapter" data-level="5.3" data-path="natural-mortality-modelling.html"><a href="natural-mortality-modelling.html#adding-uncertainty-to-natural-mortality-parameters-with-a-multivariate-normal-distribution"><i class="fa fa-check"></i><b>5.3</b> Adding uncertainty to natural mortality parameters with a multivariate normal distribution</a></li>
<li class="chapter" data-level="5.4" data-path="natural-mortality-modelling.html"><a href="natural-mortality-modelling.html#adding-uncertainty-to-natural-mortality-parameters-with-statistical-copulas"><i class="fa fa-check"></i><b>5.4</b> Adding uncertainty to natural mortality parameters with statistical copulas</a></li>
<li class="chapter" data-level="5.5" data-path="natural-mortality-modelling.html"><a href="natural-mortality-modelling.html#computing-natural-mortality-time-series---the-m-method"><i class="fa fa-check"></i><b>5.5</b> Computing natural mortality time series - the “m” method</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html"><i class="fa fa-check"></i><b>6</b> Stock assessment framework</a>
<ul>
<li class="chapter" data-level="6.1" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#maths-description"><i class="fa fa-check"></i><b>6.1</b> Maths description </a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#observations"><i class="fa fa-check"></i><b>6.1.1</b> Observations</a></li>
<li class="chapter" data-level="6.1.2" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#the-population-dynamics-model"><i class="fa fa-check"></i><b>6.1.2</b> The population dynamics model</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="stock-assessment-framework.html"><a href="stock-assessment-framework.html#classes-description"><i class="fa fa-check"></i><b>6.2</b> Classes description </a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="submodel-structure.html"><a href="submodel-structure.html"><i class="fa fa-check"></i><b>7</b> Submodel structure </a>
<ul>
<li class="chapter" data-level="7.1" data-path="submodel-structure.html"><a href="submodel-structure.html#submodel-building-blocks-and-fundamental-r-formulas"><i class="fa fa-check"></i><b>7.1</b> Submodel building blocks and fundamental <code>R</code> formulas</a></li>
<li class="chapter" data-level="7.2" data-path="submodel-structure.html"><a href="submodel-structure.html#the-major-effects-available-for-modelling"><i class="fa fa-check"></i><b>7.2</b> The major effects available for modelling</a></li>
<li class="chapter" data-level="7.3" data-path="submodel-structure.html"><a href="submodel-structure.html#the-submodel-class-and-methods"><i class="fa fa-check"></i><b>7.3</b> The submodel class and methods</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="fitting.html"><a href="fitting.html"><i class="fa fa-check"></i><b>8</b> Fitting</a>
<ul>
<li class="chapter" data-level="8.1" data-path="fitting.html"><a href="fitting.html#fishing-mortality-submodel-f_ay"><i class="fa fa-check"></i><b>8.1</b> Fishing mortality submodel (<span class="math inline">\(F_{ay}\)</span>)</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="fitting.html"><a href="fitting.html#separable-model"><i class="fa fa-check"></i><b>8.1.1</b> Separable model</a></li>
<li class="chapter" data-level="8.1.2" data-path="fitting.html"><a href="fitting.html#constant-selectivity-for-contiguous-ages-or-years"><i class="fa fa-check"></i><b>8.1.2</b> Constant selectivity for contiguous ages or years</a></li>
<li class="chapter" data-level="8.1.3" data-path="fitting.html"><a href="fitting.html#time-blocks-selectivity"><i class="fa fa-check"></i><b>8.1.3</b> Time blocks selectivity</a></li>
<li class="chapter" data-level="8.1.4" data-path="fitting.html"><a href="fitting.html#time-changing-selectivity"><i class="fa fa-check"></i><b>8.1.4</b> Time changing selectivity</a></li>
<li class="chapter" data-level="8.1.5" data-path="fitting.html"><a href="fitting.html#trawl-fleets"><i class="fa fa-check"></i><b>8.1.5</b> Trawl fleets}</a></li>
<li class="chapter" data-level="8.1.6" data-path="fitting.html"><a href="fitting.html#nets-and-liners-fleets"><i class="fa fa-check"></i><b>8.1.6</b> Nets and Liners fleets}</a></li>
<li class="chapter" data-level="8.1.7" data-path="fitting.html"><a href="fitting.html#multigear-fleets"><i class="fa fa-check"></i><b>8.1.7</b> Multigear fleets}</a></li>
<li class="chapter" data-level="8.1.8" data-path="fitting.html"><a href="fitting.html#trawl-surveys"><i class="fa fa-check"></i><b>8.1.8</b> Trawl surveys}</a></li>
<li class="chapter" data-level="8.1.9" data-path="fitting.html"><a href="fitting.html#closed-form-selection-pattern"><i class="fa fa-check"></i><b>8.1.9</b> Closed form selection pattern}</a></li>
<li class="chapter" data-level="8.1.10" data-path="fitting.html"><a href="fitting.html#more-models"><i class="fa fa-check"></i><b>8.1.10</b> More models</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="fitting.html"><a href="fitting.html#abundance-indices-catchability-submodel-q_ays"><i class="fa fa-check"></i><b>8.2</b> Abundance indices catchability submodel (<span class="math inline">\(Q_{ays}\)</span>)</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="fitting.html"><a href="fitting.html#catchability-submodel-for-age-based-indices"><i class="fa fa-check"></i><b>8.2.1</b> Catchability submodel for age based indices</a></li>
<li class="chapter" data-level="8.2.2" data-path="fitting.html"><a href="fitting.html#catchability-submodel-for-age-aggregated-biomass-indices"><i class="fa fa-check"></i><b>8.2.2</b> Catchability submodel for age aggregated biomass indices}</a></li>
<li class="chapter" data-level="8.2.3" data-path="fitting.html"><a href="fitting.html#catchability-submodel-for-single-age-indices"><i class="fa fa-check"></i><b>8.2.3</b> Catchability submodel for single age indices</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="fitting.html"><a href="fitting.html#stock-recruitment-submodel-r_y"><i class="fa fa-check"></i><b>8.3</b> Stock-recruitment submodel (<span class="math inline">\(R_y\)</span>)}</a></li>
<li class="chapter" data-level="8.4" data-path="fitting.html"><a href="fitting.html#observation-variance-submodel-sigma2_ay-tau2_ays"><i class="fa fa-check"></i><b>8.4</b> Observation variance submodel (<span class="math inline">\(\{\sigma^2_{ay}, \tau^2_{ays}\}\)</span>)</a></li>
<li class="chapter" data-level="8.5" data-path="fitting.html"><a href="fitting.html#initial-year-abundance-submodel-n_ay1"><i class="fa fa-check"></i><b>8.5</b> Initial year abundance submodel (<span class="math inline">\(N_{a,y=1}\)</span>)}</a></li>
<li class="chapter" data-level="8.6" data-path="fitting.html"><a href="fitting.html#data-weigthing"><i class="fa fa-check"></i><b>8.6</b> Data weigthing</a></li>
<li class="chapter" data-level="8.7" data-path="fitting.html"><a href="fitting.html#working-with-covariates"><i class="fa fa-check"></i><b>8.7</b> Working with covariates</a></li>
<li class="chapter" data-level="8.8" data-path="fitting.html"><a href="fitting.html#assessing-files"><i class="fa fa-check"></i><b>8.8</b> Assessing files</a></li>
<li class="chapter" data-level="8.9" data-path="fitting.html"><a href="fitting.html#missing-observations-in-the-catch-matrix-or-index"><i class="fa fa-check"></i><b>8.9</b> Missing observations in the catch matrix or index</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="diagnostics.html"><a href="diagnostics.html"><i class="fa fa-check"></i><b>9</b> Diagnostics </a>
<ul>
<li class="chapter" data-level="9.1" data-path="diagnostics.html"><a href="diagnostics.html#residuals"><i class="fa fa-check"></i><b>9.1</b> Residuals</a></li>
<li class="chapter" data-level="9.2" data-path="diagnostics.html"><a href="diagnostics.html#predictive-skill"><i class="fa fa-check"></i><b>9.2</b> Predictive skill</a></li>
<li class="chapter" data-level="9.3" data-path="diagnostics.html"><a href="diagnostics.html#aggreagted-catch-in-weight"><i class="fa fa-check"></i><b>9.3</b> Aggreagted catch in weight}</a></li>
<li class="chapter" data-level="9.4" data-path="diagnostics.html"><a href="diagnostics.html#fit-summary-information-and-cross-validation-metrics"><i class="fa fa-check"></i><b>9.4</b> Fit summary, information and cross-validation metrics</a></li>
<li class="chapter" data-level="9.5" data-path="diagnostics.html"><a href="diagnostics.html#the-package-a4adiags"><i class="fa fa-check"></i><b>9.5</b> The package a4adiags</a></li>
<li class="chapter" data-level="9.6" data-path="diagnostics.html"><a href="diagnostics.html#residuals-and-submodels-misspecifiction"><i class="fa fa-check"></i><b>9.6</b> Residuals and submodels misspecifiction</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="diagnostics.html"><a href="diagnostics.html#the-mean-model"><i class="fa fa-check"></i><b>9.6.1</b> The “mean” model</a></li>
<li class="chapter" data-level="9.6.2" data-path="diagnostics.html"><a href="diagnostics.html#the-age-effects"><i class="fa fa-check"></i><b>9.6.2</b> The age effects</a></li>
<li class="chapter" data-level="9.6.3" data-path="diagnostics.html"><a href="diagnostics.html#the-fishing-mortality-year-model"><i class="fa fa-check"></i><b>9.6.3</b> The fishing mortality year model</a></li>
<li class="chapter" data-level="9.6.4" data-path="diagnostics.html"><a href="diagnostics.html#the-initial-year-population-abundance-model-aka-n1"><i class="fa fa-check"></i><b>9.6.4</b> The initial year population abundance model, aka N1</a></li>
<li class="chapter" data-level="9.6.5" data-path="diagnostics.html"><a href="diagnostics.html#the-stock-recruitment-submodel"><i class="fa fa-check"></i><b>9.6.5</b> The stock recruitment submodel</a></li>
<li class="chapter" data-level="9.6.6" data-path="diagnostics.html"><a href="diagnostics.html#the-variance-submodel"><i class="fa fa-check"></i><b>9.6.6</b> The variance submodel</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html"><i class="fa fa-check"></i><b>10</b> Predict and simulate </a>
<ul>
<li class="chapter" data-level="10.1" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#basic-functions"><i class="fa fa-check"></i><b>10.1</b> Basic functions}</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#simulate"><i class="fa fa-check"></i><b>10.1.1</b> simulate()</a></li>
<li class="chapter" data-level="10.1.2" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#genflquant"><i class="fa fa-check"></i><b>10.1.2</b> genFLQuant()</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#submodels"><i class="fa fa-check"></i><b>10.2</b> submodels</a></li>
<li class="chapter" data-level="10.3" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#predict"><i class="fa fa-check"></i><b>10.3</b> Predict</a></li>
<li class="chapter" data-level="10.4" data-path="predict-and-simulate.html"><a href="predict-and-simulate.html#simulate-1"><i class="fa fa-check"></i><b>10.4</b> Simulate</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-mcmc.html"><i class="fa fa-check"></i><b>11</b> The statistical catch-at-age stock assessment framework with MCMC </a>
<ul>
<li class="chapter" data-level="11.1" data-path="the-statistical-catch-at-age-stock-assessment-framework-with-mcmc.html"><a href="the-statistical-catch-at-age-stock-assessment-framework-with-mcmc.html#diagnostics-with-coda"><i class="fa fa-check"></i><b>11.1</b> Diagnostics with CODA</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="propagate-natural-mortality-uncertainty.html"><a href="propagate-natural-mortality-uncertainty.html"><i class="fa fa-check"></i><b>12</b> Propagate natural mortality uncertainty</a></li>
<li class="chapter" data-level="13" data-path="modelling-spatial-effects.html"><a href="modelling-spatial-effects.html"><i class="fa fa-check"></i><b>13</b> Modelling spatial effects</a></li>
<li class="chapter" data-level="14" data-path="reference-points.html"><a href="reference-points.html"><i class="fa fa-check"></i><b>14</b> Reference Points</a>
<ul>
<li class="chapter" data-level="14.1" data-path="reference-points.html"><a href="reference-points.html#yield-per-recruit-reference-points"><i class="fa fa-check"></i><b>14.1</b> Yield per recruit reference points</a></li>
<li class="chapter" data-level="14.2" data-path="reference-points.html"><a href="reference-points.html#stock-recruitment-relationship-based-reference-points"><i class="fa fa-check"></i><b>14.2</b> Stock recruitment relationship based reference points</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="reference-points.html"><a href="reference-points.html#stock-recruitment-after-fitting-the-stock-assessment-model"><i class="fa fa-check"></i><b>14.2.1</b> Stock recruitment after fitting the stock assessment model</a></li>
<li class="chapter" data-level="14.2.2" data-path="reference-points.html"><a href="reference-points.html#stock-recruitment-during-fitting-the-stock-assessment-model"><i class="fa fa-check"></i><b>14.2.2</b> Stock recruitment during fitting the stock assessment model</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="reference-points.html"><a href="reference-points.html#economics-reference-points"><i class="fa fa-check"></i><b>14.3</b> Economics reference points</a></li>
<li class="chapter" data-level="14.4" data-path="reference-points.html"><a href="reference-points.html#computing-user-specific-reference-points"><i class="fa fa-check"></i><b>14.4</b> Computing user specific reference points</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html"><i class="fa fa-check"></i><b>15</b> Projections and harvest control rules</a>
<ul>
<li class="chapter" data-level="15.1" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#initial-condition-assumptions-check-fwdwindow"><i class="fa fa-check"></i><b>15.1</b> Initial condition assumptions [CHECK fwdWindow]</a></li>
<li class="chapter" data-level="15.2" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#scenarios"><i class="fa fa-check"></i><b>15.2</b> Scenarios</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#relative-scenarios"><i class="fa fa-check"></i><b>15.2.1</b> Relative scenarios</a></li>
<li class="chapter" data-level="15.2.2" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#limits"><i class="fa fa-check"></i><b>15.2.2</b> Limits</a></li>
<li class="chapter" data-level="15.2.3" data-path="projections-and-harvest-control-rules.html"><a href="projections-and-harvest-control-rules.html#complex-scenario"><i class="fa fa-check"></i><b>15.2.3</b> Complex scenario</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="sections-to-be-added.html"><a href="sections-to-be-added.html"><i class="fa fa-check"></i><b>16</b> Sections to be added!?</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fish stock assessment with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="introduction-to-splines" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Introduction to Splines<a href="introduction-to-splines.html#introduction-to-splines" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Splines are a powerful tool for modeling complex, non-linear relationships between variables in a flexible and interpretable way. They break a function into smooth, continuous polynomial segments, each called a <em>piece</em> or <em>basis function</em>, joined at specific points called <em>knots</em>. This piecewise approach allows us to capture the non-linearity in the data without overfitting.</p>
<p>The core concept of “basis functions” is that they transform the input variable (or vector) <span class="math inline">\(X\)</span> into a set of new variables, which are then used as inputs in the model. This allows the model to remain linear in these transformed variables, even though it can capture complex, non-linear relationships in the original variable.</p>
<div id="understanding-spline-basics" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Understanding Spline Basics<a href="introduction-to-splines.html#understanding-spline-basics" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The spline function is built by combining polynomial pieces, ensuring smoothness at the junctions, which are called knots. In regression, splines allow us to fit complex shapes by introducing non-linear trends while maintaining control over the smoothness.</p>
<p>A simplified version of how splines work would be as follows:</p>
<p>Let <span class="math inline">\(S\)</span> our spline function, that is defined in an interval <span class="math inline">\([a,b]\)</span>. We seek to construct <span class="math inline">\(S\)</span> by combining <span class="math inline">\(k-1\)</span> polynomials <span class="math inline">\(P\)</span>, where <span class="math inline">\(k\)</span> is the number of knots. Let also <span class="math inline">\(t_{i}, i = 0, ..., k-1\)</span> the positions of the knots in the interval <span class="math inline">\([a,b]\)</span>.</p>
<p><span class="math inline">\(S\)</span> is going to be defined as:</p>
<p><span class="math display">\[
S(t) = P_{0}(t), \quad t_{0} \leq t &lt; t_{1} \\
\vdots \\
S(t) = P_{k-1}(t), \quad t_{k-1} \leq t &lt; t_{k}
\]</span></p>
<p>The above definition is a simplified version of how splines work and can help as an intuitive approach. In reality splines need to satisfy some extra conditions like continuity on the points of junction, and of the first and second derivative. Depending on the basis functions the conditions may differ. The next part will demonstrate graphically how to approximate an unknown function through splines.</p>
</div>
<div id="generate-some-artificial-data" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Generate some artificial data<a href="introduction-to-splines.html#generate-some-artificial-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="introduction-to-splines.html#cb13-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb13-2"><a href="introduction-to-splines.html#cb13-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sin</span>(x) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">0</span>, <span class="fl">0.3</span>)</span>
<span id="cb13-3"><a href="introduction-to-splines.html#cb13-3" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, y)</span>
<span id="cb13-4"><a href="introduction-to-splines.html#cb13-4" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb13-5"><a href="introduction-to-splines.html#cb13-5" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-9"></span>
<img src="_main_files/figure-html/unnamed-chunk-9-1.png" alt="Data with Non-linear Trend" width="672" />
<p class="caption">
Figure 3.1: Data with Non-linear Trend
</p>
</div>
<p>We will use the package <code>mgcv</code> which is the one that is being used in <code>a4a</code>.</p>
</div>
<div id="cubic-regression-splines" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Cubic Regression Splines<a href="introduction-to-splines.html#cubic-regression-splines" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We fit a simple smoother on x with <span class="math inline">\(k = 5\)</span>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="introduction-to-splines.html#cb14-1" tabindex="-1"></a><span class="co"># Fit a natural cubic spline with ns()</span></span>
<span id="cb14-2"><a href="introduction-to-splines.html#cb14-2" tabindex="-1"></a>cr_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs =</span> <span class="st">&quot;cr&quot;</span>, <span class="at">k =</span> <span class="dv">5</span>), <span class="at">data =</span> data)</span>
<span id="cb14-3"><a href="introduction-to-splines.html#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="introduction-to-splines.html#cb14-4" tabindex="-1"></a><span class="co"># Predict and plot</span></span>
<span id="cb14-5"><a href="introduction-to-splines.html#cb14-5" tabindex="-1"></a>data<span class="sc">$</span>cr_fit <span class="ot">&lt;-</span> <span class="fu">predict</span>(cr_model)</span>
<span id="cb14-6"><a href="introduction-to-splines.html#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="introduction-to-splines.html#cb14-7" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb14-8"><a href="introduction-to-splines.html#cb14-8" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb14-9"><a href="introduction-to-splines.html#cb14-9" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cr_fit), <span class="at">color =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-10"></span>
<img src="_main_files/figure-html/unnamed-chunk-10-1.png" alt="Cubic regression spline fit" width="672" />
<p class="caption">
Figure 3.2: Cubic regression spline fit
</p>
</div>
<p>The natural cubic spline fit above is constrained at the boundaries, by putting two of the five knots there, resulting in a linear behavior at the ends of the data range. This approach is helpful for data that has an approximately linear trend at the boundaries but exhibits non-linearity in the center.</p>
<p>The knots in the cubic regression splines are placed by quantile through the variable space, so in the case where the data are evenly spread across the variable space the knots will be placed evenly.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-11"></span>
<img src="_main_files/figure-html/unnamed-chunk-11-1.png" alt="Cubic regression spline fit with knot positioning" width="672" />
<p class="caption">
Figure 3.3: Cubic regression spline fit with knot positioning
</p>
</div>
<p>The <code>gam</code> routine creates <span class="math inline">\(k-1\)</span> polynomials plus an intercept based on the knots:</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-12"></span>
<img src="_main_files/figure-html/unnamed-chunk-12-1.png" alt="basis functions for cubic regression splines" width="672" />
<p class="caption">
Figure 3.4: basis functions for cubic regression splines
</p>
</div>
<p>The polynomials transform the initial variable <span class="math inline">\(x\)</span> and create a <em>model</em> matrix <span class="math inline">\(X\)</span> with <span class="math inline">\(k\)</span> columns and <span class="math inline">\(n\)</span> rows, where <span class="math inline">\(n\)</span> is the number of data points. This new transformation is being then used to fit the model and estimate the <span class="math inline">\(\beta_{0}, ... ,\beta_{k-1}\)</span> coefficients. The fitted model results from <span class="math inline">\(X\beta\)</span></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="introduction-to-splines.html#cb15-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df_xm_basis_b, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">colour =</span> variable)) <span class="sc">+</span></span>
<span id="cb15-2"><a href="introduction-to-splines.html#cb15-2" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted), <span class="at">color =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb15-3"><a href="introduction-to-splines.html#cb15-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> obs), <span class="at">color =</span> <span class="st">&quot;darkgrey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>)<span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">&quot;y&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
</div>
<div id="thin-plate-spline" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Thin plate spline<a href="introduction-to-splines.html#thin-plate-spline" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Thin plate splines are particularly useful for smoothing in multiple dimensions. However, they also work well with univariate data, as they offer flexibility and control over smoothness they are the default choice of the <code>mgcv</code> package.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="introduction-to-splines.html#cb16-1" tabindex="-1"></a><span class="co"># Fit a thin plate spline with gam()</span></span>
<span id="cb16-2"><a href="introduction-to-splines.html#cb16-2" tabindex="-1"></a>tps_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">bs =</span> <span class="st">&quot;tp&quot;</span>), <span class="at">data =</span> data)</span>
<span id="cb16-3"><a href="introduction-to-splines.html#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="introduction-to-splines.html#cb16-4" tabindex="-1"></a><span class="co"># Predict and plot</span></span>
<span id="cb16-5"><a href="introduction-to-splines.html#cb16-5" tabindex="-1"></a>data<span class="sc">$</span>tps_fit <span class="ot">&lt;-</span> <span class="fu">predict</span>(tps_model)</span>
<span id="cb16-6"><a href="introduction-to-splines.html#cb16-6" tabindex="-1"></a></span>
<span id="cb16-7"><a href="introduction-to-splines.html#cb16-7" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb16-8"><a href="introduction-to-splines.html#cb16-8" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb16-9"><a href="introduction-to-splines.html#cb16-9" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tps_fit), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-14"></span>
<img src="_main_files/figure-html/unnamed-chunk-14-1.png" alt="Thin plate splines fit" width="672" />
<p class="caption">
Figure 3.5: Thin plate splines fit
</p>
</div>
<p>This spline automatically adjusts its flexibility across the data, with a smoothing penalty that controls the degree of bending. Thin plate splines are ideal when you need a smooth fit without predefined knots. The knots in thin plate splines are not positioned across the variable space, instead, by default, when no knot number is specified, there are as many knots as data points which essentially define the number of basis splines.</p>
<p>In the case where <span class="math inline">\(k\)</span> is specified the thin plate splines use the first <span class="math inline">\(k\)</span> “principal components” in a similar way as the PCA algorithm works.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-15"></span>
<img src="_main_files/figure-html/unnamed-chunk-15-1.png" alt="basis functions for thin plate splines" width="672" />
<p class="caption">
Figure 3.6: basis functions for thin plate splines
</p>
</div>
<p>As in the example before, the fitted model results from <span class="math inline">\(X\beta\)</span></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="introduction-to-splines.html#cb17-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df_xm_basis_b, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">colour =</span> variable)) <span class="sc">+</span></span>
<span id="cb17-2"><a href="introduction-to-splines.html#cb17-2" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted), <span class="at">color =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb17-3"><a href="introduction-to-splines.html#cb17-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> obs), <span class="at">color =</span> <span class="st">&quot;darkgrey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>)<span class="sc">+</span></span>
<span id="cb17-4"><a href="introduction-to-splines.html#cb17-4" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">&quot;y&quot;</span>)<span class="sc">+</span></span>
<span id="cb17-5"><a href="introduction-to-splines.html#cb17-5" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>,<span class="fl">1.5</span>))</span></code></pre></div>
<pre><code>## Warning: Removed 155 rows containing missing values or values outside the scale
## range (`geom_line()`).</code></pre>
<pre><code>## Warning: Removed 10 rows containing missing values or values outside the scale
## range (`geom_point()`).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
</div>
<div id="comparison" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Comparison<a href="introduction-to-splines.html#comparison" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Plotting together thin plate spline and cubic spline fits with the same number of knots.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="introduction-to-splines.html#cb20-1" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(x, y)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="introduction-to-splines.html#cb20-2" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb20-3"><a href="introduction-to-splines.html#cb20-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tps_fit), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-4"><a href="introduction-to-splines.html#cb20-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cr_fit), <span class="at">color =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb20-5"><a href="introduction-to-splines.html#cb20-5" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Spline Type&quot;</span>) <span class="sc">+</span></span>
<span id="cb20-6"><a href="introduction-to-splines.html#cb20-6" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;darkgreen&quot;</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-17"></span>
<img src="_main_files/figure-html/unnamed-chunk-17-1.png" alt="Thin plate splines and cubic regression splines fit" width="672" />
<p class="caption">
Figure 3.7: Thin plate splines and cubic regression splines fit
</p>
</div>
</div>
<div id="the-mgcv-package-inside-a4a" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> The <code>mgcv</code> package inside <code>a4a</code><a href="introduction-to-splines.html#the-mgcv-package-inside-a4a" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>mgcv</code> package provides various user input options to define the smoother functions used to construct the submodels.</p>
<p>Under the <code>a4a</code> framework, the <code>mgcv</code> package is used to construct the model matrices of the submodels, which are then passed to the <code>ADMB</code> where the model fitting takes place.</p>
<p>The default option for the basis functions of the splines is <code>bs = tp</code> (thin plate splines) and is considered the optimal option. The user can define other smoothing basis functions using the <code>bs</code> argument. The user can refer to the <code>smooth.terms</code> of the <code>mgcv</code> package for a full description. There are many equivalent basis functions for the splines, and some of them have little or no effect in the context of <code>a4a</code>, since they differ only in the penalty term, which is not used in <code>a4a</code>.</p>
<p>Examples for different smoothing terms:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="introduction-to-splines.html#cb21-1" tabindex="-1"></a>fmod00 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">bs =</span> <span class="st">&#39;tp&#39;</span>, <span class="at">k =</span> <span class="dv">10</span>) <span class="co"># thin plate splines</span></span>
<span id="cb21-2"><a href="introduction-to-splines.html#cb21-2" tabindex="-1"></a>fmod01 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">bs =</span> <span class="st">&#39;cr&#39;</span>, <span class="at">k =</span> <span class="dv">10</span>) <span class="co"># regression cubic splines</span></span>
<span id="cb21-3"><a href="introduction-to-splines.html#cb21-3" tabindex="-1"></a>fmod02 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">bs =</span> <span class="st">&#39;bs&#39;</span>, <span class="at">k =</span> <span class="dv">10</span>) <span class="co"># b-splines</span></span>
<span id="cb21-4"><a href="introduction-to-splines.html#cb21-4" tabindex="-1"></a>fmod03 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">bs =</span> <span class="st">&#39;ps&#39;</span>, <span class="at">k =</span> <span class="dv">10</span>) <span class="co"># p-splines</span></span>
<span id="cb21-5"><a href="introduction-to-splines.html#cb21-5" tabindex="-1"></a>fmod04 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">bs =</span> <span class="st">&#39;ad&#39;</span>, <span class="at">k =</span> <span class="dv">10</span>) <span class="co"># Adaptive smoothers</span></span>
<span id="cb21-6"><a href="introduction-to-splines.html#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="introduction-to-splines.html#cb21-7" tabindex="-1"></a>fit00 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod00)</span>
<span id="cb21-8"><a href="introduction-to-splines.html#cb21-8" tabindex="-1"></a>fit01 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod01)</span>
<span id="cb21-9"><a href="introduction-to-splines.html#cb21-9" tabindex="-1"></a>fit02 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod02)</span>
<span id="cb21-10"><a href="introduction-to-splines.html#cb21-10" tabindex="-1"></a>fit03 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod03)</span>
<span id="cb21-11"><a href="introduction-to-splines.html#cb21-11" tabindex="-1"></a>fit04 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod04)</span></code></pre></div>
<p>In this example we are using the thin plate regression splines, cubic splines, b-splines, p-splines and adaptive smoothers</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="introduction-to-splines.html#cb22-1" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">FLStocks</span>(<span class="at">ThinPlate =</span> stk <span class="sc">+</span> fit00,</span>
<span id="cb22-2"><a href="introduction-to-splines.html#cb22-2" tabindex="-1"></a>              <span class="at">CubicRegressionSplines =</span> stk <span class="sc">+</span> fit01,</span>
<span id="cb22-3"><a href="introduction-to-splines.html#cb22-3" tabindex="-1"></a>              <span class="at">B_splines =</span> stk <span class="sc">+</span> fit02,</span>
<span id="cb22-4"><a href="introduction-to-splines.html#cb22-4" tabindex="-1"></a>              <span class="at">P_splines =</span> stk <span class="sc">+</span> fit03,</span>
<span id="cb22-5"><a href="introduction-to-splines.html#cb22-5" tabindex="-1"></a>              <span class="at">Adaptive_smoothers =</span> stk <span class="sc">+</span> fit04</span>
<span id="cb22-6"><a href="introduction-to-splines.html#cb22-6" tabindex="-1"></a>              ))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&#39;bottom&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Functionality of <code>mgcv</code> package provides also the option to work with interactions. Although <code>s(age, year)</code> can be defined, it uses a common bivariate spline for the two variables which are very different in scale. It is preferable if interactions are assumed to use <code>te(age, year)</code>. Again is up to the user to define the basis functions for the smoothers.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="introduction-to-splines.html#cb23-1" tabindex="-1"></a>fmod03 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">te</span>(age, year, <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">10</span>))</span>
<span id="cb23-2"><a href="introduction-to-splines.html#cb23-2" tabindex="-1"></a>fmod04 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">te</span>(age, year, <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">10</span>), <span class="at">bs =</span> <span class="st">&#39;cr&#39;</span>)</span>
<span id="cb23-3"><a href="introduction-to-splines.html#cb23-3" tabindex="-1"></a>fmod05 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">te</span>(age, year, <span class="at">bs =</span> <span class="st">&#39;bs&#39;</span>)</span>
<span id="cb23-4"><a href="introduction-to-splines.html#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="introduction-to-splines.html#cb23-5" tabindex="-1"></a>fit03 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod03)</span>
<span id="cb23-6"><a href="introduction-to-splines.html#cb23-6" tabindex="-1"></a>fit04 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod04)</span>
<span id="cb23-7"><a href="introduction-to-splines.html#cb23-7" tabindex="-1"></a>fit05 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod05)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="introduction-to-splines.html#cb24-1" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">FLStocks</span>(<span class="at">TP_tensor =</span> stk <span class="sc">+</span> fit03,</span>
<span id="cb24-2"><a href="introduction-to-splines.html#cb24-2" tabindex="-1"></a>              <span class="at">CB_tensor =</span> stk <span class="sc">+</span> fit04,</span>
<span id="cb24-3"><a href="introduction-to-splines.html#cb24-3" tabindex="-1"></a>              <span class="at">BS_tensor =</span> stk <span class="sc">+</span> fit05))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&#39;bottom&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
</div>
<div id="on-the-number-of-knots-k" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> On the number of knots <span class="math inline">\(k\)</span><a href="introduction-to-splines.html#on-the-number-of-knots-k" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><span class="math inline">\(k\)</span> is the dimension of the basis used to represent the smooth term <span class="math inline">\(s\)</span>. The default depends on the number of variables that the smooth is a function of. In practice k-1 (or k) sets the upper limit on the degrees of freedom associated with an s smooth (1 degree of freedom is usually lost to the intercept of the smooth). For the smooths the upper limit of the degrees of freedom is given by the product of the k values provided for each marginal smooth less one, for the constraint. The choice of the k is not critical and in general it must be large enough to allow to have enough degrees of freedom capturing the underlying process and small enough to prevent overfitting. A strong pattern in the residuals can be a sign of low <span class="math inline">\(k\)</span>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="introduction-to-splines.html#cb25-1" tabindex="-1"></a>fmod00 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">5</span>) </span>
<span id="cb25-2"><a href="introduction-to-splines.html#cb25-2" tabindex="-1"></a>fmod01 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">10</span>) <span class="co"># cubic splines</span></span>
<span id="cb25-3"><a href="introduction-to-splines.html#cb25-3" tabindex="-1"></a>fmod02 <span class="ot">&lt;-</span> <span class="er">~</span><span class="fu">s</span>(age)<span class="sc">+</span><span class="fu">s</span>(year, <span class="at">k =</span> <span class="dv">20</span>) <span class="co"># b-splines</span></span>
<span id="cb25-4"><a href="introduction-to-splines.html#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="introduction-to-splines.html#cb25-5" tabindex="-1"></a>fit00 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod00)</span>
<span id="cb25-6"><a href="introduction-to-splines.html#cb25-6" tabindex="-1"></a>fit01 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod01)</span>
<span id="cb25-7"><a href="introduction-to-splines.html#cb25-7" tabindex="-1"></a>fit02 <span class="ot">&lt;-</span> <span class="fu">sca</span>(stk, idx, <span class="at">fmodel =</span> fmod02)</span>
<span id="cb25-8"><a href="introduction-to-splines.html#cb25-8" tabindex="-1"></a></span>
<span id="cb25-9"><a href="introduction-to-splines.html#cb25-9" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">FLStocks</span>(<span class="st">&#39;k=5&#39;</span> <span class="ot">=</span> stk <span class="sc">+</span> fit00,</span>
<span id="cb25-10"><a href="introduction-to-splines.html#cb25-10" tabindex="-1"></a>              <span class="st">&#39;k=10&#39;</span> <span class="ot">=</span> stk <span class="sc">+</span> fit01,</span>
<span id="cb25-11"><a href="introduction-to-splines.html#cb25-11" tabindex="-1"></a>              <span class="st">&#39;k=20&#39;</span> <span class="ot">=</span> stk <span class="sc">+</span> fit02))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&#39;bottom&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>We can check the result of choosing different <span class="math inline">\(k\)</span> values on BIC and GCV:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="introduction-to-splines.html#cb26-1" tabindex="-1"></a>fmodsk <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-2"><a href="introduction-to-splines.html#cb26-2" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb26-3"><a href="introduction-to-splines.html#cb26-3" tabindex="-1"></a>  fmodsk[[<span class="fu">paste0</span>(i)]] <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;~s(age)+s(year, k=&quot;</span>,i,<span class="st">&quot;)&quot;</span>))</span>
<span id="cb26-4"><a href="introduction-to-splines.html#cb26-4" tabindex="-1"></a>}</span>
<span id="cb26-5"><a href="introduction-to-splines.html#cb26-5" tabindex="-1"></a></span>
<span id="cb26-6"><a href="introduction-to-splines.html#cb26-6" tabindex="-1"></a>myFits <span class="ot">&lt;-</span> <span class="fu">scas</span>(<span class="fu">FLStocks</span>(stk), <span class="fu">list</span>(idx), <span class="at">fmodel =</span> fmodsk)</span>
<span id="cb26-7"><a href="introduction-to-splines.html#cb26-7" tabindex="-1"></a><span class="fu">plot</span>(myFits)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="modelling-individual-growth-and-using-stochastic-slicing-to-convert-length-based-data-into-age-based-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/02-splines.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
